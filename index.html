<!DOCTYPE html>
<html lang="zh-Hant"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRSpotter</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBErRYvF2got2vrwY0-a8KSc8JVWKdeksQ",
            authDomain: "lr-whereabout-report.firebaseapp.com",
            projectId: "lr-whereabout-report",
            storageBucket: "lr-whereabout-report.firebasestorage.app",
            messagingSenderId: "939888577145",
            appId: "1:939888577145:web:b4b51b3a2f3b8bd685e2a8",
            databaseURL: "https://lr-whereabout-report-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const liveRef = ref(db, 'live_reports');

        
// === Special Trains (from Firebase config/special_trains) ===
let specialTrains = {};
const specialIcons = {};
const iconDesc = {};

const specialTrainRef = ref(db, 'config/special_trains');

onValue(specialTrainRef, (snapshot) => {
    const data = snapshot.val() || {};

    // é‡ç½®è³‡æ–™
    specialTrains = data;
    Object.keys(specialIcons).forEach(k => delete specialIcons[k]);
    Object.keys(iconDesc).forEach(k => delete iconDesc[k]);

    // å–å¾—ç•¶å‰ç‡Ÿé‹æ—¥æœŸ (YYYY-MM-DD)
    const today = (typeof window.getOperationalDate === 'function') 
        ? window.getOperationalDate() 
        : new Date().toLocaleDateString('en-CA');

    Object.entries(data).forEach(([icon, cfg]) => {
        // æ–°å¢ï¼šæ—¥æœŸç¯„åœåˆ¤æ–·
        const startDate = cfg.StartDate; // é æœŸæ ¼å¼: "YYYY-MM-DD"
        const endDate = cfg.EndDate;     // é æœŸæ ¼å¼: "YYYY-MM-DD"

        // å¦‚æœè¨­å®šäº†é–‹å§‹æ—¥æœŸä¸”ç›®å‰å°šæœªé–‹å§‹ï¼Œå‰‡è·³é
        if (startDate && today < startDate) return;
        // å¦‚æœè¨­å®šäº†çµæŸæ—¥æœŸä¸”ç›®å‰å·²ç¶“çµæŸï¼Œå‰‡è·³é
        if (endDate && today > endDate) return;

        iconDesc[icon] = cfg.desc || "";
        (cfg.cars || []).forEach(cid => {
            specialIcons[cid] = icon;
        });
    });

    // ä½¿ç”¨é˜²æŠ–æ¸²æŸ“æ›´æ–°ä»‹é¢
    window.debouncedRenderAll();

    if (window.currentDetailCarId && typeof window.showCarHistory === 'function') {
        window.showCarHistory(window.currentDetailCarId, true);
    }
});
// ==========================================================

        
		
		const internalRouteMap = {
			"509": { rteKey: "614Px615P", dRte: "614P å…†åº· & 615P å±¯é–€ç¢¼é ­" },
			"510": { rteKey: "615Px614P", dRte: "615P å…†åº· & 614P å±¯é–€ç¢¼é ­" },
			"707": { rteKey: "751P", dRte: "751P" },
			"708": { rteKey: "761P", dRte: "761P" },
			"TMV": { rteKey: "TMV", dRte: "å±¯é–€å°ˆç¶«" },
			"YLV": { rteKey: "YLV", dRte: "å…ƒæœ—å°ˆç¶«" },
			"DEP": { rteKey: "å›å» ", dRte: "å›å» " },
			"NIS": { rteKey: "ä¸è¼‰å®¢", dRte: "ä¸è¼‰å®¢" },
			"SPL": { rteKey: "å°ˆç”¨", dRte: "å°ˆç”¨" }
		};

        window.db = db;
        window.user = null;
        window.reportGroups = {};
        window.favorites = new Set(); 
		window.isReportingETA = false; // Flag to prevent auto-selection from overwriting ETA data
		
        // æ ¸å¿ƒ Toggle åŠŸèƒ½ï¼šè™•ç† Set ä¸¦åŒæ­¥ Firebase
        window.toggleFav = async (fid, event) => {
            if (event) event.stopPropagation();
            if (!window.user) return window.showToast("è«‹å…ˆç™»å…¥");
            
            const fidStr = String(fid);
            if (!(window.favorites instanceof Set)) {
                window.favorites = new Set();
            }

            if (window.favorites.has(fidStr)) {
                window.favorites.delete(fidStr);
            } else {
                window.favorites.add(fidStr);
            }
            
            try {
                const userFavRef = ref(db, `users/${window.user.uid}/favs`);
                await set(userFavRef, Array.from(window.favorites));
                // æˆåŠŸåŒæ­¥å¾Œç”± onValue ç›£è½å™¨è§¸ç™¼ renderAllï¼Œæˆ–åœ¨æ­¤æ‰‹å‹•è§¸ç™¼ä¸€æ¬¡ç¢ºä¿åæ‡‰é€Ÿåº¦
                window.renderAll();
            } catch (e) {
                console.error("Firebase sync failed:", e);
                window.showToast("åŒæ­¥å¤±æ•—ï¼š" + e.message);
            }
        };

        window.isAdmin = false;

        window.getOperationalDate = (timestamp) => {
            const date = timestamp ? new Date(timestamp) : new Date();
            const hour = date.getHours();
            if (hour < 5) {
                date.setHours(date.getHours() - 5);
            }
            return date.toLocaleDateString('en-CA');
        };

        window.login = () => signInWithPopup(auth, provider).catch(e => window.showToast(e.message));
        window.logout = () => signOut(auth);

// ä¿®æ”¹å¾Œçš„ç™»å…¥ç‹€æ…‹ç›£è½
onAuthStateChanged(auth, async (user) => {
    window.user = user;
    const loginBtn = document.getElementById('loginBtn');
    let adminTag = document.getElementById('admin-tag');
    // å–å¾—ç®¡ç†å“¡æ™‚é–“è¼¸å…¥æ¡†å…ƒç´ 
    const adminRow = document.getElementById('adminTimeRow');

    if (user) {
        // --- é¡¯ç¤ºé ­åƒèˆ‡åç¨± ---
        const photoURL = user.photoURL;
        const displayName = user.displayName ? user.displayName.split(' ')[0] : 'ç”¨æˆ¶';
        
        if (photoURL) {
            loginBtn.innerHTML = `<img src="${photoURL}" class="user-avatar" alt="avatar"> <span>${displayName}</span>`;
            loginBtn.style.padding = "4px 12px 4px 4px";
        } else {
            loginBtn.innerHTML = `<span>${displayName}</span>`;
            loginBtn.style.padding = "8px 16px";
        }

        loginBtn.onclick = window.logout;
        
        // --- å¾ Firebase è®€å–ç®¡ç†å“¡æ¬Šé™ ---
try {
            const adminCheckRef = ref(db, `admins/${user.uid}`);
            const snapshot = await get(adminCheckRef);
            
            // å–å¾—åˆ‡æ›æŒ‰éˆ•èˆ‡ç®¡ç†å“¡è¡Œå…ƒç´ 
            const toggleBtn = document.getElementById('adminToggleBtn');
            const adminRow = document.getElementById('adminTimeRow');

            if (snapshot.exists() && snapshot.val() === true) {
                window.isAdmin = true;
                
                // 1. é¡¯ç¤ºç®¡ç†å“¡æ¨™ç±¤
                if (!document.getElementById('admin-tag')) {
                    const newAdminTag = document.createElement('span');
                    newAdminTag.id = 'admin-tag';
                    newAdminTag.innerText = "ç®¡ç†å“¡";
                    newAdminTag.style = "background: #fffbe6; color: #d4a017; font-size: 0.5em; padding: 2px 6px; border-radius: 4px; border: 1px solid #ffe58f; font-weight: bold; vertical-align: middle; margin-left: 5px;";
                    document.querySelector('h1').parentElement.appendChild(newAdminTag);
                }

                // 2. é¡¯ç¤ºåˆ‡æ›æŒ‰éˆ•ï¼Œä¸¦ç¢ºä¿è£œéŒ„è¡Œåˆå§‹ç‚ºã€Œå‹•ç•«æ”¶èµ·ã€ç‹€æ…‹
                if (toggleBtn) {
                    toggleBtn.style.display = 'inline-block'; 
                }
                if (adminRow) {
                    // ä½¿ç”¨å‹•ç•«å±¬æ€§è€Œé display: none
                    adminRow.style.maxHeight = '0px';
                    adminRow.style.opacity = '0';
                    adminRow.style.overflow = 'hidden';
                    adminRow.style.marginTop = '0px';
                    adminRow.style.borderWidth = '0px';
                }

            } else {
                window.isAdmin = false;
                const existingTag = document.getElementById('admin-tag');
                if (existingTag) existingTag.remove();
                
                // éç®¡ç†å“¡å‰‡å®Œå…¨éš±è—
                if (toggleBtn) toggleBtn.style.display = 'none';
                if (adminRow) {
                    adminRow.style.maxHeight = '0px';
                    adminRow.style.opacity = '0';
                }
            }
        } catch (e) {
            console.error("ç®¡ç†å“¡æ¬Šé™æª¢æŸ¥å¤±æ•—:", e);
            window.isAdmin = false;
            const toggleBtn = document.getElementById('adminToggleBtn');
            const adminRow = document.getElementById('adminTimeRow');
            if (toggleBtn) toggleBtn.style.display = 'none';
            if (adminRow) adminRow.style.display = 'none';
        }
        
        onValue(ref(db, `users/${user.uid}/favs`), (snap) => {
            const data = snap.val();
            const favArray = Array.isArray(data) ? data.map(String) : [];
            window.favorites = new Set(favArray);
            window.renderAll(); 
        });
    } else {
        // --- ç™»å‡ºç‹€æ…‹ ---
        loginBtn.innerText = "ç™»å…¥";
        loginBtn.onclick = window.login;
        window.isAdmin = false;
        
        const toggleBtn = document.getElementById('adminToggleBtn');
        const adminRow = document.getElementById('adminTimeRow');
        const adminTag = document.getElementById('admin-tag');
        
        // ç§»é™¤æ‰€æœ‰ç®¡ç†å“¡å°ˆå±¬å…ƒç´ 
        if (adminTag) adminTag.remove();
        if (toggleBtn) toggleBtn.style.display = 'none';
        if (adminRow) adminRow.style.display = 'none';
        
        window.favorites = new Set();
        window.renderAll(); 
    }
});

        onValue(liveRef, (snapshot) => {
    window.reportGroups = snapshot.val() || {};
    
    window.debouncedRenderAll();
    
    if(window.currentDetailCarId) {
        window.showCarHistory(window.currentDetailCarId, true);
    } 
});

        function checkCarStatus(id) {
            const num = parseInt(id);
            if (isNaN(num)) return { valid: false, msg: "ç·¨è™Ÿæ ¼å¼éŒ¯èª¤" };
            const retiredList = [1013, 1014, 1027];
            const isRetiredRange = (num >= 1071 && num <= 1090) || (num >= 1201 && num <= 1210);
            if (retiredList.includes(num) || isRetiredRange) {
                return { valid: false, msg: `è»Šå¡ ${num} å·²é€€å½¹ï¼Œç„¡æ³•å ±å‘Šã€‚` };
            }
            const inRange = (num >= 1001 && num <= 1162) || (num >= 1201 && num <= 1220);
            if (!inRange) {
                return { valid: false, msg: `è»Šç·¨ ${num} è¶…å‡ºå¯å ±å‘Šç¯„åœ (1001-1162, 1201-1220)ã€‚` };
            }
            return { valid: true };
        }

        function validateComposition(carIds) {
            const nums = carIds.map(id => parseInt(id));
            const series12XX = nums.filter(n => n >= 1201 && n <= 1220);
            const series1000_1162 = nums.filter(n => n >= 1001 && n <= 1162);

            if (series12XX.length > 0) {
                if (nums.length === 1) {
                    return { valid: false, msg: `éŒ¯èª¤ï¼š${series12XX[0]} ç‚ºä¸è¨­é§•é§›å®¤çš„æ‹–å¡åˆ—è»Šï¼Œç„¡æ³•å–®ç¨è¡Œé§›ã€‚` };
                }
                if (series1000_1162.length === 0) {
                    return { valid: false, msg: `éŒ¯èª¤ï¼š${series12XX.join(', ')} ç‚ºä¸è¨­é§•é§›å®¤çš„æ‹–å¡åˆ—è»Šï¼Œç„¡æ³•å–®ç¨è¡Œé§›ã€‚` };
                }
            }
            return { valid: true };
        }

window.publishToFirebase = function(inputIds, newTrace) {
    // 0. ç²å–ä¸¦è™•ç† GPS åº§æ¨™
    const coordsInput = document.getElementById('geoCoords');
    
    // 1. è™•ç†è¼¸å…¥è½‰æ› (åƒ…è™•ç†å¸¶æœ‰åˆ†éš”ç¬¦çš„ç°¡å¯«)
    let processedInput = inputIds.toString().replace(/\s+/g, '');
    if (processedInput.includes('-') || processedInput.includes('/') || processedInput.includes('.')) {
        let parts = processedInput.split(/[-/.]/);
        if (parts.length === 2) {
            if (parts[0].length === 2 && parts[1].length === 2) {
                processedInput = `10${parts[0]}-10${parts[1]}`;
            } 
            else if (parts[0].length === 3 && parts[1].length === 3) {
                processedInput = `1${parts[0]}-1${parts[1]}`;
            }
            else if (parts[0].length >= 3 && parts[1].length < parts[0].length) {
                let prefix = parts[0].substring(0, parts[0].length - parts[1].length);
                processedInput = `${parts[0]}-${prefix}${parts[1]}`;
            }
        }
    } 

    const fullId = processedInput;
    const carIds = fullId.split('-');

    // 2. è™•ç†å…§éƒ¨ç·¨ç¢¼è½‰æ›
    if (internalRouteMap[newTrace.rteKey]) {
        const codec = internalRouteMap[newTrace.rteKey];
        newTrace.rteKey = codec.rteKey;
        newTrace.dRte = codec.dRte;
    }

    // 3. é©—è­‰å–®ä¸€è»Šå¡ç‹€æ…‹
    for (let id of carIds) {
        if (!id) continue;
        const status = checkCarStatus(id);
        if (!status.valid) { 
            window.showToast(status.msg); 
            return; 
        }
    }

    // 4. é©—è­‰ç·¨çµ„åˆæ³•æ€§
    const compStatus = validateComposition(carIds);
    if (!compStatus.valid) { 
        window.showToast(compStatus.msg); 
        return; 
    }

    // 5. é‡å° Phase 1 è»Šè¼›è¡Œé§› 705 ç¶«çš„ç‰¹æ®Šæç¤º
    const hasPhase1 = carIds.some(id => {
        const num = parseInt(id);
        return num >= 1001 && num <= 1090;
    });
    if (hasPhase1 && newTrace.rteKey === "705") {
        if (!confirm("æç¤ºï¼šè«‹ç¢ºèªç›¸é—œè¡Œè¹¤å ±é“æ˜¯å¦æ­£ç¢ºï¼Ÿ")) return;
    }

    // --- 6. æ ¸å¿ƒä¿®æ”¹ï¼šè™•ç†ç®¡ç†å“¡è‡ªå®šç¾©æ—¥æœŸèˆ‡æ™‚é–“ (ç¬¦åˆ 5am ç‡Ÿé‹æ—¥å®šç¾©) ---
let now = Date.now();
    const adminDateVal = document.getElementById('adminDate')?.value;
    const adminTimeVal = document.getElementById('adminTime')?.value;

    if (window.isAdmin && adminDateVal) {
        // å¦‚æœæ²’å¡«æ™‚é–“ï¼Œé è¨­ç‚ºä¸­åˆ 12:00:00
        const timeToUse = adminTimeVal ? adminTimeVal : "12:00:00";
        const customDate = new Date(`${adminDateVal}T${timeToUse}`);
        
        if (!isNaN(customDate.getTime())) {
            now = customDate.getTime();
            // åŒæ­¥ä¿®æ­£é¡¯ç¤ºç”¨çš„æ™‚é–“å­—ä¸² (HH:mm)
            const d = customDate;
            newTrace.tStr = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        }
    }
    // -------------------------------------------------------------

    const promises = carIds.map(carId => {
        if (!carId) return;
        const nodeRef = ref(db, 'live_reports/' + carId);
        
        return get(nodeRef).then(snap => {
            let group = snap.val() || { carId: carId, traces: [] };
            if (!Array.isArray(group.traces)) group.traces = [];
            
            // å°‡æ–°è¨˜éŒ„å­˜å…¥
            group.traces.unshift({ ...newTrace, fullId: fullId, timestamp: now });
            
            // é‡æ–°æŒ‰æ™‚é–“æˆ³é™åºæ’åˆ— (ç¢ºä¿è£œéŒ„è³‡æ–™æ’å…¥æ­£ç¢ºä½ç½®)
            group.traces.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            group.traces = group.traces.slice(0, 50);
            return set(nodeRef, group);
        });
    });

    Promise.all(promises)
    .then(() => {
        window.showToast("æäº¤æˆåŠŸï¼");
        // åƒ…æ¸…ç©ºæ™‚é–“èˆ‡å‚™è¨»ï¼Œä¿ç•™æ—¥æœŸæ¡†å…§å®¹æ–¹ä¾¿ä¸‹æ¬¡æäº¤
        if (document.getElementById('adminTime')) document.getElementById('adminTime').value = ""; 
        if (document.getElementById('memo')) document.getElementById('memo').value = "";

        // åˆ·æ–°è¦–åœ–èˆ‡æ­·å²
        if (typeof window.renderAll === 'function') window.renderAll();
    })
    .catch(e => {
        window.showToast("æäº¤å¤±æ•—: " + e.message);
    });
};
window.deleteTrace = async function(carId, timestamp) {
    if (!window.user) { 
        window.showToast("è«‹å…ˆç™»å…¥"); 
        return; 
    }
    if (!window.isAdmin) { 
        window.showToast("æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯ç®¡ç†å“¡"); 
        return; 
    }

    // å‘¼å« 904 æ¨£å¼çš„é€šç”¨é¸å–®
    showActionSheet({
        title: `<b style="color: #ff3b30; font-size: 1.1em;">âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿ</b><br><span style="font-size: 0.85em; color: #888;">(è‹¥ç‚ºæ‹–å¡ç·¨çµ„è¨˜éŒ„å°‡æœƒåŒæ­¥æ¸…é™¤)</span>`,
        buttons: [
            {
                text: "åˆªé™¤",
                danger: true,
                onClick: async () => {
                    // ç¢ºä¿åœ¨ onClick å…§éƒ¨å¯ä»¥å­˜å– Firebase çš„æ–¹æ³•
                    // å¦‚æœä½ çš„ script æ˜¯ type="module"ï¼Œè«‹ç¢ºä¿ db, ref, get, set å·²ç¶“å®šç¾©åœ¨å…¨åŸŸæˆ–å¾ä¸Šæ–¹å¼•å…¥
                    try {
                        // 1. å–å¾—ä¸»è»Šè³‡æ–™åº«ç´€éŒ„
                        const primaryCarRef = ref(db, `live_reports/${carId}`);
                        const primarySnap = await get(primaryCarRef);
                        
                        if (!primarySnap.exists()) {
                            window.showToast('æ‰¾ä¸åˆ°è©²è»Šè¼›è³‡æ–™');
                            return;
                        }

                        let primaryData = primarySnap.val();
                        const targetTrace = (primaryData.traces || []).find(t => t.timestamp === timestamp);

                        if (!targetTrace) {
                            window.showToast('æ‰¾ä¸åˆ°è©²æ¢è¨˜éŒ„');
                            return;
                        }

                        // 2. åˆ¤æ–·æ˜¯å¦ç‚ºç·¨çµ„
                        let carIdsToUpdate = [carId];
                        if (targetTrace.fullId && targetTrace.fullId.includes('-')) {
                            carIdsToUpdate = targetTrace.fullId.split('-');
                        }

                        // 3. åŸ·è¡Œæ‰¹æ¬¡æ›´æ–°
                        const deletePromises = carIdsToUpdate.map(async (id) => {
                            const carRef = ref(db, `live_reports/${id}`);
                            const snap = await get(carRef);
                            if (snap.exists()) {
                                let data = snap.val();
                                if (data.traces && Array.isArray(data.traces)) {
                                    const newTraces = data.traces.filter(t => t.timestamp !== timestamp);
                                    if (newTraces.length !== data.traces.length) {
                                        data.traces = newTraces;
                                        return set(carRef, data);
                                    }
                                }
                            }
                            return Promise.resolve();
                        });

                        await Promise.all(deletePromises);

                        // 4. æ›´æ–°æœ¬åœ°ç·©å­˜
                        carIdsToUpdate.forEach(id => {
                            if (window.reportGroups && window.reportGroups[id] && Array.isArray(window.reportGroups[id].traces)) {
                                window.reportGroups[id].traces = window.reportGroups[id].traces.filter(t => t.timestamp !== timestamp);
                            }
                        });

                        // 5. åˆ·æ–°ä»‹é¢
                        if (document.getElementById('detailOverlay')?.style.display === 'flex') {
                            if (typeof window.showCarHistory === 'function') {
                                window.showCarHistory(window.currentDetailCarId, true);
                            }
                        }
                        
                        if (typeof window.renderAll === 'function') {
                            window.renderAll();
                        }

                        window.showToast('è¨˜éŒ„å·²åŒæ­¥åˆªé™¤');

                    } catch (error) {
                        console.error("Delete Error:", error);
                        window.showToast('åˆªé™¤å¤±æ•—ï¼š' + error.message);
                    }
                }
            }
        ]
    });
};

		const initApp = () => {
			const todayOpDate = window.getOperationalDate();
			if(document.getElementById('searchDate')) document.getElementById('searchDate').value = todayOpDate;
			if(document.getElementById('flashDate')) document.getElementById('flashDate').value = todayOpDate;
			if(document.getElementById('detailDateFilter')) document.getElementById('detailDateFilter').value = todayOpDate;
			
			// --- æ–°å¢ï¼šç›£è½æœå°‹æ–‡å­—æ¡†å³æ™‚æ›´æ–° ---
			const searchInput = document.getElementById('searchComp');
			if (searchInput) {
				searchInput.addEventListener('input', () => {
					window.renderAll();
				});
			}
			// --------------------------------
// å®šç¾©æ™‚é–“è¡¨é…ç½®
const timetableMap = {
    1: { name: "é€±ä¸€è‡³äº”"},
    6: { name: "é€±å…­"},
    7: { name: "æ˜ŸæœŸæ—¥åŠå…¬çœ¾å‡æœŸ"},
    4: { name: "å­¸æ ¡å‡æœŸ"},
    8: { name: "é€šå®µæœå‹™"}
};

let currentTimetableType = 1;

// è¼”åŠ©å‡½æ•¸ï¼šæª¢æŸ¥ä»Šå¤©æ˜¯å¦åœ¨ä»»ä½•å‡æœŸç¯„åœå…§
const isTodayHoliday = (ranges) => {
    if (!ranges || !Array.isArray(ranges)) return false;
    
    const now = new Date();
    // æ–°å¢ï¼šå¦‚æœä»Šå¤©æ˜¯é€±å…­ (6) æˆ–é€±æ—¥ (0)ï¼Œå‰‡ä¸è¦–ç‚ºå­¸æ ¡å‡æœŸ
    const dayOfWeek = now.getDay();
    if (dayOfWeek === 0 || dayOfWeek === 6) {
        return false;
    }

    const todayStr = now.toLocaleDateString('en-CA'); // å–å¾— YYYY-MM-DD
    const todayTime = new Date(todayStr).getTime();

    return ranges.some(range => {
        const start = new Date(range.start).getTime();
        const end = new Date(range.end).getTime();
        return todayTime >= start && todayTime <= end;
    });
};

// ç›£è½ Firebase config (åŒ…å« special_trains, schoolHolidays, system)
const configRef = ref(db, 'config');
// ä¿®æ”¹ index.html ä¸­çš„ onValue(configRef, ...) ç›£è½å™¨
onValue(configRef, (snapshot) => {
    const config = snapshot.val() || {};
    const systemData = config.system || {};
    const holidayRanges = config.schoolHolidays || [];
    
    const now = new Date();
    const dayOfWeek = now.getDay(); // 0 æ˜¯é€±æ—¥, 6 æ˜¯é€±å…­

    // é è¨­ç‚ºé€±ä¸€è‡³äº”
    let finalType = 1; 

    // --- å„ªå…ˆç´šåˆ¤æ–·é–‹å§‹ ---

    // 1. å¼·åˆ¶åˆ¤å®šé€±æœ« (Saturday/Sunday ALWAYS override)
    if (dayOfWeek === 0) {
        finalType = 7; // æ˜ŸæœŸæ—¥
    } else if (dayOfWeek === 6) {
        finalType = 6; // é€±å…­
    } 
    // 2. åˆ¤æ–·å…¬çœ¾å‡æœŸ (é€é Firebase system/timetableType æ‰‹å‹•è¨­å®š)
    // å¦‚æœä»Šå¤©ä¸æ˜¯é€±æœ«ï¼Œä½†ç®¡ç†å“¡åœ¨å¾Œå°å°‡é¡å‹æ”¹ç‚º 7 (å…¬çœ¾å‡æœŸ)
    else if (systemData.timetableType == 7) {
        finalType = 7;
    }
    // 3. è‡ªå‹•åˆ¤æ–·å­¸æ ¡å‡æœŸ (School Holiday)
    else if (isTodayHoliday(holidayRanges)) {
        finalType = 4;
    } 
    // 4. å…¶ä»–æƒ…æ³è·Ÿéš¨ç³»çµ±è¨­å®š (é è¨­é€šå¸¸ç‚º 1)
    else {
        finalType = systemData.timetableType || 1;
    }

    currentTimetableType = finalType;
    
    // æ›´æ–°ä»‹é¢é¡¯ç¤º
    const displayEl = document.getElementById('timetable-display');
    if (displayEl) {
        displayEl.innerText = timetableMap[currentTimetableType]?.name || "æœªçŸ¥";
    }

    const holidayWarning = document.getElementById('holiday-warning');
    if (holidayWarning) {
        // åªæœ‰åœ¨æœ€çµ‚çµæœç‚ºé¡å‹ 4 æ™‚æ‰é¡¯ç¤ºå­¸æ ¡å‡æœŸè­¦å‘Š
        holidayWarning.style.display = (currentTimetableType == 4) ? 'block' : 'none';
    }
});


// åœ¨ index.html çš„ initApp å‡½æ•¸å…§å°‹æ‰¾ä¸¦ä¿®æ”¹ä»¥ä¸‹å€æ®µ
const rs = document.getElementById('routeSelect');
const srs = document.getElementById('searchRoute');

if (rs && srs) {
    rs.innerHTML = "";
    srs.innerHTML = '<option value="">æ‰€æœ‰è·¯ç¶«</option>';
    
    // å–å¾—æ’åºå¾Œçš„è·¯ç·šåç¨±é™£åˆ—
    const sortedRouteNames = Object.keys(routeCfg).sort();

    sortedRouteNames.forEach(r => {
        // å ±å‘Šé¸å–® (rs) ä¿æŒåŸæ¨£
        rs.innerHTML += `<option value="${r}">${r}</option>`;

        // æœå°‹é¸å–® (srs) è™•ç† 614P/615P åˆä½µé¡¯ç¤º
        if (r === "614P") {
            srs.innerHTML += `<option value="614P/615P">614P/615P</option>`;
        } else if (r === "615P") {
            // è·³éï¼Œå› ç‚ºå·²ç¶“åˆä½µåœ¨ 614P/615P
            return;
        } else {
            srs.innerHTML += `<option value="${r}">${r}</option>`;
        }
    });

            }
            if (typeof window.onRouteUpdate === "function") window.onRouteUpdate();
            if (typeof window.initETAStations === "function") window.initETAStations();
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

// --- ä¿®å¾©ï¼šé‡ç½®æŒ‰éˆ•é‚è¼¯ ---
const resetBtn = document.getElementById('btnResetFilters'); 
if (resetBtn) {
    resetBtn.addEventListener('click', () => {
        // 1. å–å¾—æ‰€æœ‰æœå°‹æ¬„ä½
        const searchInput = document.getElementById('searchComp'); // ç·¨è™Ÿæœå°‹
        const searchRoute = document.getElementById('searchRoute'); // è·¯ç¶«é¸æ“‡
        const searchDate = document.getElementById('searchDate');   // æ—¥æœŸé¸æ“‡
        
        // 2. é‚„åŸç‚ºé è¨­å€¼
        if (searchInput) searchInput.value = "";
        if (searchRoute) searchRoute.value = "";
        if (searchDate) {
            // ä½¿ç”¨æ‚¨å®šç¾©çš„ getOperationalDate å–å¾—ä»Šæ—¥ç‡Ÿé‹æ—¥æœŸ
            searchDate.value = window.getOperationalDate();
        }

        // 3. ç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨
        window.renderAll();
    });
}
// -----------------------

const processRouteDisplay = (dRte) => {
    if (!dRte) return "";
    const specials = ["ä¸è¼‰å®¢", "å¸æ©Ÿè¨“ç·´", "å›å» ", "å°ˆç”¨"];
    
    for (let s of specials) {
        if (dRte.startsWith(s)) {
            // æª¢æŸ¥æ˜¯å¦çœŸçš„æœ‰é¸æ“‡ç›®çš„åœ°
            // å¦‚æœ dRte å‰›å¥½ç­‰æ–¼ s (ä¾‹å¦‚ "ä¸è¼‰å®¢") 
            // æˆ–è€…ç›®çš„åœ°éƒ¨åˆ†æ˜¯é è¨­çš„ "-" æˆ– "---"
            if (dRte === s || dRte.includes(" å¾€ -") || dRte.includes(" å¾€ ---")) {
                return s; // éš±è—ç›®çš„åœ°ï¼Œåªé¡¯ç¤ºã€Œä¸è¼‰å®¢ã€
            }
            // å¦å‰‡è¡¨ç¤ºæœ‰å…·é«”ç›®çš„åœ°ï¼ˆä¾‹å¦‚ "ä¸è¼‰å®¢ å¾€ å…†åº·"ï¼‰ï¼Œå‰‡å›å‚³å®Œæ•´çš„ dRte
            return dRte;
        }
    }
    
    // ä»¥ä¸‹ä¿ç•™ä½ åŸå§‹çš„é‚è¼¯
    if (dRte.includes(" å¾€ -")) return dRte.replace(" å¾€ -", "");
    if (dRte.includes("å¾€ å¤©æ°´åœå¾ªç’°ç¶«") || dRte.includes("å¾€ ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™")) {
        return dRte.replace(" å¾€ ", " ");
    }
    return dRte;
};

window.renderAll = function() {
    // --- æ•ˆèƒ½å„ªåŒ–ï¼šé å…ˆè¨ˆç®—ç•¶æ—¥æ‰€æœ‰è»Šåºçš„æœ€æ–°æ™‚é–“æˆ³ (O(N) å„ªåŒ–) ---
    window.currentRunLatestMap = {};
    Object.values(window.reportGroups).forEach(group => {
        const latest = group.traces ? group.traces[0] : null;
        if (latest && latest.rno && latest.rno !== "---") {
            const opDate = window.getOperationalDate(latest.timestamp);
            const key = `${opDate}_${latest.rno}`;
            // æ‰¾å‡ºè©²è»Šåºåœ¨ç•¶å¤©æœ€æ™šè¢«å ±å‘Šçš„æ™‚é–“
            if (!window.currentRunLatestMap[key] || latest.timestamp > window.currentRunLatestMap[key]) {
                window.currentRunLatestMap[key] = latest.timestamp;
            }
        }
    });

    const mList = document.getElementById('masterList');
    const fList = document.getElementById('flashList');
    const favArea = document.getElementById('favListOnMain');
    
    const searchRoute = document.getElementById('searchRoute')?.value || "";
    const searchComp = document.getElementById('searchComp')?.value.toLowerCase() || "";
    const searchDate = document.getElementById('searchDate')?.value;
    const flashDate = document.getElementById('flashDate')?.value;


            // 1. æ•´ç†æ‰€æœ‰è¡Œè¹¤æ•¸æ“š
            const compositionMap = {};
            // ç¢ºä¿åŒä¸€çµ„è»Šåœ¨åŒä¸€ç§’çš„å ±å‘Šåªè¢«è¨ˆå…¥ä¸€æ¬¡
Object.values(window.reportGroups).forEach(group => {
    if(!group.traces) return;
    group.traces.forEach(t => {
        const fid = String(t.fullId || group.carId);
        if (!compositionMap[fid]) compositionMap[fid] = [];
        // å¢åŠ ä¸€å€‹æª¢æŸ¥ï¼Œé˜²æ­¢åŒä¸€ timestamp çš„è¨˜éŒ„é‡è¤‡é€²å…¥åŒä¸€ fid çµ„
        if (!compositionMap[fid].some(exist => exist.timestamp === t.timestamp)) {
            compositionMap[fid].push(t);
        }
    });
});

            const sortedComps = Object.keys(compositionMap).map(fid => ({
                fid: fid,
                traces: compositionMap[fid].sort((a,b) => b.timestamp - a.timestamp)
            }))
            .sort((a,b) => b.traces[0].timestamp - a.traces[0].timestamp);

            // 2. é€šç”¨ HTML æ§‹å»ºå™¨ (å·²å„ªåŒ–ï¼šç›®çš„åœ°æ—åŠ å…¥è¡Œè¹¤ä½ç½®)
const buildHTML = (comp, prefix = "m", showDesc = false, filterDate = null) => {
    let rawTraces = comp.traces || [];
    if (filterDate) {
        rawTraces = rawTraces.filter(t => window.getOperationalDate(t.timestamp) === filterDate);
    }

    const searchRouteValue = document.getElementById('searchRoute')?.value || "";

    let displayTraces = [];
    if (rawTraces.length > 0) {
        const seenTimestamps = new Set();
        rawTraces.forEach((current) => {
            if (seenTimestamps.has(current.timestamp)) return;
            seenTimestamps.add(current.timestamp);
            if (displayTraces.length === 0) {
                displayTraces.push(current);
            } else {
                const last = displayTraces[displayTraces.length - 1];
                if (last.dRte !== current.dRte || last.rno !== current.rno || last.loc !== current.loc) {
                    displayTraces.push(current);
                }
            }
        });
    }

if (prefix !== "fav" && displayTraces.length === 0) return "";

    // 1. å–å¾—è©²ç·¨çµ„çœŸæ­£çš„æœ€æ–°ä¸€ç­†è¨˜éŒ„
    let latest = displayTraces.length > 0 ? displayTraces[0] : null;

    if (searchRouteValue && displayTraces.length > 0) {
        const matchedTrace = displayTraces.find(t => {
            const rte = t.rteKey || "";
            if (searchRouteValue === "614P/615P") {
                return rte.includes("614P") || rte.includes("615P");
            }
            return rte === searchRouteValue || rte.split('x').includes(searchRouteValue);
        });

        if (matchedTrace) {
            // åªæœ‰åœ¨ livepage æ‰å…è¨±é¡¯ç¤ºéæ™‚çš„åŒ¹é…ç´€éŒ„
            if (prefix === "live") {
                latest = matchedTrace;
            } else {
                // å…¶ä»–é é¢ï¼ˆå¦‚ Favï¼‰æ°¸é é¡¯ç¤ºæœ€æ–°çš„ä¸€ç­†
                latest = displayTraces[0];
            }
        } else if (prefix !== "live") {
            // åœ¨å…¶ä»–é é¢è‹¥ç„¡åŒ¹é…ï¼Œä¾ç„¶ç¶­æŒæœ€æ–°ç‹€æ…‹
            latest = displayTraces[0];
        }
    }

    const displayRte = latest ? (latest.rteKey || "") : "";
    const colorKey = displayRte.split('x')[0];
    const hex = latest ? (colorMap[colorKey] || "#333") : "#bdc3c7";
    const carIds = comp.fid.split('-');
    const cleanId = prefix + comp.fid.replace(/[^a-zA-Z0-9]/g, '');
                
let specialBadgesHTML = "";
                if (showDesc) {
                    const uniqueIcons = [...new Set(carIds.map(id => specialIcons[id]).filter(Boolean))];
                    if (uniqueIcons.length > 0) {
                        specialBadgesHTML = `<div class="special-badge-area">` + 
                            uniqueIcons.map(icon => {
                                const cfg = (typeof specialTrains !== 'undefined') ? specialTrains[icon] : {};
                                const start = cfg.StartDate || "";
                                const end = cfg.EndDate || "";
                                
                                let dateInfo = "";
                                if (start || end) {
                                    // å„ªåŒ–å¾Œçš„æ—¥æœŸæ¨£å¼ï¼Œæ”¾ç½®æ–¼ä¸‹ä¸€è¡Œ
                                    dateInfo = `
                                        <div style="
                                            flex-basis: 100%; 
                                            color: #856404; 
                                            font-size: 0.75em; 
                                            margin-top: 1px; 
                                            margin-left: 22px; 
                                            font-weight: normal;
                                            display: flex;
                                            align-items: center;
                                        ">
                                            ${start} â€” ${end}
                                        </div>`;
                                }

                                return `
                                    <div class="special-desc-item" style="display: flex; flex-wrap: wrap; align-items: center;">
                                        <div style="font-weight: bold; color: #856404; display: flex; align-items: center;">
                                            <span style="margin-right: 4px;">${icon}</span>
                                            <span>${iconDesc[icon]}</span>
                                        </div>
                                        ${dateInfo}
                                    </div>`;
                            }).join('') + 
                            `</div>`;
                    }
                }
				
				
				
				let isCurrentlyOnSearchRoute = true;
if (searchRouteValue && latest) {
    const currentRteParts = (latest.rteKey || "").split('x');
    if (searchRouteValue === "614P/615P") {
        isCurrentlyOnSearchRoute = currentRteParts.some(p => p.includes("614P") || p.includes("615P"));
    } else {
        isCurrentlyOnSearchRoute = currentRteParts.includes(searchRouteValue);
    }
}

                const carLinks = carIds.map(c => {
                    const icon = specialIcons[c] || "";
					const space = icon ? " " : ""; // åªæœ‰ç•¶æœ‰åœ–ç¤ºæ™‚æ‰åŠ ç©ºæ ¼
                    return `<span class="car-link" onclick="event.stopPropagation(); showCarHistory('${c}')">${icon}${c}</span>`;
                }).join('-');
                
                const isFav = window.favorites.has(String(comp.fid));

                let headerTimeDisplay = "";
if (latest) {
    const d = new Date(latest.timestamp);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    const ss = String(d.getSeconds()).padStart(2, '0');
    
    const timeStr = `${yyyy}/${mm}/${dd} ${hh}:${min}:${ss}`;
    headerTimeDisplay = `<span style="color:#999; font-size:0.75em; font-weight:normal; font-family: monospace;">${timeStr}</span>`;
}

const outdatedStyle = (!isCurrentlyOnSearchRoute && searchRouteValue) ? "opacity: 0.55;" : "";
// Check for prefix === "live" and verify that the 'latest' being shown isn't actually the absolute newest trace
// 1. Existing check: Is this specific vehicle showing a record that is NOT its own absolute latest?
// 1. æª¢æŸ¥æ˜¯å¦ç‚ºè©²è»Šè¼›çš„èˆŠç´€éŒ„ (ç”¨æ–¼ Live Page æœå°‹)
const isNotAbsoluteLatestForThisCar = latest && displayTraces.length > 0 && latest.timestamp !== displayTraces[0].timestamp;

// 2. æª¢æŸ¥è©²è»Šåºæ˜¯å¦å·²è¢«å…¶ä»–è»Šè¼›æ¥æ‰‹ (ä½¿ç”¨å‰›æ‰å»ºç«‹çš„ Map)
let isRunTakenByAnotherCar = false;
if (latest && latest.rno && latest.rno !== "---") {
    const opDate = window.getOperationalDate(latest.timestamp);
    const key = `${opDate}_${latest.rno}`;
    // å¦‚æœ Map ä¸­çš„æ™‚é–“æˆ³æ¯”ç•¶å‰é€™ç­†ç´€éŒ„æ–°ï¼Œä»£è¡¨è©²è»Šåºå·²æœ‰æ›´æ–°çš„å ±å‘Š
    if (window.currentRunLatestMap[key] > latest.timestamp) {
        isRunTakenByAnotherCar = true;
    }
}

// æ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼š
// - Live Page ä¸‹é¡¯ç¤ºéæ™‚ç´€éŒ„è¦å‡º Badge
// - æ‰€æœ‰é é¢ä¸‹ï¼Œåªè¦è»Šåºè¢«å–ä»£å°±è¦å‡º Badge
const shouldShowBadge = (prefix === "live" && isNotAbsoluteLatestForThisCar) || isRunTakenByAnotherCar;

const outdatedBadge = shouldShowBadge ? 
    `<div style="background:#eee; color:#666; font-size:10px; padding:2px 6px; border-radius:3px; font-weight:normal; width:fit-content;">è»Šå‹™èª¿å‹•</div>` : "";

// å›å‚³ HTML (ä¿æŒä½ è¦æ±‚çš„æ ¼å¼)
return `
    <div class="timeline-card" style="border-left-color:${hex}; ${!latest ? 'opacity:0.7;' : ''}">
        ${specialBadgesHTML}
        <div class="timeline-header" onclick="toggleCollapse('${cleanId}')" style="display: block; padding: 10px 15px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                <div style="display:flex; align-items:flex-start; gap:10px;">
                    <span id="arrow-${cleanId}" class="collapse-arrow" style="margin-top:2px;">â–¼</span>
                    <div style="display: flex; flex-direction: column;">
                        <b class="car-group-title" style="color:${hex}; line-height:1.2;">${carLinks}</b>
                        ${outdatedBadge}
                    </div>
                </div>
                ${latest ? headerTimeDisplay : ''}
            </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">

<div style="display: flex; align-items: center; gap: 6px; flex: 1; overflow: hidden; padding-left: 23px;">
    ${latest ? (() => {
        const rawRoute = latest.rteKey || "";
        let routeHTML = "";
        let pureDest = processRouteDisplay(latest.dRte);

        // è™•ç†æ‘˜è¦éƒ¨åˆ†çš„è·¯ç·šé¡¯ç¤ºèˆ‡é¡è‰²
// 1. è™•ç† Route HTML é¡¯ç¤º
        if (rawRoute.includes('x')) {
            const parts = rawRoute.split('x');
            const c1 = colorMap[parts[0]] || '#333';
            const c2 = colorMap[parts[1]] || '#333';
            
            routeHTML = `
                <span class="route-badge" style="background:${c1}; text-align: center;">${parts[0]}</span>
                <span style="font-size: 0.8em; color: #666; font-weight: bold;">â†’</span>
                <span class="route-badge" style="background:${c2}; text-align: center;">${parts[1]}</span>
            `;
            // ä¿®æ­£ï¼šé€™è£¡åªç§»é™¤ rawRoute å­—ä¸²ï¼Œé¿å…èª¤å‚·ç›®çš„åœ°
            pureDest = pureDest.replace(rawRoute, '').trim();
        } else {
            const c = colorMap[rawRoute] || '#333';
            routeHTML = `<span class="route-badge" style="background:${c}; text-align: center;">${rawRoute}</span>`;
            pureDest = pureDest.replace(rawRoute, '').trim();
        }

        // 2. ä¿®å¾©ï¼šèª¿æ•´æ‘˜è¦éƒ¨åˆ†çš„ã€Œå¾€ã€å­—é¡¯ç¤ºé‚è¼¯
        // ç§»é™¤ rawRoute === "å›å» " çš„å¼·åˆ¶éš±è—æ¢ä»¶
        const hideToLabel = pureDest.includes("å¤©æ°´åœå¾ªç’°ç¶«") || 
                           pureDest.includes("ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™") || 
                           pureDest === "---" ||
                           pureDest === ""; // å¦‚æœç›®çš„åœ°ç‚ºç©ºä¹Ÿä¸é¡¯ç¤ºã€Œå¾€ã€

        const toLabel = hideToLabel ? "" : `<span style="font-size: 0.85em; color: #666;">å¾€</span>`;

        // 3. æ¸…ç†ç›®çš„åœ°é¡¯ç¤ºæ–‡å­—
        // å…ˆç§»é™¤é–‹é ­å¯èƒ½é‡è¤‡çš„ã€Œå¾€ã€å­—ï¼Œç„¶å¾Œå†æ¸…ç†
        pureDest = pureDest.replace(/^å¾€\s*/, '').trim();

        // é‡å°ç‰¹æ®Šè·¯ç·šçš„é¡å¤–è™•ç†ï¼šå¦‚æœ pureDest è®Šæˆäº† "---"ï¼Œæˆ‘å€‘åœ¨æœ€çµ‚é¡¯ç¤ºæ™‚å°‡å…¶æ¸…ç©º
        let finalDestText = latest ? pureDest : 'ä»Šæ—¥æš«ç„¡è¨˜éŒ„';
        if (finalDestText === "---") finalDestText = "";

return `
            <span class="run-no-badge" 
                ${window.isAdmin && latest ? `onclick="event.stopPropagation(); deleteTrace('${carIds[0]}', ${latest.timestamp})"` : ""} 
                style="margin:0; flex-shrink:0; ${window.isAdmin ? "cursor: pointer; border: 1px dashed #bdc3c7;" : ""}">
                ${latest ? latest.rno : '---'}
            </span>
            <div style="display: flex; align-items: center; gap: 2px; flex-shrink:0;">${routeHTML}</div>
            ${toLabel}
            <b style="font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0;">
                ${finalDestText}
            </b>
            ${latest ? `
            <span style="color: #999; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 2; min-width: 0;">
                @ ${latest.loc}
            </span>` : ''}
        `;
    })() : `<span style="color:#999; font-size:0.8em;">ä»Šæ—¥æš«ç„¡è¡Œè¹¤</span>`}
</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
    <div onclick="toggleFav('${comp.fid}', event)" 
         style="cursor:pointer; color:${isFav?'#f1c40f':'#ccc'}; font-size:1.2em; line-height: 1;">
        â˜…
    </div>
</div>
                        </div>
                    </div>
                    <div id="body-${cleanId}" class="timeline-body">
                        ${latest ? `
                            <div style="padding: 0 0px 10px 0px; color: #666; font-size: 0.85em;">æœ€æ–°ä½ç½®ï¼š<b>${latest.loc}</b> (${latest.tStr})</div>

${displayTraces.slice(0, 5).map((t, idx) => {
    const d = new Date(t.timestamp);
    const isSmallScreen = window.innerWidth < 380;
    const ts = d.toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: isSmallScreen ? undefined : '2-digit', 
        hour12: false 
    });
    
    const rawRoute = t.rteKey || "";
    let indicatorStyle = "";
    let routeHTML = "";
    let pureDest = processRouteDisplay(t.dRte);

    // åªæœ‰åœ¨å« "x" æ™‚æ‰å¥—ç”¨å£“ç¸®å­—é«”
    const isXRoute = rawRoute.includes('x');
    const routeExtraStyle = isXRoute ? 'font-stretch: condensed;' : '';

    if (isXRoute) {
        const parts = rawRoute.split('x');
        const c1 = colorMap[parts[0]] || '#333';
        const c2 = colorMap[parts[1]] || '#333';
        indicatorStyle = `background: linear-gradient(180deg, ${c1} 0%, ${c2} 100%);`;
        routeHTML = `
            <span class="route-badge" style="background:${c1}; text-align: center; ${routeExtraStyle}">${parts[0]}</span>
            <span style="font-size: 0.8em; color: #666; font-weight: bold;">â†’</span>
            <span class="route-badge" style="background:${c2}; text-align: center; ${routeExtraStyle}">${parts[1]}</span>
        `;
        pureDest = pureDest.replace(rawRoute, '').trim();
    } else {
        const c = colorMap[rawRoute] || '#333';
        indicatorStyle = `background: ${c};`;
        routeHTML = `<span class="route-badge" style="background:${c}; text-align: center;">${rawRoute}</span>`;
        pureDest = pureDest.replace(rawRoute, '').trim();
    }

    const hideToLabel = pureDest.includes("å¤©æ°´åœå¾ªç’°ç¶«") || 
                        pureDest.includes("ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™") || 
                        rawRoute === "å›å» " || 
                        pureDest === "---" ||
                        pureDest === "";

    // --- ä¿®æ”¹ï¼šç•¶æ»¿è¶³ x è·¯ç·šæ¢ä»¶æ™‚ï¼Œå°‡ã€Œå¾€ã€å­—å¤§å°è¨­ç‚º 0.8em ---
    const toFontSize = isXRoute ? "0.8em" : "0.85em";
    const toLabelHTML = hideToLabel ? "" : `<span style="font-size: ${toFontSize}; color: #666;">å¾€</span>`;
    pureDest = pureDest.replace(/^å¾€\s*/, '').trim();

    // æ ¹æ“šæ˜¯å¦ç‚º x è·¯ç·šå‹•æ…‹æ±ºå®šç›®çš„åœ°èˆ‡åœ°é»çš„ Style
    const destStyle = isXRoute 
        ? `font-size: 0.8em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0;` 
        : `font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0;`;

    const locStyle = isXRoute
        ? `color: #999; font-size: 0.8em; white-space: nowrap; overflow: hidden; min-width: 0; flex-shrink: 2;`
        : `color: #999; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 2; min-width: 0;`;

    const runNoAction = window.isAdmin ? `onclick="event.stopPropagation(); deleteTrace('${t.fullId || comp.fid}', ${t.timestamp})"` : "";
    const runNoStyle = window.isAdmin ? "cursor: pointer; border: 1px dashed #bdc3c7;" : "border: 1px solid #eee;";

    return `
    <div class="trace-item ${idx===0?'latest':''}" style="padding-right: 2px;">
        <div class="timeline-indicator" style="${indicatorStyle}"></div>
        
        <div style="display:flex; flex-direction: column; gap: 4px; width: 100%; overflow: hidden;">
            <div style="display:flex; justify-content:space-between; align-items: center; gap: 4px;">
                <div style="display: flex; align-items: center; gap: 4px; flex: 1; overflow: hidden;">
                    <span class="run-no-badge" ${runNoAction} style="margin:0; flex-shrink:0; ${runNoStyle}">${t.rno || '---'}</span>
                    <div style="display: flex; align-items: center; gap: 2px; flex-shrink:0;">${routeHTML}</div>
                    ${toLabelHTML}
                    <b style="${destStyle}">
                        ${pureDest}
                    </b>
                    <span style="${locStyle}">
                        @ ${t.loc}
                    </span>
                </div>

                <div style="white-space: nowrap; flex-shrink:0; margin-left: auto; text-align: right;">
                    <small style="color: #2980b9; font-weight: bold; font-family: monospace; font-size: 0.82em;">${ts}</small>
                </div>
            </div>
            
            ${t.mem ? `<div style="margin-left: 5px; font-size: 0.8em; color: #e67e22; background: #fff5eb; padding: 2px 6px; border-radius: 4px; border-left: 2px solid #e67e22; align-self: flex-start;">ğŸ“ ${t.mem}</div>` : ''}
        </div>
    </div>`;
}).join('')}
` : `<div style="padding:15px; color:#999; text-align:center; font-size:0.9em;">æ­¤ç·¨çµ„ä»Šæ—¥å°šç„¡è¡Œè¹¤å ±å‘Šã€‚</div>`}
                    </div>
                </div>`;
            };

            // --- 3. æ¸²æŸ“ä¸»åˆ—è¡¨ ---
// --- 3. æ¸²æŸ“ä¸»åˆ—è¡¨ ---
if (mList) {
    const sortMethod = document.getElementById('sortOrder')?.value || "reportTime";
    const today = window.getOperationalDate(); 
    const targetDate = searchDate || today; // ç¢ºå®šç›®æ¨™æ—¥æœŸï¼ˆé»˜èªç‚ºä»Šå¤©ï¼‰

    // é‡æ–°æ•´ç†åƒ…å±¬æ–¼è©²æ—¥æœŸçš„ compositionMap
    const dailyCompositionMap = {};
    Object.values(window.reportGroups).forEach(group => {
        if(!group.traces) return;
        group.traces.forEach(t => {
            // é—œéµä¿®æ­£ï¼šåªä¿ç•™ç‡Ÿé‹æ—¥ç¬¦åˆ targetDate çš„è¨˜éŒ„
            if (window.getOperationalDate(t.timestamp) === targetDate) {
                const fid = String(t.fullId || group.carId);
                if (!dailyCompositionMap[fid]) dailyCompositionMap[fid] = [];
                dailyCompositionMap[fid].push(t);
            }
        });
    });

    // å°‡æ•´ç†å¥½çš„æ¯æ—¥æ•¸æ“šè½‰æ›ç‚ºæ•¸çµ„
    let filtered = Object.keys(dailyCompositionMap).map(fid => ({
        fid: fid,
        traces: dailyCompositionMap[fid].sort((a,b) => b.timestamp - a.timestamp)
    }));

// [ä¿®æ”¹æ–¼ window.renderAll å…§éƒ¨]
filtered = filtered.filter(comp => {
    const traces = comp.traces || [];
    
    // 1. è·¯ç·šéæ¿¾ï¼šåªè¦è©²è»Šä»Šæ—¥ã€Œæ›¾ç¶“ã€è·‘éæœå°‹çš„è·¯ç·šå³ä¿ç•™
    let routeMatch = false;
    if (!searchRoute) {
        routeMatch = true;
    } else {
        routeMatch = traces.some(t => {
            const rte = t.rteKey || "";
            if (searchRoute === "614P/615P") {
                return rte.includes("614P") || rte.includes("615P");
            }
            // è™•ç†è·¨ç·š (å¦‚ 751x615)ï¼Œæ‹†åˆ†å¾Œæª¢æŸ¥æ˜¯å¦åŒ…å«æœå°‹è·¯ç·š
            return rte.split('x').includes(searchRoute);
        });
    }
    
    // 2. ç·¨è™Ÿéæ¿¾
    const compMatch = comp.fid.toLowerCase().includes(searchComp);
    
    return routeMatch && compMatch;
});

    // è™•ç†ç·¨è™Ÿç¯„åœçš„ç‰¹æ®Šé¡¯ç¤ºï¼ˆç•¶æ‰¾ä¸åˆ°è¨˜éŒ„æ™‚ï¼‰
    const isValidId = (idStr) => {
        const num = parseInt(idStr);
        if (isNaN(num)) return false;
        return (num >= 1001 && num <= 1162) || (num >= 1201 && num <= 1220);
    };

    if (filtered.length === 0 && searchComp && !searchRoute) {
        if (isValidId(searchComp)) {
            const emptyComp = { fid: searchComp, traces: [] };
            mList.innerHTML = buildHTML(emptyComp, "fav", false, targetDate);
        } else {
            mList.innerHTML = "<div class='empty-msg' style='text-align:center; padding:20px; color:grey;'>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</div>";
        }
    } else {
// [ä¿®æ”¹æ–¼ window.renderAll å…§éƒ¨çš„æ’åºå€å¡Š]
filtered.sort((a, b) => {
    // Determine which record is actually being displayed for comparison
    const getActiveTrace = (comp) => {
        if (searchRoute && comp.traces.length > 0) {
            const matched = comp.traces.find(t => {
                const rte = t.rteKey || "";
                if (searchRoute === "614P/615P") return rte.includes("614P") || rte.includes("615P");
                return rte === searchRoute || rte.split('x').includes(searchRoute);
            });
            // If on Live Page and a match is found, use it; otherwise use the latest
            if (matched) return matched;
        }
        return comp.traces[0];
    };

    const traceA = getActiveTrace(a);
    const traceB = getActiveTrace(b);

    if (sortMethod === "routeRun") {
        const rteA = traceA ? (traceA.rteKey || "") : "";
        const rteB = traceB ? (traceB.rteKey || "") : "";

        const getSortGroup = (r) => {
            if (r.includes("614P") || r.includes("615P")) return "614P/615P";
            return r.includes('x') ? r.split('x')[0] : r;
        };

        const groupA = getSortGroup(rteA);
        const groupB = getSortGroup(rteB);

        if (groupA !== groupB) {
            return groupA.localeCompare(groupB, undefined, {numeric: true});
        }
        
        // Use the Run Number of the displayed record
        return (traceA?.rno || "").localeCompare(traceB?.rno || "", undefined, {numeric: true});
    } else {
        // Report Time sorting: also use the displayed record's timestamp
        const timeA = traceA ? traceA.timestamp : 0;
        const timeB = traceB ? traceB.timestamp : 0;
        return timeB - timeA;
    }
});

        mList.innerHTML = filtered.map(c => buildHTML(c, "live", false, targetDate)).join('') 
            || "<div class='empty-msg' style='text-align:center; padding:20px; color:grey;'>è©²æ—¥æœŸæš«ç„¡è¡Œè¹¤è¨˜éŒ„</div>";
    }
}

// --- 4. æ¸²æŸ“ä»ŠæœŸé–ƒå¡ (å·²åŠ å…¥æ—¥æœŸç¯„åœéæ¿¾) ---
if (fList) {
    const flashDate = document.getElementById('flashDate')?.value || window.getOperationalDate();
    const specialCarIds = Object.keys(specialIcons);

    const finalFlashMap = new Map();
    const processedIds = new Set();

    // è¼”åŠ©å‡½æ•¸ï¼šæª¢æŸ¥è©²åœ–ç¤ºå°æ‡‰çš„åˆ—è»Šåœ¨ flashDate æ˜¯å¦æœ‰æ•ˆ
    const isWithinDateRange = (icon) => {
        const cfg = (typeof specialTrains !== 'undefined') ? specialTrains[icon] : {};
        if (!cfg) return true; // è‹¥ç„¡è¨­å®šï¼Œé è¨­é¡¯ç¤º
        
        const start = cfg.StartDate;
        const end = cfg.EndDate;
        
        if (start && flashDate < start) return false; // æ—©æ–¼é–‹å§‹æ—¥æœŸ
        if (end && flashDate > end) return false;     // æ™šæ–¼çµæŸæ—¥æœŸ
        return true;
    };

    // 1. å„ªå…ˆè™•ç†ç•¶å¤©æœ‰å ±åˆ°çš„ç·¨çµ„
    sortedComps.forEach(comp => {
        const ids = comp.fid.split('-');
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ç‰¹åˆ¥åœ–ç¤ºï¼Œä¸”è©²åœ–ç¤ºåœ¨ç•¶å‰ flashDate æ˜¯å¦ã€Œæœ‰æ•ˆã€
        const validSpecialIcons = ids.filter(id => {
            const icon = specialIcons[id];
            return icon && isWithinDateRange(icon);
        });

        const hasTracesToday = comp.traces && comp.traces.some(t => window.getOperationalDate(t.timestamp) === flashDate);

        // åªæœ‰ç•¶ã€Œåœ–ç¤ºåœ¨æœ‰æ•ˆæœŸå…§ã€ä¸”ã€Œä»Šæ—¥æœ‰è¡Œè¹¤ã€æ‰åŠ å…¥
        if (validSpecialIcons.length > 0 && hasTracesToday) {
            finalFlashMap.set(comp.fid, comp);
            ids.forEach(id => { if (specialIcons[id]) processedIds.add(id); });
        }
    });

    // 2. è™•ç†ç•¶å¤©ç„¡è¡Œè¹¤çš„ç‰¹åˆ¥è»Šï¼šç¶­æŒæœ€å¾Œå·²çŸ¥ç·¨çµ„ (åŒæ¨£éœ€æª¢æŸ¥æ—¥æœŸæœ‰æ•ˆæœŸ)
    specialCarIds.forEach(id => {
        if (processedIds.has(id)) return;
        
        const icon = specialIcons[id];
        if (!isWithinDateRange(icon)) return; // è‹¥è©²ç‰¹åˆ¥è»Šåœ¨é¸æ“‡æ—¥æœŸå·²å¤±æ•ˆ/æœªé–‹å§‹ï¼Œç›´æ¥è·³é

        const group = window.reportGroups && window.reportGroups[id];
        let lastFid = id;
        let latestTraces = [];

        if (group && group.traces && group.traces.length > 0) {
            const absoluteLatest = [...group.traces].sort((a, b) => b.timestamp - a.timestamp)[0];
            lastFid = absoluteLatest.fullId || group.carId || id;
            latestTraces = group.traces;
        }

        if (!finalFlashMap.has(lastFid)) {
            finalFlashMap.set(lastFid, {
                fid: lastFid,
                traces: latestTraces
            });
        }
        
        lastFid.split('-').forEach(cid => { if (specialIcons[cid]) processedIds.add(cid); });
    });

    // ... å¾ŒçºŒçš„æ’åºèˆ‡æ¸²æŸ“é‚è¼¯ä¿æŒä¸è®Š ...
    const flashDisplayList = Array.from(finalFlashMap.values()).sort((a, b) => {
        const aHas = a.traces && a.traces.some(t => window.getOperationalDate(t.timestamp) === flashDate);
        const bHas = b.traces && b.traces.some(t => window.getOperationalDate(t.timestamp) === flashDate);
        return (bHas ? 1 : 0) - (aHas ? 1 : 0);
    });

    fList.innerHTML = flashDisplayList.map(c => {
        let html = buildHTML(c, "fav", true, flashDate);
        html = html.split('id="body-fav').join('id="body-flashpage');
        html = html.split('id="arrow-fav').join('id="arrow-flashpage');
        html = html.split("toggleCollapse('fav").join("toggleCollapse('flashpage");
        return html;
    }).join('') || "<div class='empty-msg' style='text-align:center; padding:20px; color:grey;'>ç›®å‰æ²’æœ‰ç›¸é—œè¡Œè¹¤</div>";
}

// åœ¨ window.renderAll å…§éƒ¨æ‰¾åˆ°è™•ç† favArea çš„éƒ¨åˆ†
if (favArea) {
    if (window.user) {
        // ä½¿ç”¨è‡ªè¨‚é †åº (window.customOrder) æˆ–é è¨­é †åº
        let favIds = window.customOrder && window.customOrder.length > 0 
                     ? window.customOrder 
                     : Array.from(window.favorites);

        if (favIds.length > 0) {
            const today = window.getOperationalDate();
            favArea.innerHTML = favIds.map(fid => {
                const existingComp = sortedComps.find(c => String(c.fid) === String(fid));
                const todayTraces = existingComp ? existingComp.traces.filter(t => 
                    window.getOperationalDate(t.timestamp) === today
                ) : [];

                const compToRender = { fid: fid, traces: todayTraces };
                const html = buildHTML(compToRender, "fav", false, null);

                // --- é—œéµä¿®æ”¹ï¼šåŠ å…¥ draggable å±¬æ€§èˆ‡äº‹ä»¶ ---
                return `<div class="draggable-item" 
                             draggable="true" 
                             data-fid="${fid}" 
                             ondragstart="handleDragStart(event)" 
                             ondragover="handleDragOver(event)" 
                             ondrop="handleDrop(event)">
                            ${html}
                        </div>`;
            }).join('');
        } else {
            favArea.innerHTML = "<p style='text-align:center; padding:20px; color:#999; font-size:0.9em;'>ç›®å‰æ²’æœ‰ç›£å¯Ÿç·¨çµ„</p>";
        }
    } else {
        favArea.innerHTML = "<p style='text-align:center; padding:20px; color:#999; font-size:0.9em;'>è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹ç›£å¯Ÿåˆ—è¡¨</p>";
    }
}
if (favArea) {
    if (window.user) {
        const favIds = Array.from(window.favorites);
        if (favIds.length > 0) {
            const today = window.getOperationalDate(); // ç²å–ç•¶å‰ç‡Ÿé‹æ—¥ (5:00AM ç‚ºç•Œ)

            favArea.innerHTML = favIds.map(fid => {
                const existingComp = sortedComps.find(c => String(c.fid) === String(fid));
                
                // éæ¿¾è©²ç·¨çµ„ä¸­åƒ…å±¬æ–¼ä»Šæ—¥ç‡Ÿé‹æ—¥çš„è¨˜éŒ„
                const todayTraces = existingComp ? existingComp.traces.filter(t => 
                    window.getOperationalDate(t.timestamp) === today
                ) : [];

                // æ§‹å»ºä¸€å€‹è‡¨æ™‚ç‰©ä»¶å‚³çµ¦ buildHTML
                // å¦‚æœæ²’æœ‰ä»Šæ—¥è¨˜éŒ„ï¼Œtraces æœƒæ˜¯ç©ºé™£åˆ—ï¼Œå¾è€Œè§¸ç™¼ã€Œä»Šæ—¥æš«ç„¡è¡Œè¹¤ã€é¡¯ç¤º
                const compToRender = { 
                    fid: fid, 
                    traces: todayTraces 
                };
                
                // ä½¿ç”¨ prefix "fav" æ¸²æŸ“ï¼ŒbuildHTML å…§éƒ¨æœƒè™•ç†ç©º traces çš„é¡¯ç¤º
                return buildHTML(compToRender, "fav", false, null);
            }).join('');
        } else {
            favArea.innerHTML = "<p style='text-align:center; padding:20px; color:#999; font-size:0.9em;'>ç›®å‰æ²’æœ‰ç›£å¯Ÿç·¨çµ„</p>";
        }
    } else {
        favArea.innerHTML = "<p style='text-align:center; padding:20px; color:#999; font-size:0.9em;'>è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹ç›£å¯Ÿåˆ—è¡¨</p>";
    }
}
        };
		
let touchStartX = 0;
let touchEndX = 0;

window.showCarHistory = (cid, isSilent = false) => {
    const prevMonthView = window.lastMonthView;
    window.currentDetailCarId = cid;
    
    const overlay = document.getElementById('detailOverlay');
    const detailListContainer = document.getElementById('detailList');
    const todayStr = window.getOperationalDate(new Date().getTime());

    if (!isSilent) {
        window.currentSelectedDate = todayStr;
        window.calendarDisplayMonth = todayStr.substring(0, 7);
        document.body.style.overflow = 'hidden'; 
        overlay.style.display = 'flex';
        requestAnimationFrame(() => { overlay.classList.add('show'); });
        detailListContainer.scrollTop = 0;
    }

    const mainIcon = specialIcons[cid] || "";
    const titleElem = document.getElementById('detailTitle');
    if (titleElem) {
        const desc = iconDesc[mainIcon] || "";
        titleElem.innerHTML = `
            ${mainIcon}${cid}
            ${desc ? `<span style="display: inline-block; width: auto; min-width: 70px; background:#fffdf0; color:#856404; font-size:12px; padding:2px 6px; border-radius:3px; margin-left:3px; font-weight:normal; text-align: center; vertical-align: middle; line-height: 1.4;">${desc}</span>` : ''}
        `;
    }
    
    detailListContainer.style.padding = "0px";
    detailListContainer.style.width = "100%";
    detailListContainer.style.display = "block"; 
    detailListContainer.style.overflowY = "auto"; 
    detailListContainer.style.webkitOverflowScrolling = "touch";

    if (!window.calendarDisplayMonth) {
        window.calendarDisplayMonth = (window.currentSelectedDate || todayStr).substring(0, 7);
    }

    const [viewYear, viewMonthIdx] = window.calendarDisplayMonth.split('-').map(n => parseInt(n));
    const viewMonth = viewMonthIdx - 1;

    const firstDayOfMonth = new Date(viewYear, viewMonth, 1);
    const lastDayOfMonth = new Date(viewYear, viewMonth + 1, 0);
    const startOffset = firstDayOfMonth.getDay(); 

    const traces = window.reportGroups[cid]?.traces || [];
    const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];

    const calendarDays = [];
    for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
        const d = new Date(viewYear, viewMonth, i, 12, 0, 0);
        calendarDays.push({
            dateStr: window.getOperationalDate(d.getTime()),
            dayNum: i
        });
    }

    window.lastMonthView = window.calendarDisplayMonth;
    const isMonthChanged = prevMonthView && prevMonthView !== window.calendarDisplayMonth;

    if (isMonthChanged && calendarDays.length > 0) {
        const currentSystemMonth = todayStr.substring(0, 7);
        if (window.calendarDisplayMonth === currentSystemMonth) {
            window.currentSelectedDate = todayStr;
        } else {
            window.currentSelectedDate = calendarDays[0].dateStr;
        }
    }

    let selectedDateStr = window.currentSelectedDate || todayStr;

    window.exportCarMonthToCSV = (targetCid, targetMonth) => {
        if (!window.isAdmin) return;
        const targetTraces = window.reportGroups[targetCid]?.traces || [];
        const monthTraces = targetTraces.filter(t => window.getOperationalDate(t.timestamp).startsWith(targetMonth))
                                       .sort((a, b) => a.timestamp - b.timestamp);
        if (monthTraces.length === 0) {
            alert("è©²æœˆä»½ä¸¦ç„¡è¡Œè¹¤å ±å‘Š");
            return;
        }
        let csvContent = "\ufeffæ—¥æœŸ,æ™‚é–“,è»Šåº,è·¯ç·š,ç›®çš„åœ°,ä½ç½®,ç·¨çµ„,å‚™è¨»\n";
        monthTraces.forEach(t => {
            const dateObj = new Date(t.timestamp);
            const d = window.getOperationalDate(t.timestamp);
            const time = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            let cleanDest = (t.dRte || "").replace(/,/g, ' ').trim();
            if (cleanDest.includes("å¾€")) cleanDest = cleanDest.split("å¾€").pop().trim();
            if (!cleanDest || cleanDest === "---") cleanDest = t.dRte || "";
            const row = [d, time, t.rno || "", t.rteKey || "", cleanDest, (t.loc || "").replace(/,/g, ' '), t.fullId || targetCid, (t.mem || "").replace(/,/g, ' ')];
            csvContent += row.join(",") + "\n";
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `LR_${targetCid}_${targetMonth}.csv`;
        link.click();
    };

    let calendarHTML = `
        <style>
            @keyframes monthSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
            @keyframes listFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            @keyframes listFadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }
            .month-anim-active { animation: monthSlideIn 0.35s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
            .history-card-anim { animation: listFadeIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
            .list-fade-out { animation: listFadeOut 0.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
            .day-item { transition: transform 0.1s active, background-color 0.3s ease, border-color 0.3s ease; will-change: background, border-color; }
            .day-item:active { transform: scale(0.95); }
            .day-selected { background-color: #e3f2fd !important; border-color: #2196f3 !important; }
            .fixed-calendar-wrapper { position: sticky; top: 0; left: 0; right: 0; z-index: 100; background: #f8f9fa; touch-action: pan-y; }
        </style>
        <div class="fixed-calendar-wrapper" id="calendarWrapper"
             ontouchstart="this.tX = event.touches[0].clientX; this.tY = event.touches[0].clientY;"
             ontouchend="(()=>{
                const diffX = event.changedTouches[0].clientX - this.tX;
                const diffY = event.changedTouches[0].clientY - this.tY;
                if(Math.abs(diffX) > 70 && Math.abs(diffX) > Math.abs(diffY)) {
                    const d = new Date(${viewYear}, ${viewMonth} + (diffX > 0 ? -1 : 1), 1);
                    const y = d.getFullYear();
                    const m = (d.getMonth() + 1).toString().padStart(2, '0');
                    window.calendarDisplayMonth = \`\${y}-\${m}\`;
                    window.showCarHistory('${cid}', true);
                }
             })()">
            <div class="calendar-card" style="background: #fdfdfd; margin: 0 10px 10px 10px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.04); overflow: hidden; box-sizing: border-box; transform: translateY(10px);">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 15px; border-bottom: 1px solid #f2f2f2; background: #fafafa;">
                    <div onclick="event.stopPropagation(); (()=>{ 
                        const d = new Date(${viewYear}, ${viewMonth} - 1, 1);
                        const y = d.getFullYear();
                        const m = (d.getMonth() + 1).toString().padStart(2, '0');
                        window.calendarDisplayMonth = \`\${y}-\${m}\`;
                        window.showCarHistory('${cid}', true);
                    })()" style="cursor: pointer; padding: 4px 10px; color: #ccc; font-size: 0.8em; line-height: 1;">â—€</div>
                    
                    <div id="calendarTitleBtn" style="flex: 1; text-align: center; cursor: pointer; position: relative; user-select: none;"
                         onmousedown="this.lpTimer = setTimeout(()=>{ 
                            this.dataset.longPressed = '1'; 
                            const now = new Date();
                            const y = now.getFullYear();
                            const m = (now.getMonth() + 1).toString().padStart(2, '0');
                            window.calendarDisplayMonth = \`\${y}-\${m}\`;
                            window.currentSelectedDate = window.getOperationalDate(now.getTime());
                            window.showCarHistory('${cid}', true);
                         }, 600);"
                         onmouseup="clearTimeout(this.lpTimer);"
                         onmouseleave="clearTimeout(this.lpTimer);"
                         ontouchstart="this.lpTimer = setTimeout(()=>{ 
                            this.dataset.longPressed = '1'; 
                            const now = new Date();
                            const y = now.getFullYear();
                            const m = (now.getMonth() + 1).toString().padStart(2, '0');
                            window.calendarDisplayMonth = \`\${y}-\${m}\`;
                            window.currentSelectedDate = window.getOperationalDate(now.getTime());
                            window.showCarHistory('${cid}', true);
                         }, 600);"
                         ontouchend="clearTimeout(this.lpTimer);"
                         onclick="if(this.dataset.longPressed === '1') { this.dataset.longPressed = ''; return; } document.getElementById('monthPicker').showPicker();">
                        <span style="font-size: 0.95em; color: #333; font-weight: bold; line-height: 1;">${viewYear}å¹´ ${viewMonthIdx}æœˆ</span>
                        <input type="month" id="monthPicker" style="position: absolute; opacity: 0; width: 1px; height: 1px; left: 50%;"
                               value="${window.calendarDisplayMonth}"
                               onchange="window.calendarDisplayMonth = this.value; window.showCarHistory('${cid}', true)">
                    </div>

                    <div onclick="event.stopPropagation(); (()=>{ 
                        const d = new Date(${viewYear}, ${viewMonth} + 1, 1);
                        const y = d.getFullYear();
                        const m = (d.getMonth() + 1).toString().padStart(2, '0');
                        window.calendarDisplayMonth = \`\${y}-\${m}\`;
                        window.showCarHistory('${cid}', true);
                    })()" style="cursor: pointer; padding: 4px 10px; color: #ccc; font-size: 0.8em; line-height: 1;">â–¶</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); background: #fdfdfd; border-bottom: 1px solid #f0f0f0; text-align: center; padding: 4px 0;">
                    ${weekDays.map(w => `<span style="font-size: 0.6em; color: #bbb;">${w}</span>`).join('')}
                </div>
                <div class="${isMonthChanged ? 'month-anim-active' : ''}" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: 5px; background: #fff;">`;
    
    for (let p = 0; p < startOffset; p++) {
        calendarHTML += `<div style="min-height: 35px; background: transparent;"></div>`;
    }

    calendarDays.forEach(item => {
        const dateStr = item.dateStr;
        const dayTraces = traces.filter(t => {
            const isSameDate = window.getOperationalDate(t.timestamp) === dateStr;
            const isHiddenRoute = (t.rteKey === "å›å» " || t.rteKey === "ä¸è¼‰å®¢");
            return isSameDate && !isHiddenRoute;
        });

        const dayCompositions = new Set();
        dayTraces.forEach(t => {
            const fid = (t.fullId || cid).toString();
            dayCompositions.add(fid);
        });

        const pastTraces = traces.filter(t => {
            const tDate = window.getOperationalDate(t.timestamp);
            const isHidden = (t.rteKey === "å›å» " || t.rteKey === "ä¸è¼‰å®¢");
            return tDate < dateStr && !isHidden;
        }).sort((a,b) => b.timestamp - a.timestamp);

        const lastKnownFid = pastTraces.length > 0 ? (pastTraces[0].fullId || cid).toString() : null;
        
        let isCompositionChanged = dayCompositions.size > 1; 
        if (!isCompositionChanged && lastKnownFid && dayCompositions.size > 0) {
            if (!dayCompositions.has(lastKnownFid)) {
                isCompositionChanged = true;
            }
        }

        const dailyBadges = [];
        const addedDisplaySet = new Set();
        dayTraces.forEach(t => {
            let rKey = t.rteKey || "";
            let dRte = t.dRte || "";
            let displayNum = ""; let colorKey = "";
            if ((rKey === "614P" && dRte.includes("å…†åº·")) || (rKey === "615P" && dRte.includes("å±¯é–€ç¢¼é ­"))) {
                displayNum = "509"; colorKey = "614P";
            } else if ((rKey === "615P" && dRte.includes("å…†åº·")) || (rKey === "614P" && dRte.includes("å±¯é–€ç¢¼é ­"))) {
                displayNum = "510"; colorKey = "615P";
            }
            if (displayNum) {
                if (!addedDisplaySet.has(displayNum)) {
                    dailyBadges.push({ text: displayNum, color: colorKey });
                    addedDisplaySet.add(displayNum);
                }
            } else {
                const parts = rKey.includes('x') ? rKey.split('x') : [rKey];
                parts.forEach(p => { if (p && !addedDisplaySet.has(p)) { dailyBadges.push({ text: p, color: p }); addedDisplaySet.add(p); } });
            }
        });

        const isSelected = selectedDateStr === dateStr;
        const isToday = todayStr === dateStr;
        
        // --- ä¿®æ­£é¡è‰²åˆ¤æ–·å„ªå…ˆç´š ---
        let dayColor = "#666";
        let borderColor = "#f0f0f0";

        if (isCompositionChanged) {
            dayColor = "#e67e22"; // ç·¨çµ„è®ŠåŒ–æ—¥æ–‡å­—ä¸€å¾‹ç‚ºæ©˜è‰²
            borderColor = "#fb923c"; // ç·¨çµ„è®ŠåŒ–æ—¥é‚Šæ¡†ä¸€å¾‹ç‚ºæ©˜è‰²
        }

        // å¦‚æœæ˜¯ã€Œä»Šå¤©ã€æˆ–ã€Œå·²é¸ä¸­ã€ï¼Œé‚Šæ¡†å¼·åˆ¶æ”¹ç‚ºè—è‰²
        if (isSelected || isToday) {
            borderColor = "#2196f3";
            // å¦‚æœé€™å…©å¤©åŒæ™‚æ²’æœ‰ç·¨çµ„è®ŠåŒ–ï¼Œæ–‡å­—æ‰é¡¯ç¤ºç‚ºè—è‰²ï¼›è‹¥æœ‰è®ŠåŒ–ï¼Œå‰‡ç¶­æŒæ©˜è‰²æ–‡å­—
            if (!isCompositionChanged) {
                dayColor = "#2196f3";
            }
        }

        const hasBadges = dailyBadges.length > 0;
        const extraCount = addedDisplaySet.size - 3;

        calendarHTML += `
            <div class="day-item ${isSelected ? 'day-selected' : ''}" 
                 onclick="(()=>{
                    if('${window.currentSelectedDate}' === '${dateStr}') return;
                    document.querySelectorAll('.day-item.day-selected').forEach(el => el.classList.remove('day-selected'));
                    const list = document.getElementById('historyListWrapper');
                    if(list) list.classList.add('list-fade-out');
                    setTimeout(() => { window.currentSelectedDate='${dateStr}'; window.showCarHistory('${cid}', true); }, 180);
                 })()" 
                 style="background: #fff; 
                        border: 1px solid ${borderColor}; 
                        border-radius: 6px; padding: 3px 0; text-align: center; cursor: pointer; min-height: ${hasBadges ? '55px' : '35px'}; display: flex; flex-direction: column; align-items: center; box-sizing: border-box;">
                <div style="line-height: 1; display: flex; align-items: baseline; gap: 2px;">
                    <span style="font-size: 0.72em; color: ${dayColor}; font-weight: ${isSelected || isToday || isCompositionChanged ? 'bold' : 'normal'};">${item.dayNum}</span>
                    ${extraCount > 0 ? `<span style="font-size: 0.45em; color: #aaa; font-weight: normal;">+${extraCount}</span>` : ''}
                </div>
                ${hasBadges ? `<div style="display: flex; flex-direction: column; align-items: center; gap: 2px; width: 100%; padding: 2px 2px 0 2px; box-sizing: border-box;">
                    ${dailyBadges.slice(0, 3).map(b => `<span style="background: ${colorMap[b.color] || '#333'}; color: white; font-size: 0.52em; padding: 1px 5px; border-radius: 3px; font-weight: bold; line-height: 1.2;">${b.text}</span>`).join('')}
                </div>` : ''}
            </div>`;
    });
    calendarHTML += `</div></div><div style="height:10px;"></div></div>`;

    const filteredTraces = traces.filter(t => window.getOperationalDate(t.timestamp) === selectedDateStr);
    let listHTML = `<div id="historyListWrapper" class="history-card-anim">
        <div class="history-group" style="width: 100%; box-sizing: border-box; background: #f8f9fa;">
            <div style="padding: 0px 12px 6px 12px; font-size: 0.82em; color: #888; font-weight: bold; display: flex; align-items: center; justify-content: space-between;">
                <span>è¨˜éŒ„è©³æƒ…</span>
                ${window.isAdmin ? `<span onclick="event.stopPropagation(); window.exportCarMonthToCSV('${cid}', '${window.calendarDisplayMonth}')" style="font-size: 1.2em; cursor: pointer; margin-left: auto;" title="åŒ¯å‡ºæœ¬æœˆç´€éŒ„">ğŸ“¥</span>` : ''}
            </div>
        </div>
        <div class="timeline-body expanded" style="display: block; background: white; border-radius: 12px; margin: 0 10px 15px 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.08); border: 1px solid #eee; box-sizing: border-box;">
            <div style="padding: 0;">`;

    if (filteredTraces.length === 0) {
        listHTML += `<div style='text-align:center; padding:40px; color:#bdc3c7; font-size: 0.85em;'>è©²æ—¥ç„¡å ±å‘Šè¨˜éŒ„</div>`;
    } else {
        let lastGroupKey = "";
        filteredTraces.sort((a, b) => b.timestamp - a.timestamp).forEach((t) => {
            const currentFid = t.fullId || cid;
            const displayFid = currentFid.split('-').map(id => (specialIcons[id] || "") + id).join('-');
            if (displayFid !== lastGroupKey) {
                listHTML += `<div style="padding: 0px 0 6px 6px; display: flex; align-items: center; gap: 6px; ${lastGroupKey !== "" ? "border-top: 1px solid #eee;" : ""}">
                               <span style="font-size: 0.72em; color: #1a252f; font-weight: bold; background: #ecf0f1; padding: 1px 8px; border-radius: 10px;">${displayFid}</span>
                          </div>`;
                lastGroupKey = displayFid;
            }
            const rawRoute = t.rteKey || ""; let routeHTML = ""; let pureDest = processRouteDisplay(t.dRte);
            if (rawRoute.includes('x')) {
                const parts = rawRoute.split('x');
                routeHTML = `<span class="route-badge" style="background:${colorMap[parts[0]] || '#333'}; padding: 1px 5px; border-radius: 3px;">${parts[0]}</span><span style="font-size: 0.7em; color: #999; margin: 0 1px;">â†’</span><span class="route-badge" style="background:${colorMap[parts[1]] || '#333'}; padding: 1px 5px; border-radius: 3px;">${parts[1]}</span>`;
                pureDest = pureDest.replace(rawRoute, '').trim();
            } else {
                routeHTML = `<span class="route-badge" style="background:${colorMap[rawRoute] || '#333'}; padding: 1px 5px; border-radius: 3px;">${rawRoute}</span>`;
                pureDest = pureDest.replace(rawRoute, '').trim();
            }
            const hideToLabel = pureDest.includes("å¤©æ°´åœå¾ªç’°ç¶«") || pureDest.includes("ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™") || rawRoute === "å›å» " || pureDest === "---";
            const fullTimeStr = new Date(t.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            listHTML += `<div class="trace-item" style="border-bottom: 1px solid #f2f2f2; padding: 6px 2px 6px 8px; display: flex; flex-direction: column; gap: 4px; box-sizing: border-box;">
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div style="display: flex; align-items: center; gap: 4px; overflow: hidden; flex: 1;">
                        <span class="run-no-badge" onclick="deleteTrace('${cid}', ${t.timestamp})" style="flex-shrink:0; font-size: 0.78em; padding: 1px 3px; cursor: pointer; border: 1px dashed #bdc3c7;">${t.rno}</span>
                        <div style="display: flex; align-items: center; flex-shrink:0;">${routeHTML}</div>
                        ${hideToLabel ? "" : `<span style="font-size: 0.8em; color: #999;">å¾€</span>`}
                        <b style="font-size: 0.88em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${pureDest.replace(/^å¾€\s*/, '')}</b>
                        <span style="color: #999; font-size: 0.8em; white-space: nowrap;">@ ${t.loc}</span>
                    </div>
                    <small style="color: #2980b9; font-family: monospace; font-size: 0.75em; flex-shrink: 0;">${fullTimeStr}</small>
                </div>
                ${t.mem ? `<div style="margin-left: 5px; font-size: 0.8em; color: #e67e22; background: #fff5eb; padding: 0px 6px; border-radius: 4px; border-left: 2px solid #e67e22; align-self: flex-start;">ğŸ“ ${t.mem}</div>` : ''}
            </div>`;
        });
    }
    listHTML += `</div></div></div>`;
    detailListContainer.innerHTML = calendarHTML + listHTML;
};

window.closeDetail = () => {
    const overlay = document.getElementById('detailOverlay');
    overlay.classList.remove('show');
    
    // --- é—œéµä¿®æ­£ï¼šå‹™å¿…æ¢å¾© body çš„æ²å‹•å’Œé»æ“Šè¡Œç‚º ---
    document.body.style.overflow = ''; 
    
    setTimeout(() => {
        overlay.style.display = 'none';
    }, 300);
};
        
        window.toggleCollapse = (id) => {
    const body = document.getElementById(`body-${id}`);
    const arrow = document.getElementById(`arrow-${id}`);
    if (body) {
        // åˆ‡æ› classï¼Œè§¸ç™¼ CSS transition
        const isExpanded = body.classList.toggle('expanded');
        
        // ä¿®æ­£ï¼šå¦‚æœå…ƒç´ ä¸Šæœ‰å…§è¯æ¨£å¼ display:noneï¼Œå¿…é ˆç§»é™¤å®ƒ
        if (body.style.display === 'none') {
            body.style.display = ''; 
        }

        // æ—‹è½‰ç®­é ­ï¼šå±•é–‹æ™‚ 0åº¦ (â–¼)ï¼Œæ‘ºç–Šæ™‚ -90åº¦ (â–¶)
        if (arrow) {
            arrow.style.transform = isExpanded ? "rotate(0deg)" : "rotate(-90deg)";
        }
    }
};
		
		
		
    </script>

    <style>
        :root { --mtr-red: #c0392b; --mtr-blue: #2980b9; --mtr-green: #27ae60; --mtr-dark: #000000; --mtr-yellow: #f1c40f; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 20px; }
        
        .header { 
            position: sticky; top: 0; z-index: 101; 
            background: #ffffff; color: var(--mtr-dark); 
            padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        #adminStatus { font-size: 0.7em; margin-right: 5px; }
        #loginBtn { 
    background: var(--mtr-dark); 
    border: none; 
    color: white; 
    padding: 6px 12px; 
    border-radius: 6px; 
    font-size: 0.8em; 
    cursor: pointer; 
    /* Added for Profile Pic Alignment */
    display: flex; 
    align-items: center; 
    gap: 6px;
    min-height: 32px;
}

.user-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid rgba(255, 255, 255, 0.5);
}
        
        .tabs { display: flex; background: white; border-bottom: 2px solid #ddd; position: sticky; top: 60px; z-index: 100; overflow-x: auto; }
/* 1. é¸å–®å®¹å™¨ï¼šä¿æŒä¸è®Š */
.tab-menu {
    display: flex;
    background: #f1f3f5;
    border-radius: 10px;
    padding: 3px;
    gap: 4px;
    border: 1.5px solid #e2e8f0;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.02);
    /* ç¢ºä¿å®¹å™¨é«˜åº¦ç”± padding å’Œå…§å®¹æ±ºå®š */
    align-items: stretch; 
}

/* 2. é¸å–®æŒ‰éˆ•ï¼šé è¨­åŠ å…¥ã€Œé€æ˜é‚Šæ¡†ã€ä½”ä½ */
.tab-btn {
    flex: 1;
    min-width: 60px;
    padding: 15px 5px;      /* åš´æ ¼ä¿ç•™æ‚¨çš„é«˜åº¦å±¬æ€§ */
    cursor: pointer;
    white-space: nowrap;
    font-size: 0.85em;
    font-weight: 800;
    line-height: 1;

    background: transparent; 
    
    /* é—œéµå„ªåŒ–ï¼šé è¨­å°±çµ¦äºˆ 1.5px çš„é€æ˜é‚Šæ¡†ï¼Œåˆ‡æ›æ™‚å°±ä¸æœƒæ”¹è®Šé«˜åº¦ */
    border: 1.5px solid transparent; 
    border-radius: 6px;
    color: #94a3b8;
    
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative; 
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    box-sizing: border-box; /* å¿…é ˆåŒ…å« border åœ¨å…§ */
}

/* 3. æ´»å‹•ç‹€æ…‹ (Active)ï¼šåªæ”¹è®Šé‚Šæ¡†é¡è‰²ï¼Œä¸æ”¹è®Šåšåº¦ */
.tab-btn.active {
    color: var(--mtr-dark); 
    background: #ffffff;
    
    /* é¡è‰²æ”¹ç‚ºé¡¯è‘—çš„æ·ºç°è‰²ï¼Œåšåº¦ç¶­æŒ 1.5px ä¸å‹• */
    border-color: rgba(0, 0, 0, 0.08); 
    
    box-shadow: 
        0 1px 2px rgba(0, 0, 0, 0.05),   
        0 4px 10px rgba(0, 0, 0, 0.08);  
}

/* 4. ä¿®æ”¹é»‘é‚Šï¼šä¿æŒåŸæ¨£ */
.tab-btn::after {
    content: "";
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%) scaleX(0);
    width: 18px;
    height: 2px;
    background-color: var(--mtr-dark);
    border-radius: 10px;
    transition: transform 0.2s ease;
}

.tab-btn.active::after {
    transform: translateX(-50%) scaleX(1);
}

/* æ‡¸åœæ•ˆæœ */
.tab-btn:hover:not(.active) {
    background: rgba(255, 255, 255, 0.5);
    color: #64748b;
}
        
        .container { max-width: 600px; margin: auto; padding: 10px; }
        .search-bar { background: white; padding: 10px; border-radius: 10px; margin-bottom: 10px; display: flex; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .search-bar input, .search-bar select { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white; }
        
        .timeline-card { background: white; border-radius: 12px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.08); border-left: 6px solid var(--mtr-dark); }
        .timeline-header { padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .timeline-header:hover { background: #f0f2f5; }
        .collapse-arrow { font-size: 0.7em; color: #999; transition: transform 0.3s; display: inline-block; transform: rotate(-90deg); }
        .special-badge-area { padding: 8px 15px; background: #fffdf0; border-bottom: 1px solid #ffe58f; }
        .special-desc-item { font-size: 0.85em; color: #856404; font-weight: 500; }
        .car-group-title { font-weight: bold; font-size: 1.1em; font-family: "Helvetica Neue", Arial, sans-serif; }
        .timeline-body { border-top: 1px dashed #eee; }
        
.trace-item { 
    padding: 8px 0; 
    border-left: 2px solid #ddd; 
    margin-left: 6px; /* èª¿æ•´æ­¤è™•ä»¥å‚ç›´å°é½Šç®­é ­ä¸­å¿ƒ */
    padding-left: 15px; 
    position: relative; 
}
.trace-item::before { 
    content: ""; 
    width: 8px; 
    height: 8px; 
    background: #bbb; 
    border-radius: 50%; 
    position: absolute; 
    left: -5px; /* ä½¿åœ“é»ä¸­å¿ƒè½åœ¨ border-left ä¸Š */
    top: 15px; 
}
.trace-item.latest { 
    border-left-color: var(--mtr-green); 
}
.trace-item.latest::before { 
    background: var(--mtr-green); 
}
        
        .route-badge { padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.85em; font-weight: bold; white-space: nowrap; }
        .run-no-badge { background: none; color: #999; padding: 1px 5px; border: 1px solid #999; border-radius: 4px; font-family: monospace; font-size: 0.85em; margin-right: 5px; font-weight: bold; display: inline-block; line-height: 1.2;}
        .page { display: none; } .page.active { display: block; }
        
/* 1. å¤–éƒ¨å®¹å™¨ï¼šè² è²¬å…¨å¯¬èƒŒæ™¯ï¼Œä¸¦å¾®èª¿åº•éƒ¨è·é›¢ */
#detailOverlay {
    position: fixed;
    top: 105px;    /* ä¿æŒé«˜åº¦ï¼Œä¸æ“‹ä½ Header/Tabs */
    bottom: 0;     /* å¦‚æœæƒ³è®“å®ƒçœ‹èµ·ä¾†æ²’é‚£éº¼é«˜ï¼Œå¯æ”¹ç‚º bottom: 10px; */
    left: 0;
    right: 0;
    width: 100%;
    
    background: #f0f2f5;
    
    display: none; 
    flex-direction: column;
    align-items: center; 
    
    overflow: hidden;
    margin: 0;
    
    /* å¢åŠ ä¸€é»é»é ‚éƒ¨åœ“è§’ï¼Œå¯ä»¥è®“å®ƒçœ‹èµ·ä¾†ä¸é‚£éº¼ç”Ÿç¡¬ï¼Œæ¸›å°‘è¦–è¦ºé«˜åº¦æ„Ÿ */
    border-top: 1px solid #ddd;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
}

/* 2. å…§éƒ¨æ¨™é¡Œæ¬„ï¼šé™åˆ¶ 600px */
.detail-header-sticky {
    width: 100%;
    max-width: 600px;
    flex-shrink: 0; 
    background: #f0f2f5; 
    padding: 15px;
    box-sizing: border-box;
    
    border-bottom: 1px solid #ddd; 
    border-left: 1px solid #ddd;
    border-right: 1px solid #ddd;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* 3. å…§éƒ¨åˆ—è¡¨å…§å®¹ï¼šé™åˆ¶ 600px */
#detailList {
    width: 100%;
    max-width: 600px;
    flex-grow: 1; 
    overflow-y: auto; 
    padding: 15px; 
    padding-bottom: 40px; /* å¢åŠ åº•éƒ¨å…§é‚Šè·ï¼Œè®“å…§å®¹æ»¾å‹•æ™‚ä¸æœƒå¤ªä¾·ä¿ƒ */
    box-sizing: border-box;
    -webkit-overflow-scrolling: touch;
    
    background: #f0f2f5; 
    
    border-left: 1px solid #ddd;
    border-right: 1px solid #ddd;
}

/* ç¢ºä¿å…§éƒ¨å…ƒç´ è¨ˆç®—æ­£ç¢º */
#detailOverlay * {
    box-sizing: border-box;
}

        .car-link { cursor: pointer; margin: 0 2px;}
        .del-btn { color: #e74c3c; font-size: 0.8em; cursor: pointer; margin-left: 10px; border: 1px solid #e74c3c; padding: 1px 4px; border-radius: 4px; }
        
        .report-form { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .form-group { flex: 1; display: flex; flex-direction: column; position: relative; }
        label { font-size: 0.75em; color: #666; margin-bottom: 4px; font-weight: bold; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; font-family: inherit; }
        textarea { resize: vertical; min-height: 60px; }
        
        .section-title { font-size: 0.9em; color: #333; margin: 20px 0 10px 5px; font-weight: bold; border-left: 4px solid var(--mtr-yellow); padding-left: 10px; }
        
        .eta-platform-group { background: white; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .eta-platform-label { background: #f8f9fa; padding: 4px 10px; font-size: 0.75em; font-weight: bold; color: #666; border-bottom: 1px solid #eee; }
        .eta-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #f9f9f9; }
        .eta-row:last-child { border-bottom: none; }
        .eta-info-left { display: flex; align-items: center; gap: 6px; flex: 1; overflow: hidden; }
        .eta-dest-container { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; overflow: hidden; margin-right: 10px; }
        .eta-dest-text { font-weight: 600; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .eta-train-length { font-size: 0.8em; color: #666; margin-left: 8px; flex-shrink: 0; font-weight: bold; }
        .eta-time-text { font-weight: bold; color: #333; font-size: 1em; white-space: nowrap; min-width: 45px; text-align: right; }
        .eta-time-text.approaching { color: var(--mtr-green); }
		
		
/* è®“ç›£å¯Ÿåˆ—è¡¨å…§çš„å¡ç‰‡é–“è·æ›´æ¸…æ™°ï¼Œæ–¹ä¾¿æ“ä½œ */
#favListOnMain .comp-card {
    margin-bottom: 10px;
    border: 1px solid transparent;
}


/* å±•é–‹å‹•ç•«ç›¸é—œ */
.timeline-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding 0.3s ease;
    display: block !important; 
    padding-top: 0;
    padding-bottom: 0;
    margin: 0; /* ç¢ºä¿æ²’æœ‰é‚Šè·æ’é–‹é–“éš™ */
}

.timeline-body.expanded {
    max-height: 800px; /* å¢åŠ æ•¸å€¼ä»¥å®¹ç´å…§å®¹ */
    padding-top: 10px;
    padding-bottom: 10px;
    border-top: 1px dashed #eee; /* ç§»å‹•é‚Šæ¡†åˆ°é€™è£¡ï¼Œæ‘ºç–Šæ™‚å°±ä¸æœƒçœ‹åˆ°ç·š */
}

/* æ­·å²é é¢/å´æ¬„é€²å…¥å‹•ç•« */
#detailOverlay {
    /* ç¢ºä¿åŸæœ¬çš„ display æ§åˆ¶é‚è¼¯ä¸è®Šï¼Œä½†åŠ å…¥å‹•ç•«é¡åˆ¥ */
    transform: translateY(20px);
    opacity: 0;
    transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    pointer-events: none;
}

#detailOverlay.show {
    display: flex !important;
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
}

.page {
    display: none;
    animation: fadeIn 0.25s ease;
}

.page.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(6px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* é é¢åˆ‡æ›å‹•ç•«æ¨£å¼ */
.tab-content {
    display: none;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.tab-content.active {
    display: block;
    /* é€™è£¡ä½¿ç”¨å»¶é²ç¢ºä¿ display: block ç”Ÿæ•ˆå¾Œå†è§¸ç™¼å‹•ç•« */
}

/* ç”¨æ–¼è§¸ç™¼æ·¡å…¥æ•ˆæœçš„é¡å */
.tab-content.fade-in {
    opacity: 1;
    transform: translateY(0);
}

/* åˆ°ç«™åˆ†é å®¹å™¨å„ªåŒ– */
#etaListArea {
    padding: 5px;
}

.eta-platform-group {
    margin-bottom: 10px; /* ç¸®æ¸›å¹³å°çµ„ä¹‹é–“çš„é–“è· */
    border-radius: 10px;
    overflow: hidden;
}

.eta-platform-label {
    padding: 3px 12px; /* ç¸®æ¸›å¹³å°æ¨™é¡Œé«˜åº¦ */
    background: #f1f3f5;
    color: #495057;
    font-size: 0.75em;
    letter-spacing: 0.5px;
}

.eta-dest-container {
    display: flex;
    align-items: baseline; /* è®“ 1å¡/2å¡ æ¨™ç±¤å°é½Šç›®çš„åœ°åº•éƒ¨ */
    gap: 2px;
}

.eta-time-text {
    font-weight: 800;
}

.eta-time-text.approaching {
    animation: pulse-green 1.5s infinite;
}

/* 4. ã€ŒæŸ¥çœ‹æ›´å¤šã€æŒ‰éˆ•æ¨£å¼ */
.eta-more-btn {
    width: 100%;
    padding: 10px;
    background: #f8f9fa;
    border: none;
    border-top: 1px solid #eee;
    color: #2980b9;
    font-size: 0.85em;
    font-weight: bold;
    cursor: pointer;
}

@keyframes pulse-green {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* åˆ—è¡¨æ•´é«”çš„æ·¡å…¥å‹•ç•« */
@keyframes fadeInScale {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

.eta-platform-group {
    animation: fadeInScale 0.4s ease-out forwards;
}

/* å…§å®¹æ›´æ–°æ™‚çš„éæ¸¡é¡åˆ¥ */
#etaList {
    transition: opacity 0.3s ease;
}

/* --- å„ªåŒ–å¾Œçš„ ETA è¼‰å…¥èˆ‡é€²å…¥å‹•ç•« --- */

/* 1. å…¨åŸŸæ›´æ–°ç‹€æ…‹ï¼šä¸å†åªæ˜¯è®Šé€æ˜ï¼Œè€Œæ˜¯åŠ å…¥å¾®å¼±çš„è„ˆè¡æ„Ÿ */
#etaList.updating {
    pointer-events: none; /* é˜²æ­¢æ›´æ–°æ™‚é‡è¤‡é»æ“Š */
}

#etaList.updating .eta-row {
    position: relative;
    overflow: hidden;
}

/* 2. éª¨æ¶å±é–ƒçˆæ•ˆæœï¼šåœ¨ç¾æœ‰å…§å®¹ä¸Šç–ŠåŠ ä¸€é“å…‰å½± */
#etaList.updating .eta-row::after {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(90deg, 
        rgba(255,255,255,0) 0%, 
        rgba(255,255,255,0.6) 50%, 
        rgba(255,255,255,0) 100%);
    background-size: 200% 100%;
    animation: skeletonShimmer 1.5s infinite;
}

@keyframes skeletonShimmer {
    0% { background-position: -150% 0; }
    100% { background-position: 150% 0; }
}

/* 3. æ”¹é€²å¾Œçš„é€²å…¥å‹•ç•«ï¼šæ›´æµæš¢çš„å½ˆæ€§ä½ç§» (GPU åŠ é€Ÿ) */
@keyframes etaSlideIn {
    from { 
        opacity: 0; 
        transform: translate3d(0, 20px, 0) scale(0.98); 
    }
    to { 
        opacity: 1; 
        transform: translate3d(0, 0, 0) scale(1); 
    }
}

/* é è¨­æ›´æ–°å‹•ç•« (åƒ…æ·¡å…¥ï¼Œé¿å…å¹²æ“¾é–±è®€) */
@keyframes etaFadeSimple {
    from { opacity: 0.4; }
    to { opacity: 1; }
}

/* å¹³å°çµ„åŸºç¤æ¨£å¼ */
.eta-platform-group {
    will-change: transform, opacity;
    animation: etaFadeSimple 0.3s ease-out both;
}

/* æ‰‹å‹•åˆ‡æ›è»Šç«™æ™‚çš„å¼·çƒˆå‹•ç•«æ„Ÿ */
.entrance-anim .eta-platform-group {
    animation: etaSlideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
}

/* éšæ¢¯å¼å»¶é²ï¼šè®“æœˆå°ä¸€å€‹æ¥ä¸€å€‹å½ˆå‡º */
.entrance-anim .eta-platform-group:nth-child(1) { animation-delay: 0.05s; }
.entrance-anim .eta-platform-group:nth-child(2) { animation-delay: 0.12s; }
.entrance-anim .eta-platform-group:nth-child(3) { animation-delay: 0.18s; }
.entrance-anim .eta-platform-group:nth-child(n+4) { animation-delay: 0.24s; }

/* é–ƒçˆå‹•ç•«å„ªåŒ– (æ›´æŸ”å’Œ) */
.approaching {
    animation: etaBlink 1.4s ease-in-out infinite;
}

@keyframes etaBlink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}


/* é¸å–®å‡èµ·å‹•ç•« */
@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

/* é¸å–®èƒŒæ™¯æ·¡å…¥ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.action-sheet-overlay {
    animation: fadeIn 0.2s ease-out;
}

.action-sheet-content {
    animation: slideUp 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
}


/* ç§»é™¤æˆ–è¦†è“‹åŸæœ¬çš„ .timeline-body { display: none; } */
.timeline-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out, opacity 0.3s ease, padding 0.3s ease;
    opacity: 0;
    padding: 0 15px; /* æ‘ºç–Šæ™‚ä¸ä½”ç©ºé–“ */
}

/* ç•¶æœ‰ .expanded é¡åæ™‚å±•é–‹ */
.timeline-body.expanded {
    max-height: 2000px; /* çµ¦äºˆä¸€å€‹å¤§æ–¼å…§å®¹çš„æ•¸å€¼ */
    opacity: 1;
    padding: 10px 15px; /* å±•é–‹å¾Œçš„é–“è· */
}

/* ä¿®æ­£ç®­é ­çš„åˆå§‹ç‹€æ…‹èˆ‡æ—‹è½‰å‹•ç•« */
.collapse-arrow {
    display: inline-block;
    transition: transform 0.3s ease;
    transform: rotate(-90deg); /* é è¨­æŒ‡å‘å·¦æ–¹ (æ‘ºç–Š) */
}
}

/* ETA extra rows animation */
.eta-row.extra-row {
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transform: translateY(-4px);
    transition:
        max-height 0.35s ease,
        opacity 0.25s ease,
        transform 0.25s ease;
}

/* Expanded state */
.eta-row.extra-row.show {
    max-height: 60px; /* enough for one row */
    opacity: 1;
    transform: translateY(0);
}

/* ETA æ‘ºç–Šå®¹å™¨åˆå§‹ç‹€æ…‹ */
.eta-extra-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    background: #fafafa;
}

/* å±•é–‹ç‹€æ…‹ */
.eta-extra-container.expanded {
    max-height: 500px; /* è¶³ä»¥å®¹ç´å…§å®¹çš„é«˜åº¦ */
    border-top: 1px solid #eee;
}

/* æŒ‰éˆ•æ–‡å­—æ—‹è½‰æ•ˆæœ (å¯é¸) */
.eta-more-btn {
    transition: background 0.2s;
}
.eta-more-btn[data-expanded="true"] {
    background: #f0f7ff !important;
}


/* çµ±ä¸€æ‰€æœ‰è¼¸å…¥æ¡†çš„é«˜åº¦ã€é‚Šè·èˆ‡ç›’å­æ¨¡å‹ */
.form-group input[type="text"], 
.form-group input[type="number"],
.form-group select {
    width: 100%;
    height: 42px; /* å›ºå®šé«˜åº¦ç¢ºä¿å°é½Š */
    padding: 8px 12px; /* çµ±ä¸€å…§é‚Šè· */
    font-size: 16px; /* çµ±ä¸€å­—é«”å¤§å°ï¼Œé¿å…æ‰‹æ©Ÿè‡ªå‹•ç¸®æ”¾ */
    border: 1px solid #ddd;
    border-radius: 8px;
    box-sizing: border-box; /* é—œéµï¼šç¢ºä¿ padding ä¸æœƒæ’é–‹å¯¬åº¦ */
    appearance: none; /* ç§»é™¤ç€è¦½å™¨é è¨­æ¨£å¼ */
    -webkit-appearance: none;
}

/* ä¿®æ­£æ•¸å­—è¼¸å…¥æ¡†åœ¨ Chrome/Safari çš„é¡å¤–é«˜åº¦ */
input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button { 
    margin: 0; 
}


.toast-msg {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: #333;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    transition: transform 0.3s ease;
    font-size: 0.95em;
}
.toast-msg.show {
    transform: translateX(-50%) translateY(0);
}


/* ä¿®æ”¹å¾Œçš„å‹•ç•«å®šç¾© */
@keyframes cardEntrance {
    from {
        opacity: 0;
        /* ä½¿ç”¨ translate3d å¼·åˆ¶å•Ÿå‹• GPU åŠ é€Ÿ */
        transform: translate3d(0, 10px, 0);
    }
    to {
        opacity: 1;
        transform: translate3d(0, 0, 0);
    }
}

.timeline-card {
    /* ä½¿ç”¨ ease-out æˆ– cubic-bezier æœƒæ¯” linear æ›´è‡ªç„¶ */
    animation: cardEntrance 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    will-change: transform, opacity;
    /* ç¢ºä¿åˆå§‹ç‹€æ…‹æ˜¯é€æ˜çš„ï¼Œé¿å…å‹•ç•«å‰é–ƒçˆ */
    backface-visibility: hidden;
}

/* æ”¹é€²äº¤éŒ¯å‹•ç•« (Staggered Animation) çš„é–“éš”ï¼Œç¸®çŸ­å»¶é²è®“æ„Ÿè¦ºæ›´æµæš¢ */
.timeline-card:nth-child(1) { animation-delay: 0.03s; }
.timeline-card:nth-child(2) { animation-delay: 0.06s; }
.timeline-card:nth-child(3) { animation-delay: 0.09s; }
.timeline-card:nth-child(4) { animation-delay: 0.12s; }
.timeline-card:nth-child(n+5) { animation-delay: 0.15s; }


/* ETA é€²å…¥å‹•ç•«å®šç¾© */
@keyframes etaEntrance {
    from {
        opacity: 0;
        transform: translate3d(0, 10px, 0); /* ä½¿ç”¨ 3D åŠ é€Ÿæå‡æµæš¢åº¦ */
    }
    to {
        opacity: 1;
        transform: translate3d(0, 0, 0);
    }
}

/* å¥—ç”¨åˆ° ETA å¹³å°çµ„å®¹å™¨ */
.eta-platform-group {
    animation: etaEntrance 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    will-change: transform, opacity;
    backface-visibility: hidden;
}

/* å¢åŠ äº¤éŒ¯å‹•ç•«æ•ˆæœ (Staggered Animation)ï¼Œè®“åˆ—è¡¨åƒæ‰‡å­ä¸€æ¨£å±•é–‹ */
.eta-platform-group:nth-child(1) { animation-delay: 0.03s; }
.eta-platform-group:nth-child(2) { animation-delay: 0.06s; }
.eta-platform-group:nth-child(3) { animation-delay: 0.09s; }
.eta-platform-group:nth-child(4) { animation-delay: 0.12s; }
.eta-platform-group:nth-child(n+5) { animation-delay: 0.15s; }

/* å„ªåŒ–æ›´æ–°æ™‚çš„é€æ˜åº¦éæ¸¡ï¼Œé¿å…ç”Ÿç¡¬çš„é–ƒçˆ */
#etaList {
    transition: opacity 0.2s ease;
}
#etaList.updating {
    opacity: 0.4;
}


/* --- ETA å‹•ç•«é‚è¼¯ --- */

/* 1. æ»‘å…¥å‹•ç•« (ç”¨æ–¼åˆæ¬¡é€²å…¥æˆ–åˆ‡æ›è»Šç«™) */
@keyframes etaSlideIn {
    from { 
        opacity: 0; 
        transform: translate3d(0, 15px, 0); 
    }
    to { 
        opacity: 1; 
        transform: translate3d(0, 0, 0); 
    }
}

/* 2. ç°¡å–®æ·¡å…¥å‹•ç•« (ç”¨æ–¼å®šæ™‚æ•¸æ“šæ›´æ–°) */
@keyframes etaFadeSimple {
    from { opacity: 0.5; }
    to { opacity: 1; }
}

/* æ»‘å…¥å‹•ç•«ï¼šç”¨æ–¼åˆ‡æ›è»Šç«™æˆ–åˆ†é  */
@keyframes etaSlideIn {
    from { 
        opacity: 0; 
        transform: translate3d(0, 15px, 0); 
    }
    to { 
        opacity: 1; 
        transform: translate3d(0, 0, 0); 
    }
}

/* é è¨­ï¼šæ‰€æœ‰å¹³å°çµ„ä½¿ç”¨ç°¡å–®æ·¡å…¥ */
.eta-platform-group {
    animation: etaFadeSimple 0.4s ease-out both;
}

/* æ‰‹å‹•åˆ‡æ›æ¨¡å¼ï¼šå•Ÿç”¨æ»‘å…¥èˆ‡éšæ¢¯å¼å»¶é² */
.entrance-anim .eta-platform-group {
    animation: etaSlideIn 0.45s cubic-bezier(0.23, 1, 0.32, 1) both;
}

/* éšæ¢¯å¼å»¶é² (åƒ…åœ¨ entrance-anim ä¸‹ç”Ÿæ•ˆ) */
.entrance-anim .eta-platform-group:nth-child(1) { animation-delay: 0.02s; }
.entrance-anim .eta-platform-group:nth-child(2) { animation-delay: 0.05s; }
.entrance-anim .eta-platform-group:nth-child(3) { animation-delay: 0.08s; }
.entrance-anim .eta-platform-group:nth-child(n+4) { animation-delay: 0.11s; }

/* æ•¸æ“šæ›´æ–°ä¸­çš„ç‹€æ…‹ */
#etaList.updating {
    opacity: 0.6;
}


/* æ›æœˆå‹•ç•« */
@keyframes monthSlideIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}

.month-anim-active {
    animation: monthSlideIn 0.3s ease-out forwards;
}

/* é¸ä¸­æ¡†å‹•ç•«ï¼šç¢ºä¿åˆ‡æ›æ—¥æœŸæ™‚ï¼ŒèƒŒæ™¯å’Œé‚Šæ¡†æ˜¯ã€Œæ»‘ã€éå»çš„æ„Ÿè¦º */
.day-item {
    transition: background 0.25s ease-out, 
                border-color 0.25s ease-out, 
                box-shadow 0.25s ease-out, 
                color 0.2s ease;
    will-change: background, border-color; /* æ•ˆèƒ½å„ªåŒ– */
}

/* éª¨æ¶å±åŸºç¤æ¨£å¼ */
.skeleton-row {
    height: 60px;
    background: #f2f2f2;
    margin-bottom: 12px;
    border-radius: 12px;
    position: relative;
    overflow: hidden;
}

/* å‘¼å¸ç‡ˆå‹•ç•« */
.skeleton-row::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
    animation: skeleton-loading 1.5s infinite;
}

@keyframes skeleton-loading {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.skeleton-platform-label {
    width: 80px;
    height: 15px;
    background: #e0e0e0;
    margin-bottom: 8px;
    border-radius: 4px;
}

/* --- æ•´åˆå¾Œçš„ ETA å‹•ç•«é«”ç³» --- */

/* 1. åŸºç¤ç‹€æ…‹ */
#etaList { transition: opacity 0.3s ease; }

/* 2. å‹•ç•«å®šç¾© */
/* éª¨æ¶/æ»‘å‹•å‹•ç•«ï¼šç”¨æ–¼åˆ‡æ›è»Šç«™ (å¼·çƒˆæ„Ÿ) */
@keyframes etaSkeletonEntrance {
    from { 
        opacity: 0; 
        transform: translate3d(0, 15px, 0); 
    }
    to { 
        opacity: 1; 
        transform: translate3d(0, 0, 0); 
    }
}

/* æŸ”å’Œæ·¡å…¥å‹•ç•«ï¼šç”¨æ–¼æ•¸æ“šåˆ·æ–° (å¹³æ»‘æ„Ÿ) */
@keyframes etaDataRefresh {
    from { opacity: 0.5; }
    to { opacity: 1; }
}

/* 3. æ‡‰ç”¨é‚è¼¯ */
/* é è¨­ï¼šè‡ªå‹•æ›´æ–°æ•¸æ“šæ™‚ï¼Œåƒ…å¥—ç”¨æ·¡å…¥æ•ˆæœ */
.eta-platform-group {
    animation: etaDataRefresh 0.4s ease-out both;
}

/* ç•¶ #etaList æ“æœ‰ .entrance-anim é¡åˆ¥æ™‚ï¼ˆåˆ‡æ›è»Šç«™ï¼‰ï¼Œæ”¹ç”¨éª¨æ¶æ»‘å‹•å‹•ç•« */
.entrance-anim .eta-platform-group {
    animation: etaSkeletonEntrance 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
}

/* éª¨æ¶å‹•ç•«å°ˆç”¨çš„éšæ¢¯å¼å»¶é² (åƒ…åœ¨åˆ‡æ›è»Šç«™æ™‚å‡ºç¾) */
.entrance-anim .eta-platform-group:nth-child(1) { animation-delay: 0.02s; }
.entrance-anim .eta-platform-group:nth-child(2) { animation-delay: 0.06s; }
.entrance-anim .eta-platform-group:nth-child(3) { animation-delay: 0.10s; }
.entrance-anim .eta-platform-group:nth-child(n+4) { animation-delay: 0.14s; }

    </style>
	
<link rel="manifest" href="manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="LRSpotter">
<link rel="apple-touch-icon" href="icon-192.png">

<meta name="theme-color" content="#007aff">	
	
</head>

<body>

<header style="position: sticky; top: 0; z-index: 100; background: #fff; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; align-items: center; gap: 8px;">
        <h1 style="margin: 0; font-size: 1.5em; color: #333;">ğŸšˆ LRSpotter</h1>
        </div>
    <div id="authArea">
        <button id="loginBtn" style="padding: 4px 12px; background: transparent; color: #666; border: 1px solid #e0e0e0; border-radius: 15px; font-weight: 500; font-size: 0.85em; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s ease;padding: 4px 12px 4px 4px; background: transparent; color: rgb(102, 102, 102); border: 1px solid rgb(224, 224, 224); border-radius: 15px; font-weight: 500; font-size: 0.85em; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">ç™»å…¥</button>
    </div>
</header>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('mainPage', this)">æäº¤å ±å‘Š</button>
    <button class="tab-btn" onclick="switchTab('livePage', this)">è¡Œè¹¤æœå°‹</button>
    <button class="tab-btn" onclick="switchTab('flashPage', this)">ä»ŠæœŸé–ƒå¡</button>
    <button class="tab-btn" onclick="switchTab('etaPage', this); updateETAList();">åˆ°ç«™æ™‚é–“</button>
</div>
<div class="container">
    <div id="mainPage" class="page active">
		<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85em; border: 1px solid #ffeeba;">
            âš ï¸ ç³»çµ±æ¸¬è©¦ä¸­ï¼Œå¦‚æœ‰å•é¡Œè«‹è¯çµ¡é–‹ç™¼äººå“¡ï¼Œæ•¬è«‹è¦‹è«’ã€‚
        </div>
<div class="report-form" style="display: flex; flex-direction: column; width: 100%; box-sizing: border-box;">
    <div class="form-row" style="display: flex; gap: 6px; width: 100%;">
        <div class="form-group" style="flex: 6.5; display: flex; flex-direction: column; ">
            <label style="font-weight: bold; color: #555;">è»Šç·¨</label>
            <input type="text" id="carId" placeholder="1001-1006" 
                   style="width: 100%; height: 40px; padding: 0 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; box-sizing: border-box; background: white;">
        </div>
        <div class="form-group" style="flex: 3.5; display: flex; flex-direction: column; position: relative;">
            <label style="font-weight: bold; color: #555;">è»Šåº</label>
            <input type="text" id="runNo" placeholder="193" oninput="checkRunNo()" 
                   style="width: 100%; height: 40px; padding: 0 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; box-sizing: border-box; background: white;">
            <div id="runSuggestion" style="position: absolute; top: 100%; left: 0; right: 0; background: #fffbe6; border: 1px solid #ffe58f; border-radius: 8px; padding: 10px; z-index: 50; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 4px;">
                <div id="suggestionText" style="font-size: 12px; color: #856404;"></div>
                <button id="applyBtn" style="background: #007aff; color: white; border: none; padding: 6px; border-radius: 4px; font-size: 12px; width: 100%; cursor: pointer; margin-top: 5px; font-weight: bold;">å¥—ç”¨</button>
            </div>
        </div>
    </div>

    <div class="form-row" style="display: flex; gap: 8px; width: 100%; align-items: flex-end; margin-top: 8px;">
        <div class="form-group" style="flex: 3; display: flex; flex-direction: column;">
            <label style="font-weight: bold; color: #555; margin-bottom: 4px;">è·¯ç¶«</label>
            <select id="routeSelect" onchange="onRouteUpdate()" 
                    style="width: 100%; height: 40px; padding: 0 8px; border: 1px solid #ddd; border-radius: 8px; background: white; outline: none; box-sizing: border-box;">
            </select>
        </div>
        <div class="form-group" style="flex: 4; display: flex; flex-direction: column;">
            <label style="font-weight: bold; color: #555; margin-bottom: 4px;">å¾€</label>
            <select id="directionSelect" onchange="checkSpecialDestination()" 
                    style="width: 100%; height: 40px; padding: 0 8px; border: 1px solid #ddd; border-radius: 8px; background: white; outline: none; box-sizing: border-box;">
            </select>
        </div>
        <div class="form-group" style="flex: 5; display: flex; flex-direction: column;">
            <div style="height: 20px; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between;">
                <label style="font-weight: bold; color: #555; margin: 0;">ä½ç½®</label>
                <span id="gpsBtn" onclick="useGPSLocation()" 
                      style="cursor: pointer; font-size: 13px; color: #007bff; display: flex; align-items: center; gap: 2px;">
                    <small id="gpsStatus">å®šä½</small>
                </span>
            </div>
            <select id="stationSelect" 
                    style="width: 100%; height: 40px; padding: 0 8px; border: 1px solid #ddd; border-radius: 8px; background: white; outline: none; box-sizing: border-box;">
            </select>
            <input type="hidden" id="geoCoords">
        </div>
    </div>

    <div class="form-row" style="display: flex; width: 100%; margin-top: 8px;">
    <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
        <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
            <label style="font-weight: bold; color: #555; white-space: nowrap;">å‚™è¨»</label>
            <div id="timetable-info" style="text-align: right; font-size: 12px; color: #888; flex: 1;">
                <span id="adminToggleBtn" onclick="toggleAdminTime()" style="display: none; cursor: pointer; margin-right: 10px; font-weight: bold;">è£œéŒ„æ¨¡å¼</span>
                <span id="timetable-display" style="color: #333;"></span>
            </div>
        </div>
        <input type="text" id="memo" placeholder="è»Šå‹™èª¿å‹•ã€ç‰¹åˆ¥ç­æ¬¡ã€æ”¹é“è¡Œé§›ç­‰" 
               style="width: 100%; height: 40px; padding: 0 10px; border: 1px solid #ddd; border-radius: 8px; outline: none; box-sizing: border-box; background: white;">
    </div>
</div>

<div id="adminTimeRow" style="
    max-height: 0; 
    opacity: 0; 
    overflow: hidden; 
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
    width: 100%; 
    box-sizing: border-box; 
    background: #f8f9fa; 
    border: 0px solid #ddd;
    border-radius: 8px; 
    margin-top: 0;">
    
    <div style="padding: 12px; display: flex; gap: 10px; width: 100%; box-sizing: border-box;">
        
        <div style="flex: 1; width: 0;">
            <input type="date" id="adminDate" 
                   style="width: 100%; height: 40px; padding: 0 8px; border: 1px solid #ddd; border-radius: 8px; outline: none; box-sizing: border-box; background: white; font-size: 14px;">
        </div>
        
        <div style="flex: 1; width: 0;">
            <input type="time" id="adminTime" step="1" value="12:00:00"
                   style="width: 100%; height: 40px; padding: 0 8px; border: 1px solid #ddd; border-radius: 8px; outline: none; box-sizing: border-box; background: white; font-size: 14px;">
        </div>

    </div>
</div>

    <button onclick="addReport()" 
            style="background: #52b05d; color: white; border: none; height: 40px; padding: 0; border-radius: 8px; width: 100%; font-weight: bold; font-size: 14px; margin-top: 5px; cursor: pointer; box-shadow: 0 4px 10px rgba(82, 176, 93, 0.25); display: flex; align-items: center; justify-content: center; box-sizing: border-box;">
        æäº¤
    </button>
</div>
	

    <div class="section-title">ç›£å¯Ÿåˆ—è¡¨</div>
    <div id="favListOnMain">
        <div class="timeline-indicator" style="background: #541B15;"></div>
        
    </div>
    </div>
	

<div id="livePage" class="page">
    <div class="search-bar" style="background: #fdfdfd; padding: 8px; border: 1px solid #eee; border-radius: 8px; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); width: 100%; box-sizing: border-box;">
        
<div style="display: flex; gap: 6px; width: 100%;">
<div style="flex: 3; min-width: 0; height: 40px; position: relative; overflow: visible;">
    <input type="date" id="searchDate" onchange="renderAll()" 
           style="position: absolute; top: 0; left: 0; width: 114.28%; height: 45.71px; border: 1.14px solid #ddd; border-radius: 9.14px; font-size: 16px; font-family: inherit; outline: none; box-sizing: border-box; background: white; color: #333; transform: scale(0.875); transform-origin: top left; -webkit-appearance: none; padding: 0 10px;">
</div>

<div style="flex: 5; min-width: 0; height: 40px; position: relative; overflow: visible;">
    <input type="text" id="searchComp" placeholder="1001-1006" 
           style="position: absolute; top: 0; left: 0; width: 114.28%; height: 45.71px; border: 1.14px solid #ddd; border-radius: 9.14px; font-size: 16px; font-family: inherit; outline: none; box-sizing: border-box; background: white; color: #333; transform: scale(0.875); transform-origin: top left; -webkit-appearance: none; padding: 0 40px 0 10px;">
    <span id="clearSearchComp" style="position: absolute; right: -8%; top: 50%; transform: translateY(-50%); cursor: pointer; color: #ccc; display: none; font-size: 20px; z-index: 10;">&times;</span>
</div>
        </div>

        <div style="display: flex; gap: 6px; width: 100%;">
            <select id="searchRoute" onchange="renderAll()" 
                    style="flex: 3; min-width: 0; height: 40px; padding: 0 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; background: white; outline: none; box-sizing: border-box; color: #333; -webkit-appearance: none;">
                <option value="" selected="selected">æ‰€æœ‰è·¯ç¶«</option>
            </select>
            
            <select id="sortOrder" onchange="renderAll()" 
                    style="flex: 3; min-width: 0; height: 40px; padding: 0 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; background: white; outline: none; box-sizing: border-box; color: #333; -webkit-appearance: none;">
                <option value="reportTime" selected="selected">æŒ‰å ±å‘Šæ™‚é–“</option>
                <option value="routeRun">æŒ‰è·¯ç¶«è»Šåº</option>
            </select>

            <button id="btnResetFilters" 
                    style="flex: 2; min-width: 0; height: 40px; padding: 0; background: #ffffff; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; color: #555; font-size: 14px; font-family: inherit; font-weight: bold; white-space: nowrap; box-sizing: border-box; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                é‡ç½®
            </button>
        
        </div>
    </div>
	        <div id="masterList">
                <div class="timeline-card" style="border-left-color:#F2858E; ">
                </div>
        </div>
</div>

    <div id="flashPage" class="page">
        <div class="search-bar">
            <input type="date" id="flashDate" onchange="renderAll()" 
       style="width: 100%; height: 35px; padding: 0 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; outline: none; box-sizing: border-box; background: white; color: #333;">
        </div>
        <div id="flashList"></div>
    </div>

<div id="etaPage" class="page">
    <div class="search-bar" style="background: #fdfdfd; padding: 6px 8px; border: 1px solid #eee; border-radius: 8px; display: flex; flex-direction: column; gap: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); width: 100%; box-sizing: border-box;">
        
        <div style="display: flex; gap: 5px; width: 100%; align-items: center;">

            <div style="flex: 1.2; min-width: 0; height: 38px; position: relative;">
                <input type="text" id="etaStationInput" 
                       oninput="syncETAList('input')" value="1"
                       style="position: absolute; top: 0; left: 0; width: 114.28%; height: 43.43px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline: none; box-sizing: border-box; background: white; color: #333; text-align: center; transform: scale(0.875); transform-origin: top left; -webkit-appearance: none;">
            </div>

            <select id="etaStationSelect" onchange="syncETAList('select')" 
                    style="flex: 5; min-width: 0; height: 38px; padding: 0 6px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: white; outline: none; box-sizing: border-box; color: #333; -webkit-appearance: none;">
            </select>
            
            <button type="button" id="etaGpsBtn" onclick="window.useETAGPSLocation()" 
                    style="flex: 1.5; height: 38px; background: #fff; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; color: #555; box-sizing: border-box; padding: 0 4px; white-space: nowrap;">
                å®šä½
            </button>

            <button onclick="updateETAList()" 
                    style="flex: 1.5; height: 38px; background: #fff; border: 1px solid #ddd; border-radius: 8px; color: #555; font-size: 13px; font-weight: bold; white-space: nowrap; box-sizing: border-box; padding: 0 4px;">
                æ›´æ–°
            </button>
        </div>
    </div>
    <div id="etaList"></div>
	</div> <div id="detailOverlay">
    <div class="detail-header-sticky">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="detailTitle" style="margin:0; font-size: 1.2em;">è¨˜éŒ„è©³æƒ…</h2>
            <button onclick="closeDetail()" style="padding:8px 16px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer;">è¿”å›</button>
        </div>
    </div>
    <div id="detailList"></div>
</div>

<script>
window.cachedUserCoords = null;

// --- æ•ˆèƒ½å„ªåŒ–ï¼šæ—¥æœŸå¿«å– ---
const dateCache = new Map();
window.getOperationalDate = (timestamp) => {
    if (!timestamp) return "";
    const cacheKey = Math.floor(timestamp / 60000); // ä»¥åˆ†é˜ç‚ºå–®ä½åšå¿«å–
    if (dateCache.has(cacheKey)) return dateCache.get(cacheKey);

    const date = new Date(timestamp);
    if (date.getHours() < 4) date.setDate(date.getDate() - 1);
    const result = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    
    dateCache.set(cacheKey, result);
    if (dateCache.size > 1000) dateCache.delete(dateCache.keys().next().value);
    return result;
};

// --- æ•ˆèƒ½å„ªåŒ–ï¼šDebounce å‡½å¼ ---
function debounce(func, delay) {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => func(...args), delay);
    };
}

// åŒ…è£åŸæœ¬çš„ renderAll
window.debouncedRenderAll = debounce(() => {
    if (typeof window.renderAll === 'function') window.renderAll();
}, 300);


const routeCfg = { "505": ["ä¸‰è–", "å…†åº·"], "506P": ["å…†åº·"], "507": ["ç”°æ™¯", "å±¯é–€ç¢¼é ­"], "507P": ["å±¯é–€ç¢¼é ­"], "610": ["å…ƒæœ—", "å±¯é–€ç¢¼é ­"], "614": ["å…ƒæœ—", "å±¯é–€ç¢¼é ­"], "614P": ["å…†åº·", "å±¯é–€ç¢¼é ­"], "615": ["å…ƒæœ—", "å±¯é–€ç¢¼é ­"], "615P": ["å…†åº·", "å±¯é–€ç¢¼é ­"], "705": ["å¤©æ°´åœå¾ªç’°ç¶«", "ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™"], "706": ["å¤©æ°´åœå¾ªç’°ç¶«", "ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™"], "720": ["å¤©æ¦®"], "751": ["å‹æ„›", "å¤©é€¸"], "751P": ["å¤©æ°´åœ", "å¤©é€¸"], "751L": ["å±¯é–€ç¢¼é ­"], "761P": ["å…ƒæœ—", "å¤©é€¸"], "ä¸è¼‰å®¢": ["ä¸‰è–", "å±¯é–€ç¢¼é ­", "ç”°æ™¯", "å…†åº·", "å…ƒæœ—", "å‹æ„›", "å¤©é€¸", "å¤©æ¦®", "å¤©æ°´åœ",  "å±¯é–€è»Šå» ", "æ´ªå¤©è·¯", "---"], "å¸æ©Ÿè¨“ç·´": ["ä¸‰è–", "å±¯é–€ç¢¼é ­", "ç”°æ™¯", "å…†åº·", "å…ƒæœ—", "å‹æ„›", "å¤©é€¸", "å¤©æ¦®", "å¤©æ°´åœ",  "å±¯é–€è»Šå» ", "æ´ªå¤©è·¯", "---"], "å›å» ": ["---"], "å°ˆç”¨": ["ä¸‰è–", "å±¯é–€ç¢¼é ­", "ç”°æ™¯", "å…†åº·", "å…ƒæœ—", "å‹æ„›", "å¤©é€¸", "å¤©æ¦®", "å¤©æ°´åœ", "å±¯é–€è»Šå» ", "æ´ªå¤©è·¯", "---"], "å±¯é–€å°ˆç¶«": ["å±¯é–€"], "å…ƒæœ—å°ˆç¶«": ["å¤©é€¸"] };
const colorMap = { "505":"#D92329", "506P":"#000000", "507":"#00A551", "507P":"#00A551", "610":"#541B15", "614":"#00C0F3", "614P":"#F2858E", "615":"#FFDD00", "615P":"#006585", "705":"#6EBF45", "706":"#B17AB5", "720":"#000000", "751":"#F48221", "751L":"#F48221", "751P":"#000000", "751L":"#F48221", "761P":"#6E2C91", "ä¸è¼‰å®¢":"#000000", "å¸æ©Ÿè¨“ç·´":"#000000", "å›å» ":"#000000", "å°ˆç”¨":"#000000", "å±¯é–€å°ˆç¶«": "#E67237", "å…ƒæœ—å°ˆç¶«": "#56B847"};
const stationDB = [
    {id:1, zh:"å±¯é–€ç¢¼é ­", r:["506P","507","507P","610","614","614P","615","615P","å±¯é–€å°ˆç¶«"]},
    {id:10, zh:"ç¾æ¨‚", r:["506P","610","615","615P"]},
    {id:15, zh:"è´è¶", r:["506P","610","615","615P","å±¯é–€å°ˆç¶«"]},
    {id:20, zh:"è¼•éµè»Šå» ", r:["506P","610","615","615P"]},
    {id:28, zh:"å±¯é–€è»Šå» ", r:[""]},
    {id:30, zh:"é¾é–€", r:["506P","610","615","615P","å±¯é–€å°ˆç¶«"]},
    {id:40, zh:"é’å±±æ‘", r:["506P","610","615","615P"]},
    {id:50, zh:"é’é›²", r:["506P","610","615","615P"]},
    {id:60, zh:"å»ºå®‰", r:["505","506P"]},
    {id:70, zh:"æ²³ç”°", r:["507","751"]},
    {id:75, zh:"è”¡æ„æ©‹", r:["507","751","å±¯é–€å°ˆç¶«"]},
    {id:80, zh:"æ¾¤è±", r:["610","751","751L"]},
    {id:90, zh:"å±¯é–€é†«é™¢", r:["610","751","751L"]},
    {id:100, zh:"å…†åº·", r:["505","506P","507P","610","614","614P","615","615P","720","751","751L","å±¯é–€å°ˆç¶«"]},
    {id:110, zh:"éº’éºŸ", r:["505","615P","å±¯é–€å°ˆç¶«"]},
    {id:120, zh:"é’æ¾", r:["505","507P","615","615P"]},
    {id:130, zh:"å»ºç”Ÿ", r:["505","507P","615","615P"]},
    {id:140, zh:"ç”°æ™¯", r:["505","507","507P","615","615P"]},
    {id:150, zh:"è‰¯æ™¯", r:["505","507","615","615P"]},
    {id:160, zh:"æ–°åœ", r:["505","507","615","615P"]},
    {id:170, zh:"çŸ³æ’", r:["505","610","615","615P"]},
    {id:180, zh:"å±±æ™¯ (åŒ—)", r:["505"]},
    {id:190, zh:"å±±æ™¯ (å—)", r:["505","å±¯é–€å°ˆç¶«"]},
    {id:200, zh:"é³´ç´", r:["505","610","615","615P"]},
    {id:212, zh:"å¤§èˆˆ (åŒ—)", r:["507","610"]},
    {id:220, zh:"å¤§èˆˆ (å—)", r:["507","610"]},
    {id:230, zh:"éŠ€åœ", r:["507","610"]},
    {id:240, zh:"å…†ç¦§", r:["507","614","614P"]},
    {id:250, zh:"å±¯é–€æ³³æ± ", r:["507","614","614P","å±¯é–€å°ˆç¶«"]},
    {id:260, zh:"è±æ™¯åœ’", r:["507","614","614P"]},
    {id:265, zh:"å…†éºŸ", r:["505","507","614","614P"]},
    {id:270, zh:"å®‰å®š", r:["505","507","614","614P","751"]},
    {id:275, zh:"å‹æ„›", r:["751"]},
    {id:280, zh:"å¸‚ä¸­å¿ƒ", r:["505","507","614","614P","751","å±¯é–€å°ˆç¶«"]},
    {id:295, zh:"å±¯é–€", r:["505","506P","507","751","å±¯é–€å°ˆç¶«"]},
    {id:300, zh:"æ¯æ¸¡", r:["506P","614","614P"]},
    {id:310, zh:"ä½•ç¦å ‚", r:["506P","614","614P"]},
    {id:320, zh:"æ–°å¢Ÿ", r:["506P","614","614P"]},
    {id:330, zh:"æ™¯å³°", r:["506P","614","614P"]},
    {id:340, zh:"é³³åœ°", r:["506P","614","614P"]},
    {id:350, zh:"è—åœ°", r:["507P","610","614","615","720","751","751L"]},
    {id:360, zh:"æ³¥åœ", r:["507P","610","614","615","720","751","751L"]},
    {id:370, zh:"é¾å±‹æ‘", r:["507P","610","614","615","720","751","751L"]},
    {id:380, zh:"æ´ªæ°´æ©‹", r:["507P","610","614","615","720","751","751L"]},
    {id:385, zh:"æ´ªå¤©è·¯", r:[""]},
    {id:390, zh:"å¡˜åŠæ‘", r:["610","614","615","761P"]},
    {id:400, zh:"å±å±±", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:425, zh:"å‘å°¾æ‘", r:["751","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:430, zh:"å¤©æ°´åœ", r:["705","706","751","751P","å…ƒæœ—å°ˆç¶«"]},
    {id:435, zh:"å¤©æ…ˆ", r:["705","706","751","751P"]},
    {id:445, zh:"å¤©è€€", r:["705","706","720","761P"]},
    {id:448, zh:"æ¨‚æ¹–", r:["705","706","720","761P"]},
    {id:450, zh:"å¤©æ¹–", r:["705","706","751","751P"]},
    {id:455, zh:"éŠ€åº§", r:["705","706","751","751P"]},
    {id:460, zh:"å¤©ç‘", r:["705","706","720","761P"]},
    {id:468, zh:"é Œå¯Œ", r:["705","706","751","751P","761P"]},
    {id:480, zh:"å¤©å¯Œ", r:["705","706","751","751P","761P"]},
    {id:490, zh:"ç¿ æ¹–", r:["720","751","751P"]},
    {id:500, zh:"å¤©æ¦®", r:["705","706","751","751P","761P"]},
    {id:510, zh:"å¤©æ‚…", r:["705","706"]},
    {id:520, zh:"å¤©ç§€", r:["705","706"]},
    {id:530, zh:"æ¿•åœ°å…¬åœ’", r:["705","706","å…ƒæœ—å°ˆç¶«"]},
    {id:540, zh:"å¤©æ’", r:["705","706"]},
    {id:550, zh:"å¤©é€¸", r:["705","706","751","751P","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:560, zh:"æ°´é‚Šåœ", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:570, zh:"è±å¹´è·¯", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:580, zh:"åº·æ¨‚è·¯", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:590, zh:"å¤§æ£ è·¯", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:600, zh:"å…ƒæœ—", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:920, zh:"ä¸‰è–", r:["505","å±¯é–€å°ˆç¶«"]}
];
/**
 * è¼•éµè»Šåºè‡ªå‹•åŒ–èˆ‡æç¤ºç³»çµ± - å®Œæ•´æ•´åˆç‰ˆ
 * ä¿®æ”¹å…§å®¹ï¼šåƒ…åœ¨æäº¤ (addReport) æ™‚å¼·åˆ¶å°‡è»Šåºè£œè¶³ä¸‰ä½æ•¸
 */

window.customRteKey = null;
window.processedActions = new Set(); 

const specialTips = { 
    "901": "åˆ°é”å…†åº·ç«™å¾Œæ”¹ç‚º615å‰å¾€å±¯é–€ç¢¼é ­", 
    "902": "åˆ°é”å…†åº·ç«™å¾Œæ”¹ç‚º507På‰å¾€å±¯é–€ç¢¼é ­", 
    "903": "åˆ°é”æ¾¤è±ç«™å¾Œæ”¹ç‚º507å‰å¾€å±¯é–€ç¢¼é ­"
};

/**
 * ä¸»è¦è­˜åˆ¥å‡½å¼ (ä¿æŒç”¨æˆ¶åŸå§‹è¼¸å…¥æ„Ÿï¼Œä¸å¼·åˆ¶æ›´æ­£ç•Œé¢)
 */
function checkRunNo() {
    const runStr = document.getElementById('runNo').value.trim();
    
    if (!runStr) {
        window.processedActions.clear();
        return;
    }

    // 1. è‡ªå‹•é¸æ“‡è·¯ç·š (éœé»˜åŸ·è¡Œ)
    processAutoRoute(runStr);

    // 2. æª¢æŸ¥ç‰¹æ®Šç›®çš„åœ°ç¢ºèª (705/706)
    if (checkSpecialDestination(runStr)) return;

    // 3. è™•ç† 904 (ä¸€ç´šé¸å–®é›™é¸é …)
    if (runStr === "904" && !window.processedActions.has('special_904')) {
        show904Menu();
        return;
    }

    // 4. æª¢æŸ¥å…¶ä»–ç›´é€šç­æ¬¡ (901-903)
    const specialKey = 'special_' + runStr;
    if (specialTips[runStr] && !window.processedActions.has(specialKey)) {
        showRunSuggestionMenu(`${specialTips[runStr]}`, () => {
            applySuggestion(); 
        }, 'special', specialKey);
    }
}

/**
 * 904 å°ˆç”¨ä¸€ç´šé¸å–®
 */
function show904Menu() {
    const existing = document.getElementById('run-action-sheet');
    if (existing) existing.remove();

    const html = `
    <div id="run-action-sheet" class="action-sheet-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10001; display: flex; align-items: flex-end;">
        <div class="action-sheet-content" onclick="event.stopPropagation()" style="width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; max-width: 600px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 20px; color: #333; font-size: 1.05em; line-height: 1.5;"><b style="color: #ff9500;">âš ï¸ åµæ¸¬åˆ°ç›´é€šï¼ç‰¹åˆ¥ç­æ¬¡</b><br>è«‹é¸æ“‡ç¾æ™‚é©ç”¨ç­æ¬¡<b></br><span style="font-size: 0.85em; color: #888;">ï¼ˆè‹¥å±¬å¯¦è«‹æŒ‰ç¢ºèªï¼Œå°‡è‡ªå‹•å¡«å¯«å‚™è¨»ï¼‰</span>
            </div>
            
            <button id="opt-904-a" style="width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #007aff; background: #f0f7ff; color: #007aff; font-size: 1.05em; font-weight: 600; cursor: pointer; text-align: center;">
                åˆ°é”å…†åº·ç«™å¾Œæ”¹ç‚º 720 å¾€å¤©æ¦®
            </button>

            <button id="opt-904-b" style="width: 100%; padding: 16px; margin-bottom: 20px; border-radius: 12px; border: 1px solid #007aff; background: #f0f7ff; color: #007aff; font-size: 1.05em; font-weight: 600; cursor: pointer; text-align: center;">
                åˆ°é”å¤©æ¦®ç«™å¾Œæ”¹ç‚º 751 å¾€å‹æ„›
            </button>

            <button id="run-cancel-btn" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: #f5f5f5; color: #333; font-size: 1.05em; cursor: pointer;">
                å–æ¶ˆ
            </button>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    const close = () => {
        window.processedActions.add('special_904');
        document.getElementById('run-action-sheet').remove();
    };

    document.getElementById('run-action-sheet').onclick = close;
    
    document.getElementById('opt-904-a').onclick = () => {
        const rs = document.getElementById('routeSelect');
        const ds = document.getElementById('directionSelect');
        const memo = document.getElementById('memo');
        
        setSpecialRoute(rs, "506Px720", "506P");
        ds.innerHTML = `<option>å¤©æ¦®</option>`;
        memo.value = "åˆ°é”å…†åº·ç«™å¾Œæ”¹ç‚º720å‰å¾€å¤©æ¦®";
        updateStationList("506P", [100]);
        close();
    };

    document.getElementById('opt-904-b').onclick = () => {
        const rs = document.getElementById('routeSelect');
        const ds = document.getElementById('directionSelect');
        const memo = document.getElementById('memo');

        setSpecialRoute(rs, "720x751", "720");
        ds.innerHTML = `<option>å‹æ„›</option>`;
        memo.value = "åˆ°é”å¤©æ¦®ç«™å¾Œæ”¹ç‚º751å‰å¾€å‹æ„›";
        updateStationList("720", [], "751");
        close();
    };

    document.getElementById('run-cancel-btn').onclick = close;
}


function showActionSheet(config) {
    const existing = document.getElementById('run-action-sheet');
    if (existing) existing.remove();

    const html = `
    <div id="run-action-sheet" class="action-sheet-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10001; display: flex; align-items: flex-end;">
        <div class="action-sheet-content" onclick="event.stopPropagation()" style="width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; max-width: 600px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 20px; color: #333; font-size: 1.05em; line-height: 1.5;">
                ${config.title}
            </div>
            
            ${config.buttons.map((btn, index) => `
                <button id="sheet-btn-${index}" style="width: 100%; padding: 16px; margin-bottom: ${index === config.buttons.length - 1 ? '20px' : '10px'}; border-radius: 12px; border: ${btn.primary ? '1px solid #007aff' : 'none'}; background: ${btn.primary ? '#f0f7ff' : '#f5f5f5'}; color: ${btn.danger ? '#ff3b30' : (btn.primary ? '#007aff' : '#333')}; font-size: 1.05em; font-weight: 600; cursor: pointer; text-align: center;">
                    ${btn.text}
                </button>
            `).join('')}

            <button id="run-cancel-btn" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: #eee; color: #333; font-size: 1.05em; cursor: pointer;">
                å–æ¶ˆ
            </button>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    const close = () => {
        const sheet = document.getElementById('run-action-sheet');
        if (sheet) sheet.remove();
    };

    document.getElementById('run-action-sheet').onclick = close;
    document.getElementById('run-cancel-btn').onclick = close;

    config.buttons.forEach((btn, index) => {
        document.getElementById(`sheet-btn-${index}`).onclick = () => {
            btn.onClick();
            close();
        };
    });
}


/**
 * è¼”åŠ©ï¼šè¨­å®šç‰¹æ®Šè·¯ç·šé¸é …
 */
function setSpecialRoute(rs, value, display) {
    let opt = [...rs.options].find(o => o.value === value);
    if (!opt) {
        opt = document.createElement('option');
        opt.value = value;
        rs.appendChild(opt);
    }
    opt.innerText = display;
    rs.value = value;
    window.customRteKey = value;
    if (typeof onRouteUpdate === "function") onRouteUpdate();
}

/**
 * è¼”åŠ©ï¼šæ›´æ–°è»Šç«™æ¸…å–®
 */
function updateStationList(mainRoute, extraIds = [], secondRoute = null) {
    const ss = document.getElementById('stationSelect');
    const list = stationDB.filter(s => 
        s.r.includes(mainRoute) || 
        extraIds.includes(s.id) || 
        (secondRoute && s.r.includes(secondRoute))
    ).sort((a, b) => a.id - b.id);
    ss.innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
}

/**
 * è™•ç†è‡ªå‹•åŒ–å¡«å¯«
 */
function processAutoRoute(runStr) {
    let run = parseInt(runStr);
    if (isNaN(run)) return;
    let autoRoute = null, autoDest = null;

    if (run >= 1 && run <= 20) autoRoute = "505";
    else if (run >= 21 && run <= 40) autoRoute = "507";
    else if (run >= 51 && run <= 70) autoRoute = "610";
    else if (run >= 71 && run <= 90) autoRoute = "614";
    else if (run >= 201 && run <= 220) { autoRoute = "614P"; autoDest = "å…†åº·"; }
    else if (run >= 221 && run <= 230) { autoRoute = "614P"; autoDest = "å±¯é–€ç¢¼é ­"; }
    else if ((run >= 91 && run <= 100) || (run >= 191 && run <= 200)) autoRoute = "761P";
    else if (run >= 111 && run <= 130) autoRoute = "615";
    else if (run >= 131 && run <= 140 || run === 436) autoRoute = "705";
    else if (run >= 141 && run <= 150 || run === 446) autoRoute = "706";
    else if (run >= 171 && run <= 187) autoRoute = "751";
    else if (run >= 904 && run <= 905) autoRoute = "506P";
    else if (run === 188 || run === 189) autoRoute = "751P";
    else if (run === 868) autoRoute = "å±¯é–€å°ˆç¶«";
    else if (run === 871) autoRoute = "å…ƒæœ—å°ˆç¶«";

    if (autoRoute) {
        document.getElementById('routeSelect').value = autoRoute;
        if (typeof onRouteUpdate === "function") onRouteUpdate();
        if (autoDest) {
            document.getElementById('directionSelect').value = autoDest;
            if (typeof onRouteUpdate === "function") onRouteUpdate();
        }
    }
}

/**
 * æª¢æŸ¥ç›®çš„åœ°ç‹€æ…‹ (705/706)
 */
function checkSpecialDestination() {
    const route = document.getElementById('routeSelect').value;
    const dest = document.getElementById('directionSelect').value;
    const actionKey = `display_${route}_${dest}`;

    if (document.getElementById('run-action-sheet')) return false;
    if (window.processedActions.has(actionKey)) return false;

    if ((route === "705" || route === "706") && dest === "ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™") {
        const msg = `è©²åˆ—è»Šæ˜¯å¦æœ‰æ›´æ”¹é›»ç‰Œé¡¯ç¤ºç‚ºã€Œä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™ã€ï¼Ÿ`;
        const action = () => { 
            document.getElementById('memo').value = "é›»ç‰Œé¡¯ç¤ºã€Œä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™ã€ï¼ˆæœ‰Lç‰Œï¼‰"; 
        };
        showRunSuggestionMenu(msg, action, 'display', actionKey);
        return true;
    }
    return false;
}

/**
 * é€šç”¨ Action Sheet UI
 */
window.showRunSuggestionMenu = function(message, onApply, type = 'special', actionKey = null) {
    const existing = document.getElementById('run-action-sheet');
    if (existing) existing.remove();

    let infoHtml = type === 'display' ? `
        <div style="text-align: center; margin-bottom: 20px; color: #333; font-size: 1.05em; line-height: 1.5;">
            <b style="color: #ff9500;">âš ï¸ é›»ç‰Œé¡¯ç¤ºç¢ºèª</b><br>${message}</br>
			<span style="font-size: 0.85em; color: #888;">ï¼ˆè‹¥å±¬å¯¦è«‹æŒ‰ç¢ºèªï¼Œå°‡è‡ªå‹•å¡«å¯«å‚™è¨»ï¼‰</span>
        </div>` : `
        <div style="text-align: center; margin-bottom: 20px; color: #333; font-size: 1.05em; line-height: 1.5;">
            <b style="color: #ff9500;">âš ï¸ åµæ¸¬åˆ°ç›´é€šï¼ç‰¹åˆ¥ç­æ¬¡</b><br>æœ¬ç­è»Š${message}<b></br>
			<span style="font-size: 0.85em; color: #888;">ï¼ˆè‹¥å±¬å¯¦è«‹æŒ‰ç¢ºèªï¼Œå°‡è‡ªå‹•å¡«å¯«å‚™è¨»ï¼‰</span>
        </div>`;

    const html = `
    <div id="run-action-sheet" class="action-sheet-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10001; display: flex; align-items: flex-end;">
        <div class="action-sheet-content" onclick="event.stopPropagation()" style="width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; max-width: 600px; margin: 0 auto;">
            ${infoHtml}
            <button id="run-apply-btn" style="width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: none; background: #007aff; color: #fff; font-size: 1.05em; font-weight: 600; cursor: pointer;">ç¢ºèª</button>
            <button id="run-cancel-btn" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: #f5f5f5; color: #333; font-size: 1.05em; cursor: pointer;">å–æ¶ˆ</button>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', html);

    const closeMenu = () => {
        if (actionKey) window.processedActions.add(actionKey); 
        document.getElementById('run-action-sheet').remove();
    };

    document.getElementById('run-action-sheet').onclick = closeMenu;
    document.getElementById('run-apply-btn').onclick = (e) => { e.stopPropagation(); onApply(); closeMenu(); };
    document.getElementById('run-cancel-btn').onclick = (e) => { e.stopPropagation(); closeMenu(); };
};

/**
 * åŸ·è¡Œç‰¹åˆ¥è½‰æ›é‚è¼¯
 */
function applySuggestion() {
    const rno = document.getElementById('runNo').value;
    const rs = document.getElementById('routeSelect');
    const ds = document.getElementById('directionSelect');
    const ss = document.getElementById('stationSelect');
    const memo = document.getElementById('memo');

    const setSpecialRoute = (value, display) => {
        let opt = [...rs.options].find(o => o.value === value);
        if (!opt) {
            opt = document.createElement('option'); opt.value = value; rs.appendChild(opt);
        }
        opt.innerText = display; rs.value = value; window.customRteKey = value; 
    };

    if (rno === "903" || parseInt(rno) === 903) {
        setSpecialRoute("751L", "751L");
        ds.innerHTML = `<option>å±¯é–€ç¢¼é ­</option>`;
        memo.value = "åˆ°é”æ¾¤è±ç«™å¾Œæ”¹ç‚º507å‰å¾€å±¯é–€ç¢¼é ­";
        const extraIds = [425, 380, 370, 350, 360, 100, 90, 80];
        const list = stationDB.filter(s => s.r.includes("751P") || extraIds.includes(s.id)).sort((a,b)=>a.id-b.id);
        ss.innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
    } 
    else if (parseInt(rno) === 901 || parseInt(rno) === 902) {
        const type = parseInt(rno) === 901 ? "615" : "507P";
        setSpecialRoute(`751x${type}`, "751P");
        ds.innerHTML = `<option>å±¯é–€ç¢¼é ­</option>`;
        memo.value = specialTips[rno.padStart(3, '0')];
        const extraIds = [425, 380, 370, 350, 360, 100];
        const list = stationDB.filter(s => s.r.includes("751P") || extraIds.includes(s.id)).sort((a,b)=>a.id-b.id);
        ss.innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
    }
    else if (parseInt(rno) === 904) {
        const subOptions = [
            { 
                label: "720 å¾€å¤©æ¦® (ç¶“å…†åº·)", 
                action: () => {
                    setSpecialRoute("506Px720", "506P");
                    ds.innerHTML = `<option>å…†åº·</option><option>å¤©æ¦®</option>`;
                    memo.value = "åˆ°é”å…†åº·ç«™å¾Œæ”¹ç‚º720å‰å¾€å¤©æ¦®";
                    const list = stationDB.filter(s => s.r.includes("506P") || s.id === 100).sort((a,b)=>a.id-b.id);
                    ss.innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
                }
            },
            {
                label: "751 å¾€å‹æ„› (ç¶“å¤©æ¦®)", 
                action: () => {
                    setSpecialRoute("720x751", "720");
                    ds.innerHTML = `<option>å¤©æ¦®</option><option>å‹æ„›</option>`;
                    memo.value = "åˆ°é”å¤©æ¦®ç«™å¾Œæ”¹ç‚º751å‰å¾€å‹æ„›";
					const extraIds = [425, 380, 370, 350, 360, 100];
                    const list = stationDB.filter(s => s.r.includes("720") || s.r.includes("751P")).sort((a,b)=>a.id-b.id);
                    ss.innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
                }
            }
        ];
        showSubMenu("è«‹é¸æ“‡ 904 é‹è¡Œæ¨¡å¼ï¼š", subOptions);
    }
}

/**
 * 904 å°ˆç”¨å­é¸å–®
 */
window.showSubMenu = function(message, options) {
    const html = `
    <div id="run-sub-sheet" class="action-sheet-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10002; display: flex; align-items: flex-end;">
        <div class="action-sheet-content" style="width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px;">
            <div style="text-align: center; margin-bottom: 15px; color: #888;">${message}</div>
            ${options.map(opt => `<button class="sub-opt-btn" style="width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: none; background: #f0f7ff; color: #007aff; font-weight: 600;">${opt.label}</button>`).join('')}
            <button onclick="this.closest('.action-sheet-overlay').remove()" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: #f5f5f5;">å–æ¶ˆ</button>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    document.querySelectorAll('.sub-opt-btn').forEach((btn, idx) => {
        btn.onclick = () => { options[idx].action(); document.getElementById('run-sub-sheet').remove(); };
    });
};

function onRouteUpdate() {
    const r = document.getElementById('routeSelect').value;
    window.customRteKey = null; 
    document.getElementById('directionSelect').innerHTML = (routeCfg[r] || []).map(d => `<option>${d}</option>`).join('');
    
    const specials = ["ä¸è¼‰å®¢", "å¸æ©Ÿè¨“ç·´", "å›å» ", "å°ˆç”¨"];
    let list;
    if (specials.includes(r)) {
        list = [...stationDB].sort((a,b) => a.id - b.id);
    } else {
        list = stationDB.filter(s => s.r.includes(r)).sort((a,b)=>a.id-b.id);
    }
    
    document.getElementById('stationSelect').innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
    checkSpecialDestination();
}

/**
 * æœ€çµ‚æäº¤å ±å‘Šé‚è¼¯ (æ­¤è™•è™•ç†å¼·åˆ¶è£œé›¶)
 */
window.addReport = function() {
    const carIdVal = document.getElementById('carId').value.trim();
    let runNoVal = document.getElementById('runNo').value.trim();
    const routeVal = document.getElementById('routeSelect').value;
    const directionVal = document.getElementById('directionSelect').value;
    const stationVal = document.getElementById('stationSelect').value;
    const memoVal = document.getElementById('memo').value.trim();

    if (!carIdVal || !runNoVal) {
        window.showToast("è«‹å¡«å¯«è»Šç·¨åŠè»Šåº");
        return;
    }

    // å¼·åˆ¶æ ¼å¼åŒ–è»Šåºç‚ºä¸‰ä½æ•¸
    if (!isNaN(runNoVal)) {
        runNoVal = runNoVal.padStart(3, '0');
    }

    // --- æ–°å¢ï¼šè™•ç†ç®¡ç†å“¡è‡ªå®šç¾©æ™‚é–“é‚è¼¯ ---
    let finalTimestamp = Date.now();
    let finalTStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });

    const adminDate = document.getElementById('adminDate')?.value;
    const adminTime = document.getElementById('adminTime')?.value;

    // åªæœ‰åœ¨ç®¡ç†å“¡ä¸”å¡«å¯«äº†æ—¥æœŸæ™‚é–“æ™‚æ‰è¦†è“‹
    if (window.isAdmin && adminDate && adminTime) {
        const customDate = new Date(`${adminDate}T${adminTime}`);
        if (!isNaN(customDate.getTime())) {
            finalTimestamp = customDate.getTime();
            // æ ¼å¼åŒ–è‡ªå®šç¾©çš„æ™‚é–“é¡¯ç¤º (HH:mm)
            finalTStr = `${String(customDate.getHours()).padStart(2, '0')}:${String(customDate.getMinutes()).padStart(2, '0')}`;
        }
    }
    // ------------------------------------

    const newTrace = {
        rno: runNoVal,
        rteKey: window.customRteKey || routeVal,
        dRte: (window.customRteKey || routeVal) + " å¾€ " + directionVal,
        loc: stationVal,
        mem: memoVal,
        tStr: finalTStr,         // ä½¿ç”¨è™•ç†å¾Œçš„æ™‚é–“å­—ä¸²
        timestamp: finalTimestamp // ç¢ºä¿åŒ…å« timestamp ç”¨æ–¼æ’åº
    };

    // å‘¼å«åŸæœ¬çš„ç™¼å¸ƒå‡½æ•¸
    window.publishToFirebase(carIdVal, newTrace);

    // æäº¤å¾Œæ¸…ç©ºè¼¸å…¥
    document.getElementById('memo').value = ""; 
    if (document.getElementById('adminTime')) document.getElementById('adminTime').value = "";
};

// --- 3. è™•ç†é¸å–®å‹•ä½œ ---
// å¿…é ˆæ›è¼‰åˆ° windowï¼ŒHTML onclick æ‰èƒ½åŸ·è¡Œ
window.handleETAAciton = function(type, ...args) {
    const sheet = document.getElementById('eta-action-sheet');
    if (sheet) sheet.remove();

    if (type === 'trace') {
        const [carId] = args;
        if (!carId) return alert("æš«ç„¡è©²è»Šæ¬¡å°æ‡‰çš„ç·¨çµ„è³‡æ–™");
        
        // åˆ‡æ›åˆ°ã€Œè¡Œè¹¤ã€åˆ†é 
        const historyBtn = Array.from(document.querySelectorAll('.tab-btn'))
            .find(b => b.innerText.includes('è¡Œè¹¤'));
        if (typeof window.switchTab === 'function' && historyBtn) {
            window.switchTab('livePage', historyBtn);
        }

        setTimeout(() => {
            const searchInput = document.getElementById('searchComp');
            if (searchInput) {
                searchInput.value = carId;
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }, 300);

    } else if (type === 'report') {
        // --- é—œéµä¿®æ­£ï¼šç¢ºä¿é€™è£¡çš„ args é †åºèˆ‡ showETAMenu å‚³å…¥çš„ä¸€è‡´ ---
        // å»ºè­°é †åºï¼š[location, route, dest, runNo, carId]
        const [location, route, dest, runNo, carId] = args;
        
        if (typeof window.reportETA === 'function') {
            // å‘¼å«æ™‚å°‡åƒæ•¸å‚³çµ¦ reportETA
            window.reportETA(route, dest, runNo, location, carId);
        } else {
            console.error("å°šæœªå®šç¾© window.reportETA å‡½å¼");
        }
    }
};

function initETAStations() {
    const select = document.getElementById('etaStationSelect');
    if(!select) return;
    select.innerHTML = "";
    stationDB.sort((a, b) => a.id - b.id).forEach(s => {
        // ä¿®æ”¹åˆ¤æ–·æ¢ä»¶ï¼ŒåŒæ™‚æ’é™¤ 28 å’Œ 385
        if (s.id == 28 || s.id == 385) return;

        const opt = document.createElement('option'); 
        opt.value = s.id; 
        opt.innerText = `${s.id} ${s.zh}`; 
        select.appendChild(opt);
    });
}

window.toggleAdminTime = function() {
    const adminRow = document.getElementById('adminTimeRow');
    const toggleBtn = document.getElementById('adminToggleBtn');
    
    // æª¢æŸ¥ç›®å‰æ˜¯å¦ç‚ºæ‘ºç–Šç‹€æ…‹ (ä»¥ max-height åˆ¤æ–·)
    if (adminRow.style.maxHeight === '0px' || adminRow.style.maxHeight === '0') {
        // å±•é–‹ï¼šè¨­ç½®ä¸€å€‹è¶³å¤ å¤§çš„é«˜åº¦ï¼Œä¸¦æ¢å¾©é‚Šæ¡†å’Œé€æ˜åº¦
        adminRow.style.maxHeight = '200px'; 
        adminRow.style.opacity = '1';
        adminRow.style.marginTop = '8px';
        adminRow.style.borderWidth = '1px';
        
        toggleBtn.innerText = 'âœ• è£œéŒ„æ¨¡å¼';
    } else {
        // æ‘ºç–Šï¼šå…¨éƒ¨æ­¸é›¶
        adminRow.style.maxHeight = '0';
        adminRow.style.opacity = '0';
        adminRow.style.marginTop = '0';
        adminRow.style.borderWidth = '0';
        
        toggleBtn.innerText = 'è£œéŒ„æ¨¡å¼';
        
        // éš±è—å‹•ç•«çµæŸå¾Œæ¸…ç©ºæ™‚é–“ï¼ˆå¯é¸ï¼‰
        if(document.getElementById('adminTime')) document.getElementById('adminTime').value = "";
    }
};

window.syncETAList = function(source) {
    const input = document.getElementById('etaStationInput');
    const select = document.getElementById('etaStationSelect');
    
    // åˆ¤æ–·æ˜¯å¦éœ€è¦æ»‘å…¥å‹•ç•«ï¼šæ‰‹å‹•é¸æ“‡è»Šç«™ (select)ã€è¼¸å…¥ ID (input) æˆ–åˆ‡æ›åˆ†é  (tab)
    const shouldAnimate = (source === 'select' || source === 'input' || source === 'tab');
    
    if (source === 'input') {
        const val = parseInt(input.value);
        if (!isNaN(val)) select.value = val;
    } else {
        input.value = select.value;
    }
    
    // å‚³éå‹•ç•«æ¨™ç±¤çµ¦ updateETAList
    if (typeof updateETAList === 'function') {
        updateETAList(shouldAnimate);
    }
};

window.etaTimer = null;

// åœ¨å…¨å±€ä½œç”¨åŸŸå®šç¾©æ•…éšœç´€éŒ„è®Šæ•¸
window.primaryApiFaultTime = 0; 

/**
 * æ›´æ–° ETA åˆ—è¡¨
 */
async function updateETAList(isEntrance = false) {
    if (window.isEtaFetching) return;
    window.isEtaFetching = true;

    const listArea = document.getElementById('etaList');
    const select = document.getElementById('etaStationSelect');
    const stationId = select ? select.value : null;

    if (!stationId || !listArea) {
        window.isEtaFetching = false;
        return;
    }

    // 1. è¨˜éŒ„å±•é–‹ç‹€æ…‹
    const expandedPlatforms = new Set();
    document.querySelectorAll('.eta-extra-container.expanded').forEach(el => {
        expandedPlatforms.add(el.id);
    });

    if (window.etaTimer) {
        clearTimeout(window.etaTimer);
        window.etaTimer = null;
    }

    // --- 2. Station A -> é€€å ´ (Fade Out + Slide Down) -> é¡¯ç¤º Skeleton ---
    if (isEntrance) {
        listArea.classList.remove('entrance-anim');
        listArea.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
        listArea.style.opacity = '0';
        listArea.style.transform = 'translateY(10px)';
        
        await new Promise(resolve => setTimeout(resolve, 200));

        let skeletonHtml = '';
        for (let p = 0; p < 2; p++) {
            skeletonHtml += `
                <div style="margin-bottom: 20px;">
                    <div class="skeleton-platform-label"></div>
                    <div class="skeleton-row"></div>
                    <div class="skeleton-row"></div>
                    <div class="skeleton-row"></div>
                </div>`;
        }
        
        listArea.style.transition = 'none';
        listArea.style.transform = 'translateY(15px)';
        listArea.innerHTML = skeletonHtml;
        
        void listArea.offsetHeight; // å¼·åˆ¶é‡ç¹ª

        listArea.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        listArea.style.opacity = '1';
        listArea.style.transform = 'translateY(0)';
    } else {
        listArea.style.transition = 'opacity 0.2s ease';
        listArea.style.transform = 'none'; 
        listArea.style.opacity = '0.7';
    }

    try {
        // --- 3. API è«‹æ±‚èˆ‡æ•¸æ“šè™•ç† ---
        let response;
        let isUsingAlternative = false;
        const nowMs = Date.now();
        const primaryUrl = `https://lrtapi.lightcatcube.com/api/schedule?station_id=${stationId}`;
        const backupUrl = `https://rt.data.gov.hk/v1/transport/mtr/lrt/getSchedule?station_id=${stationId}`;
        const isCooldown = (nowMs - (window.primaryApiFaultTime || 0)) < 300000;

        if (isCooldown) {
            isUsingAlternative = true;
            response = await fetch(backupUrl);
        } else {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                response = await fetch(primaryUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error('Status Error');
                window.primaryApiFaultTime = 0;
            } catch (e) {
                window.primaryApiFaultTime = Date.now();
                isUsingAlternative = true;
                response = await fetch(backupUrl);
            }
        }
        const data = await response.json();
        
        if (data && data.platform_list) {
            // ç”Ÿæˆå…§å®¹ HTML
            const runToCompMap = {};
            const groups = window.reportGroups || {};
            const todayOpDate = window.getOperationalDate ? window.getOperationalDate() : ""; 
            let allTraces = [];
            Object.values(groups).forEach(group => {
                if (group.traces) {
                    group.traces.forEach(t => {
                        if (window.getOperationalDate(t.timestamp) === todayOpDate) {
                            allTraces.push({ rno: parseInt(t.rno).toString(), carId: t.fullId || group.carId, timestamp: t.timestamp });
                        }
                    });
                }
            });
            allTraces.sort((a, b) => a.timestamp - b.timestamp);
            const carToLastRnoMap = {}; 
            allTraces.forEach(trace => {
                if (trace.rno && trace.rno !== "NaN" && trace.carId) {
                    if (carToLastRnoMap[trace.carId]) delete runToCompMap[carToLastRnoMap[trace.carId]];
                    runToCompMap[trace.rno] = trace.carId;
                    carToLastRnoMap[trace.carId] = trace.rno;
                }
            });

            // ç²å–ç•¶å‰æ™‚é–“ç”¨æ–¼é‚è¼¯ä¿®æ­£
            const now = new Date();
            const isWeekday = now.getDay() >= 1 && now.getDay() <= 5;
            const hourMin = now.getHours() * 100 + now.getMinutes();

            let html = "";
            html += `<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85em; border: 1px solid #ffeeba;">
                ${isUsingAlternative ? 'âš ï¸ ç³»çµ±æš«æ™‚ç„¡æ³•å–å¾—è»Šåºç›¸é—œè³‡è¨Šï¼Œè«‹ç¨å€™å†è©¦ã€‚' : 'âš ï¸ ã€Œåˆ°ç«™æ™‚é–“é¡¯ç¤ºè»Šç·¨åŠŸèƒ½ã€ç¾æ­£æ¸¬è©¦ä¸­ï¼Œè¡Œè¹¤åªä¾›åƒè€ƒã€‚'}
            </div>`;

            data.platform_list.forEach(platform => {
                html += `<div class="eta-platform-group" style="margin-bottom: 12px; border-radius: 12px; overflow: hidden; background: #fff; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div class="eta-platform-label" style="background: #f8f9fa; padding: 8px 12px; font-size: 0.8em; color: #555; border-bottom: 1px solid #eee; font-weight: bold;">
                        ${platform.platform_id} è™Ÿæœˆå°
                    </div>`;

                if (platform.route_list && platform.route_list.length > 0) {
                    const containerId = `extra-container-${platform.platform_id}`;
                    const isInitiallyExpanded = expandedPlatforms.has(containerId);

                    platform.route_list.forEach((train, index) => {
                        // --- 1. è»Šåºè™•ç† ---
                        let raw = train.trip_no ? String(train.trip_no) : (train.train_id !== "0" ? String(train.train_id) : "");
                        let runNoRaw = (raw && raw.length > 2) ? raw.substring(0, raw.length - 2) : (raw || "");
                        const isInvalid = !runNoRaw || runNoRaw === "undefined" || runNoRaw === "undefin" || runNoRaw === "null";
                        let displayRunNo = isInvalid ? "---" : runNoRaw.padStart(3, '0');
                        const cleanRunNo = isInvalid ? "0" : parseInt(runNoRaw).toString();

                        // --- 2. è·¯ç·šèˆ‡ç›®çš„åœ°é‚è¼¯ä¿®æ­£ ---
                        let rawDest = (typeof train.dest_ch === 'string' && train.dest_ch.trim() !== '') ? train.dest_ch : 'ä¸è¼‰å®¢åˆ—è»Š';
                        let displayRoute = train.route_no;
                        let fontStyle = "";
                        
                        if (isWeekday) {
                            if (hourMin >= 630 && hourMin <= 830) {
                                if (rawDest === 'ä¸è¼‰å®¢åˆ—è»Š' || (displayRoute === '615' && rawDest === 'å±¯é–€ç¢¼é ­' && (cleanRunNo === '0' || cleanRunNo === '902'))) {
                                    displayRoute = '507P'; rawDest = 'å±¯é–€ç¢¼é ­';
                                } else if (displayRoute === '751' && rawDest === 'å‹æ„›' && (cleanRunNo === '0' || cleanRunNo === '903')) {
                                    displayRoute = '751L'; rawDest = 'å±¯é–€ç¢¼é ­';
                                }
                            } else if (hourMin >= 1530 && hourMin <= 2030) {
                                if (displayRoute === '751P' && rawDest === 'ä¸è¼‰å®¢åˆ—è»Š') {
                                    rawDest = 'æœªæœ‰ç›¸é—œç­æ¬¡è³‡è¨Š';
                                    fontStyle = 'color: #999; font-style: italic; font-weight: 400; font-size: 0.8em; ';
                                }
                            }
                        }

                        // --- 3. æ™‚é–“é¡¯ç¤ºè™•ç† ---
                        let timeDiff = train.time_ch || "---";
                        if (rawDest === 'æœªæœ‰ç›¸é—œç­æ¬¡è³‡è¨Š') timeDiff = timeDiff.replace(/[åˆ†é˜\-]/g, '').trim();

                        // --- 4. è»Šå¡èˆ‡ç·¨çµ„è™•ç† ---
                        const hasLength = train.train_length !== null && train.train_length !== undefined && !isNaN(parseInt(train.train_length));
                        const lengthText = hasLength ? `${train.train_length}å¡` : "";
                        const safeDest = rawDest.replace(/'/g, "\\'");
                        const matchedCarId = runToCompMap[cleanRunNo] || "";
                        
                        let compContent = "";
                        if (matchedCarId && !isUsingAlternative) {
                            const apiLength = parseInt(train.train_length);
                            const reportedLength = matchedCarId.includes('-') ? 2 : 1;
                            const displayColor = (hasLength && reportedLength !== apiLength) ? "#e67e22" : "#2980b9";
                            compContent = `<span style="color:${displayColor}; margin-left:4px; font-weight: 500;">(${matchedCarId})</span>`;
                        }

                        const isSpecialStatus = train.time_en === 'Arriving' || train.time_en === 'Departing';
                        const routeColor = (typeof colorMap !== 'undefined' && colorMap[displayRoute]) ? colorMap[displayRoute] : '#333';
                        const stationName = select.options[select.selectedIndex].text;

                        if (index === 4) {
                            html += `<div id="${containerId}" class="eta-extra-container ${isInitiallyExpanded ? 'expanded' : ''}">`;
                        }

                        html += `
                        <div class="eta-row" 
                             onclick="showETAMenu('${stationName}', '${displayRoute}', '${safeDest}', '${displayRunNo}', '${matchedCarId}')"
                             style="position: relative; display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f9f9f9; cursor: pointer;">
                            <div style="position: absolute; left: 0; top: 8px; bottom: 8px; width: 4px; border-radius: 0 2px 2px 0; background: ${routeColor};"></div>
                            <div class="eta-info-left" style="display: flex; align-items: center; gap: 8px; padding-left: 6px;">
                                <span class="run-no-badge">${displayRunNo}</span>
                                <span class="route-badge" style="background: transparent; border: 1.5px solid ${routeColor}; color: #000; min-width: 32px; text-align: center; padding: 1px 4px; font-size: 0.85em; font-weight: bold; border-radius: 4px;">${displayRoute}</span>
                                <div style="display: flex; flex-direction: column; line-height: 1.2;">
                                    <div style="font-weight: bold; font-size: 1em; color: #2c3e50; ${fontStyle}">${rawDest}</div>
                                    <div style="font-size: 0.75em; color: #7f8c8d;">${lengthText}${compContent}</div>
                                </div>
                            </div>
                            <div class="${isSpecialStatus ? 'approaching' : ''}" style="font-weight: bold; font-size: 1.1em;">${timeDiff}</div>
                        </div>`;

                        if (index === platform.route_list.length - 1 && platform.route_list.length > 4) html += `</div>`;
                    });

                    if (platform.route_list.length > 4) {
                        const containerId = `extra-container-${platform.platform_id}`;
                        const isExpanded = expandedPlatforms.has(containerId);
                        const btnText = isExpanded ? 'æ”¶èµ·éƒ¨åˆ†ç­æ¬¡' : `æŸ¥çœ‹æ›´å¤š (é‚„æœ‰ ${platform.route_list.length - 4} ç­)`;
                        html += `<button class="eta-more-btn" onclick="event.stopPropagation(); window.toggleETAMore(this, '${containerId}')" data-expanded="${isExpanded}">${btnText}</button>`;
                    }
                } else {
                    html += `<div style="text-align:center; padding:20px; color:#999; font-size:0.9em;">æ˜¯æ—¥åˆ—è»Šæœå‹™å·²ç¶“ä¸­æ­¢</div>`;
                }
                html += `</div>`; 
            });

            // --- 4. Skeleton -> é€€å ´ ---
            if (isEntrance) {
                listArea.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
                listArea.style.opacity = '0';
                listArea.style.transform = 'translateY(10px)';
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            // --- 5. Station B -> é€²å ´ ---
            if (isEntrance) {
                listArea.style.transition = 'none';
                listArea.style.transform = 'translateY(15px)';
            }

            listArea.innerHTML = html || "<div style='text-align:center; padding:30px; color:grey;'>ç›®å‰æ²’æœ‰ç­æ¬¡è³‡è¨Š</div>";
            
            void listArea.offsetHeight;

            if (isEntrance) {
                listArea.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                listArea.style.opacity = '1';
                listArea.style.transform = 'translateY(0)';
                listArea.classList.add('entrance-anim');
            } else {
                listArea.style.transition = 'opacity 0.5s ease';
                listArea.style.transform = 'none';
                listArea.style.opacity = '1';
                listArea.classList.remove('entrance-anim');
            }
        }
    } catch (error) {
        console.error("Fetch Error:", error);
        listArea.style.opacity = '1';
        listArea.style.transform = 'none';
    } finally {
        window.isEtaFetching = false;
        listArea.classList.remove('updating');
    }

    if (document.getElementById('etaPage')?.style.display !== 'none') {
        window.etaTimer = setTimeout(() => updateETAList(false), 10000);
    }
}


// --- åŒæ­¥é‚è¼¯ ---
window.syncETAList = function(source) {
    const input = document.getElementById('etaStationInput');
    const select = document.getElementById('etaStationSelect');
    
    // åªè¦æ˜¯ä¾†è‡ª select (æ‰‹å‹•æ›ç«™) æˆ– tab (åˆ‡æ›åˆ†é )ï¼Œå°±æ‡‰è©²æœ‰æ»‘å…¥å‹•ç•«
    const shouldAnimate = (source === 'select' || source === 'input' || source === 'tab');
    
    if (source === 'input') {
        const val = parseInt(input.value);
        if (!isNaN(val)) select.value = val;
    } else {
        input.value = select.value;
    }
    
    updateETAList(shouldAnimate);
};

// --- å…¶é¤˜è¼”åŠ©é‚è¼¯ ---
window.toggleETAMore = function(btn, containerId) {
    const container = document.getElementById(containerId);
    const isExpanded = btn.getAttribute('data-expanded') === 'true';
    const remainingCount = container.querySelectorAll('.eta-row').length;

    if (!isExpanded) {
        container.classList.add('expanded');
        btn.innerText = "æ”¶èµ·éƒ¨åˆ†ç­æ¬¡";
        btn.setAttribute('data-expanded', 'true');
    } else {
        container.classList.remove('expanded');
        btn.innerText = `æŸ¥çœ‹æ›´å¤š (é‚„æœ‰ ${remainingCount} ç­)`;
        btn.setAttribute('data-expanded', 'false');
    }
};

window.showETAMenu = function(location, route, dest, runNo, carId) {
    const existing = document.getElementById('eta-action-sheet');
    if (existing) existing.remove();

    const html = `
    <div id="eta-action-sheet" class="action-sheet-overlay" onclick="this.remove()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10000; display: flex; align-items: flex-end;">
        <div class="action-sheet-content" onclick="event.stopPropagation()" style="width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; max-width: 600px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 15px; color: #888; font-size: 0.9em;">
                ${carId} ${route} (${runNo}) å¾€ ${dest} ï¼ è«‹é¸æ“‡
            </div>
            <button onclick="handleETAAciton('trace', '${carId}')" style="width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #007aff; background: #f0f7ff; color: #007aff; font-size: 1.05em; font-weight: 600; cursor: pointer; text-align: center; display: ${carId ? 'block' : 'none'};">
                ğŸ” æŸ¥è©¢è»Šç·¨è¡Œè¹¤
            </button>
            <button onclick="handleETAAciton('report', '${location}', '${route}', '${dest}', '${runNo}', '${carId}')" style="width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #007aff; background: #f0f7ff; color: #007aff; font-size: 1.05em; font-weight: 600; cursor: pointer; text-align: center;">
                ğŸ“ æ›´æ–°è»Šåºè¡Œè¹¤
            </button>
            <button onclick="document.getElementById('eta-action-sheet').remove()" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: #f5f5f5; color: #333; font-size: 1.05em; cursor: pointer;">
                å–æ¶ˆ
            </button>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
};

window.handleETAAciton = function(type, ...args) {
    const sheet = document.getElementById('eta-action-sheet');
    if (sheet) sheet.remove();

    if (type === 'trace') {
        const carId = args[0];
        const liveBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.includes('è¡Œè¹¤'));
        window.switchTab('livePage', liveBtn);
        setTimeout(() => {
            const searchInput = document.getElementById('searchComp');
            if (searchInput) {
                searchInput.value = carId;
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }, 300);
    } else if (type === 'report') {
        const [location, route, dest, runNo, carId] = args;
        if (typeof window.reportETA === 'function') {
            window.reportETA(route, dest, runNo, location, carId);
        }
    }
};


window.searchCarWhereabouts = function(carId) {
    if (!carId) return;

    // A. é—œé–‰å´é‚Šèœå–® (è§£æ±ºé¸å–®ä¸æ¶ˆå¤±å•é¡Œ)
    const sideMenu = document.getElementById('sideMenu');
    const overlay = document.querySelector('.overlay');
    if (sideMenu) sideMenu.classList.remove('active');
    if (overlay) overlay.style.display = 'none';

    // B. å¼·åˆ¶åˆ‡æ›å›ã€Œä¸»é ã€(ID: mainPage)
    const mainTabBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.includes('ä¸»é '));
    if (window.switchTab) window.switchTab('mainPage', mainTabBtn);

    // C. å¡«å…¥æœå°‹è³‡æ–™ (å¢åŠ å»¶é²ï¼Œç¢ºä¿åˆ†é å·²é¡¯ç¤º)
    setTimeout(() => {
        const searchInput = document.getElementById('searchComp');
        const routeSelect = document.getElementById('searchRoute');
        const dateInput = document.getElementById('searchDate');

        if (searchInput) {
            // 1. é‡ç½®æ—¥æœŸ
            if (dateInput) {
                // å¦‚æœæ‚¨æœ‰ getOperationalDate() å‡½æ•¸å°±ç”¨å®ƒï¼Œæ²’æœ‰å°±ç”¨ä»Šæ—¥æ—¥æœŸ
                const today = typeof window.getOperationalDate === 'function' 
                              ? window.getOperationalDate() 
                              : new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }

            // 2. æ¸…é™¤è·¯ç·šéæ¿¾
            if (routeSelect) routeSelect.value = "";
            
            // 3. å¡«å…¥è»Šç·¨
            searchInput.value = carId;
            
            // 4. è§¸ç™¼è¼¸å…¥äº‹ä»¶ä»¥åŸ·è¡Œéæ¿¾
            searchInput.dispatchEvent(new Event('input', { bubbles: true }));
            
            // 5. å¼·åˆ¶åŸ·è¡Œæ¸²æŸ“èˆ‡æ²å‹•
            if (typeof window.renderAll === 'function') window.renderAll();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            console.log("æŸ¥è©¢æˆåŠŸï¼Œå·²é‡ç½®æ—¥æœŸä¸¦å¡«å…¥è»Šç·¨:", carId);
        }
    }, 200);
};

window.switchTab = function (pageId, btn) {
    // 1. åˆ‡æ›é¡¯ç¤ºç‹€æ…‹
    document.querySelectorAll('.page').forEach(p => {
        p.style.display = 'none';
        p.classList.remove('active');
    });

    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.style.display = 'block';
        setTimeout(() => targetPage.classList.add('active'), 10);
    }

    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');

    // --- é—œé–‰æ­·å²è¨˜éŒ„ä»‹é¢ ---
    const overlay = document.getElementById('detailOverlay');
    document.body.style.overflow = ''; 
    if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => {
            if (!overlay.classList.contains('show')) {
                overlay.style.display = 'none';
            }
        }, 300);
    }

    // --- é‡å° ETA é é¢ï¼šè‡ªå‹•å¥—ç”¨åº§æ¨™èˆ‡æ›´æ–° ---
if (pageId === 'etaPage') {
    // åªè¦æœ‰åº§æ¨™ï¼ˆä¸ç®¡æ˜¯å“ªä¸€é æ‹¿åˆ°çš„ï¼‰ï¼Œå°±è‡ªå‹•æ›´æ–°è»Šç«™
    if (window.cachedUserCoords) {
        autoSelectETAStationByCache();
    }

        // åŸæœ‰çš„æ›´æ–°åˆ—è¡¨é‚è¼¯
        if (typeof window.updateETAList === 'function') {
            setTimeout(() => {
                window.updateETAList(true); 
            }, 50);
        }
    }

    // --- é‡å°å ±å‘Š/å¿«è¨Šé é¢ï¼šé‡æ–°æ¸²æŸ“ ---
    if (pageId === 'mainPage' || pageId === 'flashPage') {
        if (typeof window.renderAll === 'function') {
            requestAnimationFrame(() => {
                setTimeout(() => window.renderAll(), 50);
            });
        }
    }
};

/**
 * è¼”åŠ©å‡½æ•¸ï¼šå°ˆç”¨æ–¼åˆ‡æ›åˆ†é æ™‚éœé»˜åŒ¹é… ETA è»Šç«™
 * é¿å…ç›´æ¥å‘¼å« useETAGPSLocation ä»¥å…é¡¯ç¤ºã€Œæœå°‹ä¸­ã€æˆ–é‡è¤‡å½ˆå‡º Toast
 */
function autoSelectETAStationByCache() {
    const stationSelect = document.getElementById('etaStationSelect');
    if (!window.cachedUserCoords || !stationSelect || stationSelect.options.length <= 1) return;

    const { lat, lng } = window.cachedUserCoords;
    let bestIdx = -1;
    let minD = Infinity;

    for (let i = 0; i < stationSelect.options.length; i++) {
        const optionText = stationSelect.options[i].text;
        let matchKey = Object.keys(stationCoordinates).find(k => optionText.includes(k));
        if (matchKey) {
            const dist = calculateDistance(lat, lng, stationCoordinates[matchKey][0], stationCoordinates[matchKey][1]);
            if (dist < minD) {
                minD = dist;
                bestIdx = i;
            }
        }
    }

    if (bestIdx !== -1) {
        // åªæœ‰ç•¶ä½ç½®çœŸçš„ä¸åŒæ™‚æ‰åˆ‡æ›ï¼Œé¿å…ä¸å¿…è¦çš„ API åˆ·æ–°
        if (stationSelect.selectedIndex !== bestIdx) {
            stationSelect.selectedIndex = bestIdx;
            // è§¸ç™¼åŒæ­¥é‚è¼¯ï¼ˆä¾‹å¦‚é‡æ–° fetch ETAï¼‰
            if (typeof window.syncETAList === 'function') {
                window.syncETAList('select');
            }
        }
    }
}




/**
 * ç”± ETA ä»‹é¢è§¸ç™¼çš„å¼·åˆ¶å ±å‘ŠåŠŸèƒ½
 */
window.reportETA = function(route, dest, runNo, location, carId) {
    // 1. é–‹å•Ÿä¿è­·é–ï¼Œé˜²æ­¢è¢« switchTab é‡ç½®
    window.isReportingETA = true;

    // 2. åˆ‡æ›åˆ°ã€Œå ±å‘Šã€åˆ†é 
    const reportBtn = Array.from(document.querySelectorAll('.tab-btn'))
        .find(b => b.innerText.includes('å ±å‘Š'));
    if (window.switchTab) window.switchTab('mainPage', reportBtn);

    // 3. å»¶é²å¡«å…¥è³‡æ–™ï¼Œç¢ºä¿åˆ†é å·²é¡¯ç¤º
    setTimeout(() => {
        const routeSelect = document.getElementById('routeSelect');
        const destSelect = document.getElementById('directionSelect');
        const carInput = document.getElementById('carId');
        const locSelect = document.getElementById('stationSelect');
        const runInput = document.getElementById('runNo');

        // A. è¨­å®šè·¯ç·šä¸¦è§¸ç™¼ change äº‹ä»¶
        // é€™æœƒå¼·åˆ¶åŸ·è¡Œ onRouteUpdate() ä»¥ç”Ÿæˆè©²è·¯ç·šå°æ‡‰çš„ç›®çš„åœ°å’Œè»Šç«™æ¸…å–®
        if (routeSelect) {
            routeSelect.value = route;
            routeSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }

        // B. å†æ¬¡å»¶é²ï¼Œç­‰å¾…ä¸‹æ‹‰é¸å–® (Option) ç”Ÿæˆå®Œç•¢
        setTimeout(() => {
            // è¨­å®šè»Šåº (è»Šæ¬¡)
            if (runInput) {
				const isInvalid = !runNo || runNo === "---" || runNo === "undefined" || runNo === "undefin";
				runInput.value = isInvalid ? "" : runNo;
			}

            // è¨­å®šç›®çš„åœ°
            if (destSelect) {
                destSelect.value = dest;
            }
            
            // è¨­å®šè»Šç·¨
            if (carInput) carInput.value = carId || "";

            // è¨­å®šä½ç½® (è»Šç«™)
            if (locSelect) {
                // å˜—è©¦ç›´æ¥åŒ¹é… (ä¾‹å¦‚ "å±¯é–€ç¢¼é ­")
                locSelect.value = location;
                
                // å¦‚æœå¤±æ•—ï¼ˆä¾‹å¦‚é¸å–®å…§æ˜¯ "001 å±¯é–€ç¢¼é ­"ï¼‰ï¼Œå‰‡é€²è¡Œæ¨¡ç³ŠåŒ¹é…
                if (!locSelect.value) {
                    for (let opt of locSelect.options) {
                        if (opt.text.includes(location)) {
                            locSelect.value = opt.value;
                            break;
                        }
                    }
                }
            }
        }, 150); 
    }, 200);
};



window.fillReportFromETA = function(route, dest, location, runNo, carId) {
    // 1. åˆ‡æ›åˆ°å ±å‘Šåˆ†é 
    showPage('report');

    // 2. å–å¾—è¡¨å–®å…ƒç´ 
    const routeSelect = document.getElementById('routeSelect');
    const destSelect = document.getElementById('directionSelect');
    const carInput = document.getElementById('carId');
    const locSelect = document.getElementById('stationSelect');
    const runInput = document.getElementById('runNo');

    // 3. è¨­å®šè·¯ç·šä¸¦è§¸ç™¼æ›´æ–°ï¼ˆä»¥ç”Ÿæˆæ­£ç¢ºçš„è»Šç«™æ¸…å–®ï¼‰
    if (routeSelect) {
        routeSelect.value = route;
        routeSelect.dispatchEvent(new Event('change', { bubbles: true }));
    }

    // 4. å»¶é² 100 æ¯«ç§’ç­‰å¾…ä¸‹æ‹‰é¸å–®æ›´æ–°å¾Œå¡«å…¥å…¶é¤˜è³‡æ–™
    setTimeout(() => {
        if (runInput) {
			const isInvalid = !runNo || runNo === "---" || runNo === "undefined" || runNo === "undefin";
			runInput.value = isInvalid ? "" : runNo;
		}

        if (destSelect) destSelect.value = dest;
        if (carInput) carInput.value = carId || "";
        
        if (locSelect) {
            locSelect.value = location;
            // è‹¥ç„¡æ³•ç›´æ¥åŒ¹é…ï¼ˆä¾‹å¦‚åç¨±åŒ…å«ç·¨è™Ÿï¼‰ï¼Œå‰‡é€²è¡Œæ¨¡ç³ŠåŒ¹é…
            if (!locSelect.value) {
                for (let opt of locSelect.options) {
                    if (opt.text.includes(location)) {
                        locSelect.value = opt.value;
                        break;
                    }
                }
            }
        }
    }, 100);
};

window.showToast = (msg) => {
    let toast = document.getElementById('customToast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'customToast';
        toast.className = 'toast-msg';
        document.body.appendChild(toast);
    }
    toast.innerText = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
};



// --- 1. è»Šç«™åº§æ¨™æ•¸æ“šåº« ---
const stationCoordinates = {
    "å±¯é–€ç¢¼é ­": [22.372, 113.966], "ç¾æ¨‚": [22.374, 113.964], "è´è¶": [22.376, 113.963],
    "è¼•éµè»Šå» ": [22.379, 113.965], "é¾é–€": [22.382, 113.967], "é’å±±æ‘": [22.385, 113.968],
    "é’é›²": [22.389, 113.969], "å»ºå®‰": [22.393, 113.971], "æ²³ç”°": [22.395, 113.973],
    "è”¡æ„æ©‹": [22.397, 113.975], "æ¾¤è±": [22.401, 113.974], "å±¯é–€é†«é™¢": [22.405, 113.975],
    "å…†åº·": [22.413, 113.978], "éº’éºŸ": [22.411, 113.976], "é’æ¾": [22.408, 113.973],
    "å»ºç”Ÿ": [22.406, 113.970], "ç”°æ™¯": [22.404, 113.967], "è‰¯æ™¯": [22.403, 113.964],
    "æ–°åœ": [22.402, 113.962], "çŸ³æ’": [22.400, 113.965], "å±±æ™¯ (åŒ—)": [22.397, 113.963],
    "å±±æ™¯ (å—)": [22.395, 113.964], "é³´ç´": [22.396, 113.966], "å¤§èˆˆ (åŒ—)": [22.401, 113.970],
    "å¤§èˆˆ (å—)": [22.399, 113.971], "éŠ€åœ": [22.401, 113.972], "å…†ç¦§": [22.373, 113.967],
    "å±¯é–€æ³³æ± ": [22.381, 113.972], "è±æ™¯åœ’": [22.384, 113.974], "å…†éºŸ": [22.387, 113.976],
    "å®‰å®š": [22.388, 113.977], "å‹æ„›": [22.387, 113.978], "å¸‚ä¸­å¿ƒ": [22.392, 113.976],
    "å±¯é–€": [22.395, 113.974], "æ¯æ¸¡": [22.397, 113.977], "ä½•ç¦å ‚": [22.399, 113.978],
    "æ–°å¢Ÿ": [22.402, 113.980], "æ™¯å³°": [22.404, 113.982], "é³³åœ°": [22.408, 113.980],
    "è—åœ°": [22.418, 113.981], "æ³¥åœ": [22.422, 113.983], "é¾å±‹æ‘": [22.426, 113.988],
    "æ´ªæ°´æ©‹": [22.431, 113.994], "æ´ªå¤©è·¯": [22.433, 113.996], "å¡˜åŠæ‘": [22.438, 114.002],
    "å±å±±": [22.441, 114.006], "æ°´é‚Šåœ": [22.443, 114.018], "è±å¹´è·¯": [22.443, 114.022],
    "åº·æ¨‚è·¯": [22.444, 114.028], "å¤§æ£ è·¯": [22.444, 114.031], "å…ƒæœ—": [22.445, 114.035],
    "å‘å°¾æ‘": [22.446, 114.004], "å¤©æ°´åœ": [22.448, 114.005], "å¤©æ…ˆ": [22.451, 114.008],
    "å¤©è€€": [22.449, 114.003], "æ¨‚æ¹–": [22.449, 114.001], "å¤©æ¹–": [22.451, 114.002],
    "éŠ€åº§": [22.455, 114.004], "å¤©ç‘": [22.455, 113.999], "é Œå¯Œ": [22.457, 113.998],
    "å¤©å¯Œ": [22.461, 113.997], "ç¿ æ¹–": [22.461, 114.002], "å¤©æ¦®": [22.458, 114.003],
    "å¤©æ‚…": [22.460, 114.000], "å¤©ç§€": [22.463, 114.001], "æ¿•åœ°å…¬åœ’": [22.466, 114.003],
    "å¤©æ’": [22.468, 114.001], "å¤©é€¸": [22.467, 113.999], "ä¸‰è–": [22.383, 113.982]
};

// --- 0. å…¨åŸŸåº§æ¨™å¿«å– ---
window.cachedUserCoords = null; 

window.syncAllPagesLocation = function(lat, lng) {
    // 1. æ›´æ–°å…¨åŸŸè®Šæ•¸
    window.cachedUserCoords = { lat, lng };

    // 2. [Live Page] è‡ªå‹•å°‹æ‰¾ä¸¦é¸å–æœ€è¿‘è»Šç«™
    const whereaboutSelect = document.getElementById('stationSelect');
    if (whereaboutSelect && whereaboutSelect.options.length > 0) {
        let bestVal = "";
        let minD = Infinity;
        for (let opt of whereaboutSelect.options) {
            let matchKey = Object.keys(stationCoordinates).find(k => opt.text.includes(k));
            if (matchKey) {
                const dist = calculateDistance(lat, lng, stationCoordinates[matchKey][0], stationCoordinates[matchKey][1]);
                if (dist < minD) { minD = dist; bestVal = opt.value; }
            }
        }
        if (bestVal && whereaboutSelect.value !== bestVal) {
            whereaboutSelect.value = bestVal;
            // è§¸ç™¼ change äº‹ä»¶è®“å ±æ–™é é¢çš„åº§æ¨™è¼¸å…¥æ¡†ç­‰é‚è¼¯é€£å‹•
            whereaboutSelect.dispatchEvent(new Event('change'));
            const status = document.getElementById('gpsStatus');
            if (status) status.innerText = "ä½ç½®å·²åŒæ­¥";
        }
    }

    // 3. [ETA Page] è‡ªå‹•å°‹æ‰¾ä¸¦é¸å–æœ€è¿‘è»Šç«™
    const etaSelect = document.getElementById('etaStationSelect');
    if (etaSelect && etaSelect.options.length > 0) {
        let bestIdx = -1;
        let minD = Infinity;
        for (let i = 0; i < etaSelect.options.length; i++) {
            const optionText = etaSelect.options[i].text;
            let matchKey = Object.keys(stationCoordinates).find(k => optionText.includes(k));
            if (matchKey) {
                const dist = calculateDistance(lat, lng, stationCoordinates[matchKey][0], stationCoordinates[matchKey][1]);
                if (dist < minD) { minD = dist; bestIdx = i; }
            }
        }
        if (bestIdx !== -1 && etaSelect.selectedIndex !== bestIdx) {
            etaSelect.selectedIndex = bestIdx;
            // è§¸ç™¼ ETA åŒæ­¥é‚è¼¯ (fetch åˆ—è¡¨)
            if (typeof window.syncETAList === 'function') {
                window.syncETAList('select');
            }
        }
    }
};

// --- 1. è·é›¢è¨ˆç®—æ³• ---
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // åœ°çƒåŠå¾‘ km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// --- 2. Whereabout é é¢ GPS å®šä½å‡½æ•¸ (é›™å‘åŒæ­¥ç‰ˆ) ---
window.useGPSLocation = function() {
    const stationSelect = document.getElementById('stationSelect');
    if (stationSelect.options.length <= 1) {
        window.showToast("è«‹å…ˆé¸æ“‡è·¯ç¶«");
        return;
    }

    if (window.cachedUserCoords) {
        window.syncAllPagesLocation(window.cachedUserCoords.lat, window.cachedUserCoords.lng);
		setTimeout(() => {
        window.syncAllPagesLocation(window.cachedUserCoords.lat, window.cachedUserCoords.lng);
    }, 100);
        return;
    }

    const status = document.getElementById('gpsStatus');
    if (status) status.innerText = "æ­£åœ¨å–å¾—ä½ç½®...";

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const uLat = pos.coords.latitude;
            const uLng = pos.coords.longitude;
            
            // é—œéµï¼šå‘¼å«å…¨åŸŸåŒæ­¥
            window.syncAllPagesLocation(uLat, uLng);
            
            // å ±æ–™é é¢å°ˆå±¬ï¼šæ›´æ–°åº§æ¨™è¼¸å…¥æ¡†
            const geoInput = document.getElementById('geoCoords');
            if(geoInput) geoInput.value = `${uLat.toFixed(6)},${uLng.toFixed(6)}`;
        },
        (err) => { if (status) status.innerText = "å®šä½å¤±æ•—"; },
        { enableHighAccuracy: true, timeout: 10000 }
    );
};

window.syncAllPagesLocation = function(lat, lng) {
    // 1. æ›´æ–°å…¨åŸŸè®Šæ•¸
    window.cachedUserCoords = { lat, lng };

    // 2. æ›´æ–° Whereabout (Live) é é¢é¸å–®
    const whereaboutSelect = document.getElementById('stationSelect');
    if (whereaboutSelect && whereaboutSelect.options.length > 1) {
        let bestVal = "";
        let minD = Infinity;
        for (let opt of whereaboutSelect.options) {
            let matchKey = Object.keys(stationCoordinates).find(k => opt.text.includes(k));
            if (matchKey) {
                const dist = calculateDistance(lat, lng, stationCoordinates[matchKey][0], stationCoordinates[matchKey][1]);
                if (dist < minD) { minD = dist; bestVal = opt.value; }
            }
        }
        if (bestVal && whereaboutSelect.value !== bestVal) {
            whereaboutSelect.value = bestVal;
            whereaboutSelect.dispatchEvent(new Event('change'));
            const status = document.getElementById('gpsStatus');
            if (status) status.innerText = "å·²æ ¹æ“šä½ç½®æ›´æ–°è»Šç«™";
        }
    }

    // 3. æ›´æ–° ETA é é¢é¸å–®
    if (typeof autoSelectETAStationByCache === 'function') {
        autoSelectETAStationByCache();
    }
};

window.useETAGPSLocation = function() {
    const btn = document.getElementById('etaGpsBtn');
    if (window.cachedUserCoords) {
        window.syncAllPagesLocation(window.cachedUserCoords.lat, window.cachedUserCoords.lng);
        return;
    }

    const originalText = "å®šä½";
    btn.innerText = "æœå°‹ä¸­";
    btn.disabled = true;

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            // é—œéµï¼šå‘¼å«å…¨åŸŸåŒæ­¥
            window.syncAllPagesLocation(pos.coords.latitude, pos.coords.longitude);
            btn.innerText = originalText;
            btn.disabled = false;
        },
        (err) => {
            btn.innerText = originalText;
            btn.disabled = false;
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
};

// --- 4. è‡ªå‹•å¥—ç”¨å¿«å– (ç”¨æ–¼åˆ‡æ›è·¯ç¶«æ™‚) ---
function onWhereaboutStationListReady() {
    const locSelect = document.getElementById('stationSelect');
    if (window.cachedUserCoords && locSelect) {
        const { lat, lng } = window.cachedUserCoords;
        let bestVal = "";
        let minD = Infinity;

        for (let opt of locSelect.options) {
            let matchKey = Object.keys(stationCoordinates).find(k => opt.text.includes(k));
            if (matchKey) {
                const dist = calculateDistance(lat, lng, stationCoordinates[matchKey][0], stationCoordinates[matchKey][1]);
                if (dist < minD) { minD = dist; bestVal = opt.value; }
            }
        }

        if (bestVal) {
            locSelect.value = bestVal;
        }
    }
}

// --- éµç›¤å¿«æ·éµæ”¯æ´ (PC/å¹³æ¿å„ªåŒ–) ---
document.addEventListener('keydown', function(e) {
    const activeElem = document.activeElement;
    const isInput = activeElem.tagName === 'INPUT' || activeElem.tagName === 'TEXTAREA';

    // æŒ‰ä¸‹ "/" éµ
    if (e.key === '/' && !isInput) {
        e.preventDefault(); // é˜²æ­¢åœ¨è¼¸å…¥æ¡†ç”¢ç”Ÿ "/"

        // æª¢æŸ¥ç•¶å‰æ˜¯å¦åœ¨ etaPage
        const etaPage = document.getElementById('etaPage');
        const isOnEtaPage = etaPage && etaPage.style.display !== 'none';

        if (isOnEtaPage) {
            // æƒ…æ³ Aï¼šåœ¨ etaPageï¼Œç›´æ¥èšç„¦è»Šç«™è¼¸å…¥æ¡†
            const etaInput = document.getElementById('etaStationInput');
            if (etaInput) {
                etaInput.focus();
                // å¦‚æœéœ€è¦å…¨é¸æ–‡å­—æ–¹ä¾¿ç›´æ¥æ›¿æ›è»Šç«™ç·¨è™Ÿï¼Œå¯åŠ å…¥ä¸‹ä¸€è¡Œï¼š
                // etaInput.select(); 
            }
        } else {
            // æƒ…æ³ Bï¼šä¸åœ¨ etaPageï¼Œè·³è½‰åˆ° livePage ä¸¦èšç„¦è»Šç·¨æœå°‹
            const liveTabBtn = document.querySelector('button[onclick*="livePage"]');
            if (liveTabBtn) {
                window.switchTab('livePage', liveTabBtn);
            }

            setTimeout(() => {
                const searchInput = document.getElementById('searchComp');
                if (searchInput) {
                    searchInput.focus();
                }
            }, 50);
        }
    }

    // æŒ‰ä¸‹ "Esc" éµï¼šé€šç”¨çš„é—œé–‰/å–æ¶ˆèšç„¦é‚è¼¯
    if (e.key === 'Escape') {
        if (document.getElementById('detailOverlay')?.style.display === 'flex') {
            window.closeDetail();
        }
        if (isInput) activeElem.blur();
        
        const actionSheet = document.getElementById('eta-action-sheet');
        if (actionSheet) actionSheet.remove();
    }
});
</script>



</body></html>
