<!DOCTYPE html>
<html lang="zh-Hant"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRSpotter</title>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBErRYvF2got2vrwY0-a8KSc8JVWKdeksQ",
            authDomain: "lr-whereabout-report.firebaseapp.com",
            projectId: "lr-whereabout-report",
            storageBucket: "lr-whereabout-report.firebasestorage.app",
            messagingSenderId: "939888577145",
            appId: "1:939888577145:web:b4b51b3a2f3b8bd685e2a8",
            databaseURL: "https://lr-whereabout-report-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const liveRef = ref(db, 'live_reports');

        
// === Special Trains (from Firebase config/special_trains) ===
let specialTrains = {};
const specialIcons = {};
const iconDesc = {};

const specialTrainRef = ref(db, 'config/special_trains');

onValue(specialTrainRef, (snapshot) => {
    const data = snapshot.val() || {};

    // é‡ç½®è³‡æ–™
    specialTrains = data;
    Object.keys(specialIcons).forEach(k => delete specialIcons[k]);
    Object.keys(iconDesc).forEach(k => delete iconDesc[k]);

    // å–å¾—ç•¶å‰ç‡Ÿé‹æ—¥æœŸ (YYYY-MM-DD)
    const today = (typeof window.getOperationalDate === 'function') 
        ? window.getOperationalDate() 
        : new Date().toLocaleDateString('en-CA');

    Object.entries(data).forEach(([icon, cfg]) => {
        // æ–°å¢ï¼šæ—¥æœŸç¯„åœåˆ¤æ–·
        const startDate = cfg.StartDate; // é æœŸæ ¼å¼: "YYYY-MM-DD"
        const endDate = cfg.EndDate;     // é æœŸæ ¼å¼: "YYYY-MM-DD"

        // å¦‚æœè¨­å®šäº†é–‹å§‹æ—¥æœŸä¸”ç›®å‰å°šæœªé–‹å§‹ï¼Œå‰‡è·³é
        if (startDate && today < startDate) return;
        // å¦‚æœè¨­å®šäº†çµæŸæ—¥æœŸä¸”ç›®å‰å·²ç¶“çµæŸï¼Œå‰‡è·³é
        if (endDate && today > endDate) return;

        iconDesc[icon] = cfg.desc || "";
        (cfg.cars || []).forEach(cid => {
            specialIcons[cid] = icon;
        });
    });

    // ä½¿ç”¨é˜²æŠ–æ¸²æŸ“æ›´æ–°ä»‹é¢
    window.debouncedRenderAll();

    if (window.currentDetailCarId && typeof window.showCarHistory === 'function') {
        window.showCarHistory(window.currentDetailCarId, true);
    }
});
// ==========================================================

        
		
		const internalRouteMap = {
			"509": { rteKey: "614Px615P", dRte: "614P å…†åº· & 615P å±¯é–€ç¢¼é ­" },
			"510": { rteKey: "615Px614P", dRte: "615P å…†åº· & 614P å±¯é–€ç¢¼é ­" },
			"707": { rteKey: "751P", dRte: "751P" },
			"708": { rteKey: "761P", dRte: "761P" },
			"TMV": { rteKey: "TMV", dRte: "å±¯é–€å°ˆç¶«" },
			"YLV": { rteKey: "YLV", dRte: "å…ƒæœ—å°ˆç¶«" },
			"DEP": { rteKey: "å›å» ", dRte: "å›å» " },
			"NIS": { rteKey: "ä¸è¼‰å®¢", dRte: "ä¸è¼‰å®¢" },
			"SPL": { rteKey: "å°ˆç”¨", dRte: "å°ˆç”¨" }
		};

        window.db = db;
        window.user = null;
        window.reportGroups = {};
        window.favorites = new Set(); 
		window.isReportingETA = false; // Flag to prevent auto-selection from overwriting ETA data
		
        // æ ¸å¿ƒ Toggle åŠŸèƒ½ï¼šè™•ç† Set ä¸¦åŒæ­¥ Firebase
        window.toggleFav = async (fid, event) => {
            if (event) event.stopPropagation();
            if (!window.user) return window.showToast("è«‹å…ˆç™»å…¥");
            
            const fidStr = String(fid);
            if (!(window.favorites instanceof Set)) {
                window.favorites = new Set();
            }

            if (window.favorites.has(fidStr)) {
                window.favorites.delete(fidStr);
            } else {
                window.favorites.add(fidStr);
            }
            
            try {
                const userFavRef = ref(db, `users/${window.user.uid}/favs`);
                await set(userFavRef, Array.from(window.favorites));
                // æˆåŠŸåŒæ­¥å¾Œç”± onValue ç›£è½å™¨è§¸ç™¼ renderAllï¼Œæˆ–åœ¨æ­¤æ‰‹å‹•è§¸ç™¼ä¸€æ¬¡ç¢ºä¿åæ‡‰é€Ÿåº¦
                window.renderAll();
            } catch (e) {
                console.error("Firebase sync failed:", e);
                window.showToast("åŒæ­¥å¤±æ•—ï¼š" + e.message);
            }
        };

        window.isAdmin = false;

        window.getOperationalDate = (timestamp) => {
            const date = timestamp ? new Date(timestamp) : new Date();
            const hour = date.getHours();
            if (hour < 5) {
                date.setHours(date.getHours() - 5);
            }
            return date.toLocaleDateString('en-CA');
        };

        window.login = () => signInWithPopup(auth, provider).catch(e => window.showToast(e.message));
        window.logout = () => signOut(auth);

// ä¿®æ”¹å¾Œçš„ç™»å…¥ç‹€æ…‹ç›£è½
onAuthStateChanged(auth, async (user) => {
    window.user = user;
    const loginBtn = document.getElementById('loginBtn');
    let adminTag = document.getElementById('admin-tag');

    if (user) {
        loginBtn.innerText = `ç™»å‡º (${user.displayName.split(' ')[0]})`;
        loginBtn.onclick = window.logout;
        
        // --- å¾ Firebase è®€å–ç®¡ç†å“¡æ¬Šé™ ---
        try {
            const adminCheckRef = ref(db, `admins/${user.uid}`);
            const snapshot = await get(adminCheckRef);
            
            // å¦‚æœè©² UID åœ¨ admins ä¸‹ä¸”å€¼ç‚º trueï¼Œå‰‡è¨­ç‚º isAdmin
            if (snapshot.exists() && snapshot.val() === true) {
                window.isAdmin = true;
                if (!document.getElementById('admin-tag')) {
                    const adminTag = document.createElement('span');
                    adminTag.id = 'admin-tag';
                    adminTag.innerText = "ç®¡ç†å“¡";
                    adminTag.style = "background: #fffbe6; color: #d4a017; font-size: 0.5em; padding: 2px 6px; border-radius: 4px; border: 1px solid #ffe58f; font-weight: bold; vertical-align: middle; margin-left: 5px;";
                    document.querySelector('h1').parentElement.appendChild(adminTag);
                }
            } else {
                window.isAdmin = false;
                const existingTag = document.getElementById('admin-tag');
                if (existingTag) existingTag.remove();
            }
        } catch (e) {
            console.error("ç®¡ç†å“¡æ¬Šé™æª¢æŸ¥å¤±æ•—:", e);
            window.isAdmin = false;
        }
        // ----------------------------
        
        onValue(ref(db, `users/${user.uid}/favs`), (snap) => {
            const data = snap.val();
            const favArray = Array.isArray(data) ? data.map(String) : [];
            window.favorites = new Set(favArray);
            window.renderAll(); 
        });
    } else {
        loginBtn.innerText = "ç™»å…¥";
        loginBtn.onclick = window.login;
        window.isAdmin = false;
        if (adminTag) adminTag.remove();
        window.favorites = new Set();
        window.renderAll(); 
    }
});

        onValue(liveRef, (snapshot) => {
    window.reportGroups = snapshot.val() || {};
    
    window.debouncedRenderAll();
    
    if(window.currentDetailCarId) {
        window.showCarHistory(window.currentDetailCarId, true);
    } 
});

        function checkCarStatus(id) {
            const num = parseInt(id);
            if (isNaN(num)) return { valid: false, msg: "ç·¨è™Ÿæ ¼å¼éŒ¯èª¤" };
            const retiredList = [1014, 1027];
            const isRetiredRange = (num >= 1071 && num <= 1090) || (num >= 1201 && num <= 1210);
            if (retiredList.includes(num) || isRetiredRange) {
                return { valid: false, msg: `è»Šå¡ ${num} å·²é€€å½¹ï¼Œç„¡æ³•å ±å‘Šã€‚` };
            }
            const inRange = (num >= 1001 && num <= 1162) || (num >= 1201 && num <= 1220);
            if (!inRange) {
                return { valid: false, msg: `è»Šç·¨ ${num} è¶…å‡ºå¯å ±å‘Šç¯„åœ (1001-1162, 1201-1220)ã€‚` };
            }
            return { valid: true };
        }

        function validateComposition(carIds) {
            const nums = carIds.map(id => parseInt(id));
            const series12XX = nums.filter(n => n >= 1201 && n <= 1220);
            const series1000_1162 = nums.filter(n => n >= 1001 && n <= 1162);

            if (series12XX.length > 0) {
                if (nums.length === 1) {
                    return { valid: false, msg: `éŒ¯èª¤ï¼š${series12XX[0]} ç‚ºä¸è¨­é§•é§›å®¤çš„æ‹–å¡åˆ—è»Šï¼Œç„¡æ³•å–®ç¨è¡Œé§›ã€‚` };
                }
                if (series1000_1162.length === 0) {
                    return { valid: false, msg: `éŒ¯èª¤ï¼š${series12XX.join(', ')} ç‚ºä¸è¨­é§•é§›å®¤çš„æ‹–å¡åˆ—è»Šï¼Œç„¡æ³•å–®ç¨è¡Œé§›ã€‚` };
                }
            }
            return { valid: true };
        }

window.publishToFirebase = function(inputIds, newTrace) {
    // æ–°å¢ï¼šè™•ç†å…§éƒ¨ç·¨ç¢¼è½‰æ›
    if (internalRouteMap[newTrace.rteKey]) {
        const codec = internalRouteMap[newTrace.rteKey];
        newTrace.rteKey = codec.rteKey;
        newTrace.dRte = codec.dRte;
    }

    const fullId = inputIds.toString().replace(/\s+/g, '');
    const carIds = fullId.split('-');
    
    // 1. é©—è­‰å–®ä¸€è»Šå¡ç‹€æ…‹
    for (let id of carIds) {
        if (!id) continue;
        const status = checkCarStatus(id);
        if (!status.valid) { 
            // ä¿®æ”¹è™•ï¼šå°‡ alert æ”¹ç‚º showToast
            window.showToast(status.msg); 
            return; 
        }
    }

    // 2. é©—è­‰ç·¨çµ„åˆæ³•æ€§
    const compStatus = validateComposition(carIds);
    if (!compStatus.valid) { 
        // ä¿®æ”¹è™•ï¼šå°‡ alert æ”¹ç‚º showToast
        window.showToast(compStatus.msg); 
        return; 
    }

    // 3. é‡å° Phase 1 è»Šè¼›è¡Œé§› 705 ç¶«çš„ç‰¹æ®Šæç¤º (é€™éƒ¨åˆ†é€šå¸¸ä»å»ºè­°ç”¨ confirm æˆ–è‡ªè¨‚ Modal)
    const hasPhase1 = carIds.some(id => parseInt(id) >= 1001 && parseInt(id) <= 1090);
    if (hasPhase1 && newTrace.rteKey === "705") {
        if (!confirm("æç¤ºï¼šè«‹ç¢ºèªç›¸é—œè¡Œè¹¤å ±é“æ˜¯å¦æ­£ç¢ºï¼Ÿ")) return;
    }

    const now = Date.now();
    const promises = carIds.map(carId => {
        if (!carId) return;
        const nodeRef = ref(db, 'live_reports/' + carId);
        
        return get(nodeRef).then(snap => {
            let group = snap.val() || { carId: carId, traces: [] };
            if (!Array.isArray(group.traces)) group.traces = [];
            
            group.traces.unshift({ ...newTrace, fullId: fullId, timestamp: now });
            group.traces = group.traces.slice(0, 50);
            
            return set(nodeRef, group);
        });
    });

    Promise.all(promises)
    .then(() => {
        window.showToast("æäº¤æˆåŠŸï¼");
        const overlay = document.getElementById('detailOverlay');
        if (overlay && overlay.style.display === 'flex' && carIds.includes(window.currentDetailCarId)) {
            window.showCarHistory(window.currentDetailCarId, true); 
        }
    })
    .catch(e => {
        console.error("æäº¤å¤±æ•—:", e);
        // é€™è£¡å·²ç¶“æ˜¯ä½¿ç”¨ showMenuAlert
        window.showToast("æäº¤å¤±æ•—: " + e.message);
    });
};

window.deleteTrace = async function(carId, timestamp) {
    if (!window.user) { 
        window.showToast("è«‹å…ˆç™»å…¥"); 
        return; 
    }
    if (!window.isAdmin) { 
        window.showToast("æ¬Šé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯ç®¡ç†å“¡"); 
        return; 
    }

    // å‘¼å« 904 æ¨£å¼çš„é€šç”¨é¸å–®
    showActionSheet({
        title: `<b style="color: #ff3b30; font-size: 1.1em;">âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™æ¢è¨˜éŒ„å—ï¼Ÿ</b><br><span style="font-size: 0.85em; color: #888;">(è‹¥ç‚ºæ‹–å¡ç·¨çµ„è¨˜éŒ„å°‡æœƒåŒæ­¥æ¸…é™¤)</span>`,
        buttons: [
            {
                text: "åˆªé™¤",
                danger: true,
                onClick: async () => {
                    // ç¢ºä¿åœ¨ onClick å…§éƒ¨å¯ä»¥å­˜å– Firebase çš„æ–¹æ³•
                    // å¦‚æœä½ çš„ script æ˜¯ type="module"ï¼Œè«‹ç¢ºä¿ db, ref, get, set å·²ç¶“å®šç¾©åœ¨å…¨åŸŸæˆ–å¾ä¸Šæ–¹å¼•å…¥
                    try {
                        // 1. å–å¾—ä¸»è»Šè³‡æ–™åº«ç´€éŒ„
                        const primaryCarRef = ref(db, `live_reports/${carId}`);
                        const primarySnap = await get(primaryCarRef);
                        
                        if (!primarySnap.exists()) {
                            window.showToast('æ‰¾ä¸åˆ°è©²è»Šè¼›è³‡æ–™');
                            return;
                        }

                        let primaryData = primarySnap.val();
                        const targetTrace = (primaryData.traces || []).find(t => t.timestamp === timestamp);

                        if (!targetTrace) {
                            window.showToast('æ‰¾ä¸åˆ°è©²æ¢è¨˜éŒ„');
                            return;
                        }

                        // 2. åˆ¤æ–·æ˜¯å¦ç‚ºç·¨çµ„
                        let carIdsToUpdate = [carId];
                        if (targetTrace.fullId && targetTrace.fullId.includes('-')) {
                            carIdsToUpdate = targetTrace.fullId.split('-');
                        }

                        // 3. åŸ·è¡Œæ‰¹æ¬¡æ›´æ–°
                        const deletePromises = carIdsToUpdate.map(async (id) => {
                            const carRef = ref(db, `live_reports/${id}`);
                            const snap = await get(carRef);
                            if (snap.exists()) {
                                let data = snap.val();
                                if (data.traces && Array.isArray(data.traces)) {
                                    const newTraces = data.traces.filter(t => t.timestamp !== timestamp);
                                    if (newTraces.length !== data.traces.length) {
                                        data.traces = newTraces;
                                        return set(carRef, data);
                                    }
                                }
                            }
                            return Promise.resolve();
                        });

                        await Promise.all(deletePromises);

                        // 4. æ›´æ–°æœ¬åœ°ç·©å­˜
                        carIdsToUpdate.forEach(id => {
                            if (window.reportGroups && window.reportGroups[id] && Array.isArray(window.reportGroups[id].traces)) {
                                window.reportGroups[id].traces = window.reportGroups[id].traces.filter(t => t.timestamp !== timestamp);
                            }
                        });

                        // 5. åˆ·æ–°ä»‹é¢
                        if (document.getElementById('detailOverlay')?.style.display === 'flex') {
                            if (typeof window.showCarHistory === 'function') {
                                window.showCarHistory(window.currentDetailCarId, true);
                            }
                        }
                        
                        if (typeof window.renderAll === 'function') {
                            window.renderAll();
                        }

                        window.showToast('è¨˜éŒ„å·²åŒæ­¥åˆªé™¤');

                    } catch (error) {
                        console.error("Delete Error:", error);
                        window.showToast('åˆªé™¤å¤±æ•—ï¼š' + error.message);
                    }
                }
            }
        ]
    });
};

		const initApp = () => {
			const todayOpDate = window.getOperationalDate();
			if(document.getElementById('searchDate')) document.getElementById('searchDate').value = todayOpDate;
			if(document.getElementById('flashDate')) document.getElementById('flashDate').value = todayOpDate;
			if(document.getElementById('detailDateFilter')) document.getElementById('detailDateFilter').value = todayOpDate;
			
			// --- æ–°å¢ï¼šç›£è½æœå°‹æ–‡å­—æ¡†å³æ™‚æ›´æ–° ---
			const searchInput = document.getElementById('searchComp');
			if (searchInput) {
				searchInput.addEventListener('input', () => {
					window.renderAll();
				});
			}
			// --------------------------------
		
// åœ¨ index.html çš„ initApp å‡½æ•¸å…§å°‹æ‰¾ä¸¦ä¿®æ”¹ä»¥ä¸‹å€æ®µ
const rs = document.getElementById('routeSelect');
const srs = document.getElementById('searchRoute');

if (rs && srs) {
    rs.innerHTML = "";
    srs.innerHTML = '<option value="">æ‰€æœ‰è·¯ç¶«</option>';
    
    // å–å¾—æ’åºå¾Œçš„è·¯ç·šåç¨±é™£åˆ—
    const sortedRouteNames = Object.keys(routeCfg).sort();

    sortedRouteNames.forEach(r => {
        // å ±å‘Šé¸å–® (rs) ä¿æŒåŸæ¨£
        rs.innerHTML += `<option value="${r}">${r}</option>`;

        // æœå°‹é¸å–® (srs) è™•ç† 614P/615P åˆä½µé¡¯ç¤º
        if (r === "614P") {
            srs.innerHTML += `<option value="614P/615P">614P/615P</option>`;
        } else if (r === "615P") {
            // è·³éï¼Œå› ç‚ºå·²ç¶“åˆä½µåœ¨ 614P/615P
            return;
        } else {
            srs.innerHTML += `<option value="${r}">${r}</option>`;
        }
    });

            }
            if (typeof window.onRouteUpdate === "function") window.onRouteUpdate();
            if (typeof window.initETAStations === "function") window.initETAStations();
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

const processRouteDisplay = (dRte) => {
    if (!dRte) return "";
    const specials = ["ä¸è¼‰å®¢", "å¸æ©Ÿè¨“ç·´", "å›å» ", "å°ˆç”¨"];
    
    for (let s of specials) {
        if (dRte.startsWith(s)) {
            // æª¢æŸ¥æ˜¯å¦çœŸçš„æœ‰é¸æ“‡ç›®çš„åœ°
            // å¦‚æœ dRte å‰›å¥½ç­‰æ–¼ s (ä¾‹å¦‚ "ä¸è¼‰å®¢") 
            // æˆ–è€…ç›®çš„åœ°éƒ¨åˆ†æ˜¯é è¨­çš„ "-" æˆ– "---"
            if (dRte === s || dRte.includes(" å¾€ -") || dRte.includes(" å¾€ ---")) {
                return s; // éš±è—ç›®çš„åœ°ï¼Œåªé¡¯ç¤ºã€Œä¸è¼‰å®¢ã€
            }
            // å¦å‰‡è¡¨ç¤ºæœ‰å…·é«”ç›®çš„åœ°ï¼ˆä¾‹å¦‚ "ä¸è¼‰å®¢ å¾€ å…†åº·"ï¼‰ï¼Œå‰‡å›å‚³å®Œæ•´çš„ dRte
            return dRte;
        }
    }
    
    // ä»¥ä¸‹ä¿ç•™ä½ åŸå§‹çš„é‚è¼¯
    if (dRte.includes(" å¾€ -")) return dRte.replace(" å¾€ -", "");
    if (dRte.includes("å¾€ å¤©æ°´åœå¾ªç’°ç¶«") || dRte.includes("å¾€ ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™")) {
        return dRte.replace(" å¾€ ", " ");
    }
    return dRte;
};

window.renderAll = function() {
    // --- æ•ˆèƒ½å„ªåŒ–ï¼šé å…ˆè¨ˆç®—ç•¶æ—¥æ‰€æœ‰è»Šåºçš„æœ€æ–°æ™‚é–“æˆ³ (O(N) å„ªåŒ–) ---
    window.currentRunLatestMap = {};
    Object.values(window.reportGroups).forEach(group => {
        const latest = group.traces ? group.traces[0] : null;
        if (latest && latest.rno && latest.rno !== "---") {
            const opDate = window.getOperationalDate(latest.timestamp);
            const key = `${opDate}_${latest.rno}`;
            // æ‰¾å‡ºè©²è»Šåºåœ¨ç•¶å¤©æœ€æ™šè¢«å ±å‘Šçš„æ™‚é–“
            if (!window.currentRunLatestMap[key] || latest.timestamp > window.currentRunLatestMap[key]) {
                window.currentRunLatestMap[key] = latest.timestamp;
            }
        }
    });

    const mList = document.getElementById('masterList');
    const fList = document.getElementById('flashList');
    const favArea = document.getElementById('favListOnMain');
    
    const searchRoute = document.getElementById('searchRoute')?.value || "";
    const searchComp = document.getElementById('searchComp')?.value.toLowerCase() || "";
    const searchDate = document.getElementById('searchDate')?.value;
    const flashDate = document.getElementById('flashDate')?.value;


            // 1. æ•´ç†æ‰€æœ‰è¡Œè¹¤æ•¸æ“š
            const compositionMap = {};
            // ç¢ºä¿åŒä¸€çµ„è»Šåœ¨åŒä¸€ç§’çš„å ±å‘Šåªè¢«è¨ˆå…¥ä¸€æ¬¡
Object.values(window.reportGroups).forEach(group => {
    if(!group.traces) return;
    group.traces.forEach(t => {
        const fid = String(t.fullId || group.carId);
        if (!compositionMap[fid]) compositionMap[fid] = [];
        // å¢åŠ ä¸€å€‹æª¢æŸ¥ï¼Œé˜²æ­¢åŒä¸€ timestamp çš„è¨˜éŒ„é‡è¤‡é€²å…¥åŒä¸€ fid çµ„
        if (!compositionMap[fid].some(exist => exist.timestamp === t.timestamp)) {
            compositionMap[fid].push(t);
        }
    });
});

            const sortedComps = Object.keys(compositionMap).map(fid => ({
                fid: fid,
                traces: compositionMap[fid].sort((a,b) => b.timestamp - a.timestamp)
            }))
            .sort((a,b) => b.traces[0].timestamp - a.traces[0].timestamp);

            // 2. é€šç”¨ HTML æ§‹å»ºå™¨ (å·²å„ªåŒ–ï¼šç›®çš„åœ°æ—åŠ å…¥è¡Œè¹¤ä½ç½®)
const buildHTML = (comp, prefix = "m", showDesc = false, filterDate = null) => {
    let rawTraces = comp.traces || [];
    if (filterDate) {
        rawTraces = rawTraces.filter(t => window.getOperationalDate(t.timestamp) === filterDate);
    }

    const searchRouteValue = document.getElementById('searchRoute')?.value || "";

    let displayTraces = [];
    if (rawTraces.length > 0) {
        const seenTimestamps = new Set();
        rawTraces.forEach((current) => {
            if (seenTimestamps.has(current.timestamp)) return;
            seenTimestamps.add(current.timestamp);
            if (displayTraces.length === 0) {
                displayTraces.push(current);
            } else {
                const last = displayTraces[displayTraces.length - 1];
                if (last.dRte !== current.dRte || last.rno !== current.rno || last.loc !== current.loc) {
                    displayTraces.push(current);
                }
            }
        });
    }

if (prefix !== "fav" && displayTraces.length === 0) return "";

    // 1. å–å¾—è©²ç·¨çµ„çœŸæ­£çš„æœ€æ–°ä¸€ç­†è¨˜éŒ„
    let latest = displayTraces.length > 0 ? displayTraces[0] : null;

    if (searchRouteValue && displayTraces.length > 0) {
        const matchedTrace = displayTraces.find(t => {
            const rte = t.rteKey || "";
            if (searchRouteValue === "614P/615P") {
                return rte.includes("614P") || rte.includes("615P");
            }
            return rte === searchRouteValue || rte.split('x').includes(searchRouteValue);
        });

        if (matchedTrace) {
            // åªæœ‰åœ¨ livepage æ‰å…è¨±é¡¯ç¤ºéæ™‚çš„åŒ¹é…ç´€éŒ„
            if (prefix === "live") {
                latest = matchedTrace;
            } else {
                // å…¶ä»–é é¢ï¼ˆå¦‚ Favï¼‰æ°¸é é¡¯ç¤ºæœ€æ–°çš„ä¸€ç­†
                latest = displayTraces[0];
            }
        } else if (prefix !== "live") {
            // åœ¨å…¶ä»–é é¢è‹¥ç„¡åŒ¹é…ï¼Œä¾ç„¶ç¶­æŒæœ€æ–°ç‹€æ…‹
            latest = displayTraces[0];
        }
    }

    const displayRte = latest ? (latest.rteKey || "") : "";
    const colorKey = displayRte.split('x')[0];
    const hex = latest ? (colorMap[colorKey] || "#333") : "#bdc3c7";
    const carIds = comp.fid.split('-');
    const cleanId = prefix + comp.fid.replace(/[^a-zA-Z0-9]/g, '');
                
let specialBadgesHTML = "";
                if (showDesc) {
                    const uniqueIcons = [...new Set(carIds.map(id => specialIcons[id]).filter(Boolean))];
                    if (uniqueIcons.length > 0) {
                        specialBadgesHTML = `<div class="special-badge-area">` + 
                            uniqueIcons.map(icon => {
                                const cfg = (typeof specialTrains !== 'undefined') ? specialTrains[icon] : {};
                                const start = cfg.StartDate || "";
                                const end = cfg.EndDate || "";
                                
                                let dateInfo = "";
                                if (start || end) {
                                    // å„ªåŒ–å¾Œçš„æ—¥æœŸæ¨£å¼ï¼Œæ”¾ç½®æ–¼ä¸‹ä¸€è¡Œ
                                    dateInfo = `
                                        <div style="
                                            flex-basis: 100%; 
                                            color: #856404; 
                                            font-size: 0.75em; 
                                            margin-top: 1px; 
                                            margin-left: 22px; 
                                            font-weight: normal;
                                            display: flex;
                                            align-items: center;
                                        ">
                                            ${start} â€” ${end}
                                        </div>`;
                                }

                                return `
                                    <div class="special-desc-item" style="display: flex; flex-wrap: wrap; align-items: center;">
                                        <div style="font-weight: bold; color: #856404; display: flex; align-items: center;">
                                            <span style="margin-right: 4px;">${icon}</span>
                                            <span>${iconDesc[icon]}</span>
                                        </div>
                                        ${dateInfo}
                                    </div>`;
                            }).join('') + 
                            `</div>`;
                    }
                }
				
				
				
				let isCurrentlyOnSearchRoute = true;
if (searchRouteValue && latest) {
    const currentRteParts = (latest.rteKey || "").split('x');
    if (searchRouteValue === "614P/615P") {
        isCurrentlyOnSearchRoute = currentRteParts.some(p => p.includes("614P") || p.includes("615P"));
    } else {
        isCurrentlyOnSearchRoute = currentRteParts.includes(searchRouteValue);
    }
}

                const carLinks = carIds.map(c => {
                    const icon = specialIcons[c] || "";
					const space = icon ? " " : ""; // åªæœ‰ç•¶æœ‰åœ–ç¤ºæ™‚æ‰åŠ ç©ºæ ¼
                    return `<span class="car-link" onclick="event.stopPropagation(); showCarHistory('${c}')">${icon}${c}</span>`;
                }).join('-');
                
                const isFav = window.favorites.has(String(comp.fid));

                let headerTimeDisplay = "";
if (latest) {
    const d = new Date(latest.timestamp);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const hh = String(d.getHours()).padStart(2, '0');
    const min = String(d.getMinutes()).padStart(2, '0');
    const ss = String(d.getSeconds()).padStart(2, '0');
    
    const timeStr = `${yyyy}/${mm}/${dd} ${hh}:${min}:${ss}`;
    headerTimeDisplay = `<span style="color:#999; font-size:0.75em; font-weight:normal; font-family: monospace;">${timeStr}</span>`;
}

const outdatedStyle = (!isCurrentlyOnSearchRoute && searchRouteValue) ? "opacity: 0.55;" : "";
// Check for prefix === "live" and verify that the 'latest' being shown isn't actually the absolute newest trace
// 1. Existing check: Is this specific vehicle showing a record that is NOT its own absolute latest?
// 1. æª¢æŸ¥æ˜¯å¦ç‚ºè©²è»Šè¼›çš„èˆŠç´€éŒ„ (ç”¨æ–¼ Live Page æœå°‹)
const isNotAbsoluteLatestForThisCar = latest && displayTraces.length > 0 && latest.timestamp !== displayTraces[0].timestamp;

// 2. æª¢æŸ¥è©²è»Šåºæ˜¯å¦å·²è¢«å…¶ä»–è»Šè¼›æ¥æ‰‹ (ä½¿ç”¨å‰›æ‰å»ºç«‹çš„ Map)
let isRunTakenByAnotherCar = false;
if (latest && latest.rno && latest.rno !== "---") {
    const opDate = window.getOperationalDate(latest.timestamp);
    const key = `${opDate}_${latest.rno}`;
    // å¦‚æœ Map ä¸­çš„æ™‚é–“æˆ³æ¯”ç•¶å‰é€™ç­†ç´€éŒ„æ–°ï¼Œä»£è¡¨è©²è»Šåºå·²æœ‰æ›´æ–°çš„å ±å‘Š
    if (window.currentRunLatestMap[key] > latest.timestamp) {
        isRunTakenByAnotherCar = true;
    }
}

// æ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼š
// - Live Page ä¸‹é¡¯ç¤ºéæ™‚ç´€éŒ„è¦å‡º Badge
// - æ‰€æœ‰é é¢ä¸‹ï¼Œåªè¦è»Šåºè¢«å–ä»£å°±è¦å‡º Badge
const shouldShowBadge = (prefix === "live" && isNotAbsoluteLatestForThisCar) || isRunTakenByAnotherCar;

const outdatedBadge = shouldShowBadge ? 
    `<div style="background:#eee; color:#666; font-size:10px; padding:2px 6px; border-radius:3px; margin-top:4px; font-weight:normal; width:fit-content;">éç¾æ™‚è¡Œè¹¤</div>` : "";

// å›å‚³ HTML (ä¿æŒä½ è¦æ±‚çš„æ ¼å¼)
return `
    <div class="timeline-card" style="border-left-color:${hex}; ${!latest ? 'opacity:0.7;' : ''}">
        ${specialBadgesHTML}
        <div class="timeline-header" onclick="toggleCollapse('${cleanId}')" style="display: block; padding: 10px 15px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                <div style="display:flex; align-items:flex-start; gap:10px;">
                    <span id="arrow-${cleanId}" class="collapse-arrow" style="margin-top:2px;">â–¼</span>
                    <div style="display: flex; flex-direction: column;">
                        <b class="car-group-title" style="color:${hex}; line-height:1.2;">${carLinks}</b>
                        ${outdatedBadge}
                    </div>
                </div>
                ${latest ? headerTimeDisplay : ''}
            </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">

<div style="display: flex; align-items: center; gap: 6px; flex: 1; overflow: hidden; padding-left: 23px;">
    ${latest ? (() => {
        const rawRoute = latest.rteKey || "";
        let routeHTML = "";
        let pureDest = processRouteDisplay(latest.dRte);

        // è™•ç†æ‘˜è¦éƒ¨åˆ†çš„è·¯ç·šé¡¯ç¤ºèˆ‡é¡è‰²
// 1. è™•ç† Route HTML é¡¯ç¤º
        if (rawRoute.includes('x')) {
            const parts = rawRoute.split('x');
            const c1 = colorMap[parts[0]] || '#333';
            const c2 = colorMap[parts[1]] || '#333';
            
            routeHTML = `
                <span class="route-badge" style="background:${c1}; text-align: center;">${parts[0]}</span>
                <span style="font-size: 0.8em; color: #666; font-weight: bold;">â†’</span>
                <span class="route-badge" style="background:${c2}; text-align: center;">${parts[1]}</span>
            `;
            // ä¿®æ­£ï¼šé€™è£¡åªç§»é™¤ rawRoute å­—ä¸²ï¼Œé¿å…èª¤å‚·ç›®çš„åœ°
            pureDest = pureDest.replace(rawRoute, '').trim();
        } else {
            const c = colorMap[rawRoute] || '#333';
            routeHTML = `<span class="route-badge" style="background:${c}; text-align: center;">${rawRoute}</span>`;
            pureDest = pureDest.replace(rawRoute, '').trim();
        }

        // 2. ä¿®å¾©ï¼šèª¿æ•´æ‘˜è¦éƒ¨åˆ†çš„ã€Œå¾€ã€å­—é¡¯ç¤ºé‚è¼¯
        // ç§»é™¤ rawRoute === "å›å» " çš„å¼·åˆ¶éš±è—æ¢ä»¶
        const hideToLabel = pureDest.includes("å¤©æ°´åœå¾ªç’°ç¶«") || 
                           pureDest.includes("ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™") || 
                           pureDest === "---" ||
                           pureDest === ""; // å¦‚æœç›®çš„åœ°ç‚ºç©ºä¹Ÿä¸é¡¯ç¤ºã€Œå¾€ã€

        const toLabel = hideToLabel ? "" : `<span style="font-size: 0.85em; color: #666;">å¾€</span>`;

        // 3. æ¸…ç†ç›®çš„åœ°é¡¯ç¤ºæ–‡å­—
        // å…ˆç§»é™¤é–‹é ­å¯èƒ½é‡è¤‡çš„ã€Œå¾€ã€å­—ï¼Œç„¶å¾Œå†æ¸…ç†
        pureDest = pureDest.replace(/^å¾€\s*/, '').trim();

        // é‡å°ç‰¹æ®Šè·¯ç·šçš„é¡å¤–è™•ç†ï¼šå¦‚æœ pureDest è®Šæˆäº† "---"ï¼Œæˆ‘å€‘åœ¨æœ€çµ‚é¡¯ç¤ºæ™‚å°‡å…¶æ¸…ç©º
        let finalDestText = latest ? pureDest : 'ä»Šæ—¥æš«ç„¡è¨˜éŒ„';
        if (finalDestText === "---") finalDestText = "";

return `
            <span class="run-no-badge" 
                ${window.isAdmin && latest ? `onclick="event.stopPropagation(); deleteTrace('${carIds[0]}', ${latest.timestamp})"` : ""} 
                style="margin:0; flex-shrink:0; ${window.isAdmin ? "cursor: pointer; border: 1px dashed #bdc3c7;" : ""}">
                ${latest ? latest.rno : '---'}
            </span>
            <div style="display: flex; align-items: center; gap: 2px; flex-shrink:0;">${routeHTML}</div>
            ${toLabel}
            <b style="font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0;">
                ${finalDestText}
            </b>
            ${latest ? `
            <span style="color: #999; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 2; min-width: 0;">
                @ ${latest.loc}
            </span>` : ''}
        `;
    })() : `<span style="color:#999; font-size:0.8em;">ä»Šæ—¥æš«ç„¡è¡Œè¹¤</span>`}
</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
    <div onclick="toggleFav('${comp.fid}', event)" 
         style="cursor:pointer; color:${isFav?'#f1c40f':'#ccc'}; font-size:1.2em; line-height: 1;">
        â˜…
    </div>
</div>
                        </div>
                    </div>
                    <div id="body-${cleanId}" class="timeline-body">
                        ${latest ? `
                            <div style="padding: 0 0px 10px 0px; color: #666; font-size: 0.85em;">æœ€æ–°ä½ç½®ï¼š<b>${latest.loc}</b> (${latest.tStr})</div>

${displayTraces.slice(0, 5).map((t, idx) => {
    const d = new Date(t.timestamp);
    const isSmallScreen = window.innerWidth < 380;
    const ts = d.toLocaleTimeString([], { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: isSmallScreen ? undefined : '2-digit', 
        hour12: false 
    });
    
    const rawRoute = t.rteKey || "";
    let indicatorStyle = "";
    let routeHTML = "";
    let pureDest = processRouteDisplay(t.dRte);

    // åªæœ‰åœ¨å« "x" æ™‚æ‰å¥—ç”¨å£“ç¸®å­—é«”
    const isXRoute = rawRoute.includes('x');
    const routeExtraStyle = isXRoute ? 'font-stretch: condensed;' : '';

    if (isXRoute) {
        const parts = rawRoute.split('x');
        const c1 = colorMap[parts[0]] || '#333';
        const c2 = colorMap[parts[1]] || '#333';
        indicatorStyle = `background: linear-gradient(180deg, ${c1} 0%, ${c2} 100%);`;
        routeHTML = `
            <span class="route-badge" style="background:${c1}; text-align: center; ${routeExtraStyle}">${parts[0]}</span>
            <span style="font-size: 0.8em; color: #666; font-weight: bold;">â†’</span>
            <span class="route-badge" style="background:${c2}; text-align: center; ${routeExtraStyle}">${parts[1]}</span>
        `;
        pureDest = pureDest.replace(rawRoute, '').trim();
    } else {
        const c = colorMap[rawRoute] || '#333';
        indicatorStyle = `background: ${c};`;
        routeHTML = `<span class="route-badge" style="background:${c}; text-align: center;">${rawRoute}</span>`;
        pureDest = pureDest.replace(rawRoute, '').trim();
    }

    const hideToLabel = pureDest.includes("å¤©æ°´åœå¾ªç’°ç¶«") || 
                        pureDest.includes("ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™") || 
                        rawRoute === "å›å» " || 
                        pureDest === "---" ||
                        pureDest === "";

    // --- ä¿®æ”¹ï¼šç•¶æ»¿è¶³ x è·¯ç·šæ¢ä»¶æ™‚ï¼Œå°‡ã€Œå¾€ã€å­—å¤§å°è¨­ç‚º 0.8em ---
    const toFontSize = isXRoute ? "0.8em" : "0.85em";
    const toLabelHTML = hideToLabel ? "" : `<span style="font-size: ${toFontSize}; color: #666;">å¾€</span>`;
    pureDest = pureDest.replace(/^å¾€\s*/, '').trim();

    // æ ¹æ“šæ˜¯å¦ç‚º x è·¯ç·šå‹•æ…‹æ±ºå®šç›®çš„åœ°èˆ‡åœ°é»çš„ Style
    const destStyle = isXRoute 
        ? `font-size: 0.8em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0;` 
        : `font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 0;`;

    const locStyle = isXRoute
        ? `color: #999; font-size: 0.8em; white-space: nowrap; overflow: hidden; min-width: 0; flex-shrink: 2;`
        : `color: #999; font-size: 0.85em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 2; min-width: 0;`;

    const runNoAction = window.isAdmin ? `onclick="event.stopPropagation(); deleteTrace('${t.fullId || comp.fid}', ${t.timestamp})"` : "";
    const runNoStyle = window.isAdmin ? "cursor: pointer; border: 1px dashed #bdc3c7;" : "border: 1px solid #eee;";

    return `
    <div class="trace-item ${idx===0?'latest':''}" style="padding-right: 2px;">
        <div class="timeline-indicator" style="${indicatorStyle}"></div>
        
        <div style="display:flex; flex-direction: column; gap: 4px; width: 100%; overflow: hidden;">
            <div style="display:flex; justify-content:space-between; align-items: center; gap: 4px;">
                <div style="display: flex; align-items: center; gap: 4px; flex: 1; overflow: hidden;">
                    <span class="run-no-badge" ${runNoAction} style="margin:0; flex-shrink:0; ${runNoStyle}">${t.rno || '---'}</span>
                    <div style="display: flex; align-items: center; gap: 2px; flex-shrink:0;">${routeHTML}</div>
                    ${toLabelHTML}
                    <b style="${destStyle}">
                        ${pureDest}
                    </b>
                    <span style="${locStyle}">
                        @ ${t.loc}
                    </span>
                </div>

                <div style="white-space: nowrap; flex-shrink:0; margin-left: auto; text-align: right;">
                    <small style="color: #2980b9; font-weight: bold; font-family: monospace; font-size: 0.82em;">${ts}</small>
                </div>
            </div>
            
            ${t.mem ? `<div style="margin-left: 5px; font-size: 0.8em; color: #e67e22; background: #fff5eb; padding: 2px 6px; border-radius: 4px; border-left: 2px solid #e67e22; align-self: flex-start;">ğŸ“ ${t.mem}</div>` : ''}
        </div>
    </div>`;
}).join('')}
` : `<div style="padding:15px; color:#999; text-align:center; font-size:0.9em;">æ­¤ç·¨çµ„ä»Šæ—¥å°šç„¡è¡Œè¹¤å ±å‘Šã€‚</div>`}
                    </div>
                </div>`;
            };

            // --- 3. æ¸²æŸ“ä¸»åˆ—è¡¨ ---
// --- 3. æ¸²æŸ“ä¸»åˆ—è¡¨ ---
if (mList) {
    const sortMethod = document.getElementById('sortOrder')?.value || "reportTime";
    const today = window.getOperationalDate(); 
    const targetDate = searchDate || today; // ç¢ºå®šç›®æ¨™æ—¥æœŸï¼ˆé»˜èªç‚ºä»Šå¤©ï¼‰

    // é‡æ–°æ•´ç†åƒ…å±¬æ–¼è©²æ—¥æœŸçš„ compositionMap
    const dailyCompositionMap = {};
    Object.values(window.reportGroups).forEach(group => {
        if(!group.traces) return;
        group.traces.forEach(t => {
            // é—œéµä¿®æ­£ï¼šåªä¿ç•™ç‡Ÿé‹æ—¥ç¬¦åˆ targetDate çš„è¨˜éŒ„
            if (window.getOperationalDate(t.timestamp) === targetDate) {
                const fid = String(t.fullId || group.carId);
                if (!dailyCompositionMap[fid]) dailyCompositionMap[fid] = [];
                dailyCompositionMap[fid].push(t);
            }
        });
    });

    // å°‡æ•´ç†å¥½çš„æ¯æ—¥æ•¸æ“šè½‰æ›ç‚ºæ•¸çµ„
    let filtered = Object.keys(dailyCompositionMap).map(fid => ({
        fid: fid,
        traces: dailyCompositionMap[fid].sort((a,b) => b.timestamp - a.timestamp)
    }));

// [ä¿®æ”¹æ–¼ window.renderAll å…§éƒ¨]
filtered = filtered.filter(comp => {
    const traces = comp.traces || [];
    
    // 1. è·¯ç·šéæ¿¾ï¼šåªè¦è©²è»Šä»Šæ—¥ã€Œæ›¾ç¶“ã€è·‘éæœå°‹çš„è·¯ç·šå³ä¿ç•™
    let routeMatch = false;
    if (!searchRoute) {
        routeMatch = true;
    } else {
        routeMatch = traces.some(t => {
            const rte = t.rteKey || "";
            if (searchRoute === "614P/615P") {
                return rte.includes("614P") || rte.includes("615P");
            }
            // è™•ç†è·¨ç·š (å¦‚ 751x615)ï¼Œæ‹†åˆ†å¾Œæª¢æŸ¥æ˜¯å¦åŒ…å«æœå°‹è·¯ç·š
            return rte.split('x').includes(searchRoute);
        });
    }
    
    // 2. ç·¨è™Ÿéæ¿¾
    const compMatch = comp.fid.toLowerCase().includes(searchComp);
    
    return routeMatch && compMatch;
});

    // è™•ç†ç·¨è™Ÿç¯„åœçš„ç‰¹æ®Šé¡¯ç¤ºï¼ˆç•¶æ‰¾ä¸åˆ°è¨˜éŒ„æ™‚ï¼‰
    const isValidId = (idStr) => {
        const num = parseInt(idStr);
        if (isNaN(num)) return false;
        return (num >= 1001 && num <= 1162) || (num >= 1201 && num <= 1220);
    };

    if (filtered.length === 0 && searchComp && !searchRoute) {
        if (isValidId(searchComp)) {
            const emptyComp = { fid: searchComp, traces: [] };
            mList.innerHTML = buildHTML(emptyComp, "fav", false, targetDate);
        } else {
            mList.innerHTML = "<div class='empty-msg' style='text-align:center; padding:20px; color:grey;'>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</div>";
        }
    } else {
// [ä¿®æ”¹æ–¼ window.renderAll å…§éƒ¨çš„æ’åºå€å¡Š]
filtered.sort((a, b) => {
    // Determine which record is actually being displayed for comparison
    const getActiveTrace = (comp) => {
        if (searchRoute && comp.traces.length > 0) {
            const matched = comp.traces.find(t => {
                const rte = t.rteKey || "";
                if (searchRoute === "614P/615P") return rte.includes("614P") || rte.includes("615P");
                return rte === searchRoute || rte.split('x').includes(searchRoute);
            });
            // If on Live Page and a match is found, use it; otherwise use the latest
            if (matched) return matched;
        }
        return comp.traces[0];
    };

    const traceA = getActiveTrace(a);
    const traceB = getActiveTrace(b);

    if (sortMethod === "routeRun") {
        const rteA = traceA ? (traceA.rteKey || "") : "";
        const rteB = traceB ? (traceB.rteKey || "") : "";

        const getSortGroup = (r) => {
            if (r.includes("614P") || r.includes("615P")) return "614P/615P";
            return r.includes('x') ? r.split('x')[0] : r;
        };

        const groupA = getSortGroup(rteA);
        const groupB = getSortGroup(rteB);

        if (groupA !== groupB) {
            return groupA.localeCompare(groupB, undefined, {numeric: true});
        }
        
        // Use the Run Number of the displayed record
        return (traceA?.rno || "").localeCompare(traceB?.rno || "", undefined, {numeric: true});
    } else {
        // Report Time sorting: also use the displayed record's timestamp
        const timeA = traceA ? traceA.timestamp : 0;
        const timeB = traceB ? traceB.timestamp : 0;
        return timeB - timeA;
    }
});

        mList.innerHTML = filtered.map(c => buildHTML(c, "live", false, targetDate)).join('') 
            || "<div class='empty-msg' style='text-align:center; padding:20px; color:grey;'>è©²æ—¥æœŸæš«ç„¡è¡Œè¹¤è¨˜éŒ„</div>";
    }
}

// 4. æ¸²æŸ“ä»ŠæœŸé–ƒå¡
    if (fList) {
        const flashDate = document.getElementById('flashDate')?.value || window.getOperationalDate();
        const specialCarIds = Object.keys(specialIcons);

        const finalFlashMap = new Map();
        const processedIds = new Set();

        // 1. å„ªå…ˆè™•ç†ç•¶å¤©æœ‰å ±åˆ°çš„ç·¨çµ„
        sortedComps.forEach(comp => {
            const ids = comp.fid.split('-');
            const isSpecial = ids.some(id => specialIcons[id]);
            const hasTracesToday = comp.traces && comp.traces.some(t => window.getOperationalDate(t.timestamp) === flashDate);

            if (isSpecial && hasTracesToday) {
                finalFlashMap.set(comp.fid, comp);
                ids.forEach(id => { if (specialIcons[id]) processedIds.add(id); });
            }
        });

        // 2. è™•ç†ç•¶å¤©ç„¡è¡Œè¹¤çš„ç‰¹åˆ¥è»Šï¼šç¶­æŒæœ€å¾Œå·²çŸ¥ç·¨çµ„ (ä¸æ‹†æ•£)
        specialCarIds.forEach(id => {
            if (processedIds.has(id)) return;

            const group = window.reportGroups && window.reportGroups[id];
            let lastFid = id;
            let latestTraces = [];

            if (group && group.traces && group.traces.length > 0) {
                // æŠ“å–æœ€å¾Œä¸€ç­†ç´€éŒ„æ™‚çš„å®Œæ•´ ID
                const absoluteLatest = [...group.traces].sort((a, b) => b.timestamp - a.timestamp)[0];
                lastFid = absoluteLatest.fullId || group.carId || id;
                latestTraces = group.traces;
            }

            if (!finalFlashMap.has(lastFid)) {
                finalFlashMap.set(lastFid, {
                    fid: lastFid,
                    traces: latestTraces
                });
            }
            
            lastFid.split('-').forEach(cid => { if (specialIcons[cid]) processedIds.add(cid); });
        });

        const flashDisplayList = Array.from(finalFlashMap.values()).sort((a, b) => {
            const aHas = a.traces && a.traces.some(t => window.getOperationalDate(t.timestamp) === flashDate);
            const bHas = b.traces && b.traces.some(t => window.getOperationalDate(t.timestamp) === flashDate);
            return (bHas ? 1 : 0) - (aHas ? 1 : 0);
        });

// æ¸²æŸ“ä¸¦ä¿®å¾©å±•é–‹ Bug
fList.innerHTML = flashDisplayList
    .map(c => {
        // 1. å…ˆç”ŸæˆåŸå§‹çš„ fav æ¨¡æ¿ HTML (å¼•ç”¨ 2 çš„é‚è¼¯ï¼šå…ˆä»¥ fav å»ºç«‹)
        // ä½¿ç”¨ "fav" å¯ç¢ºä¿è§¸ç™¼ buildHTML å…§éƒ¨çš„é‚è¼¯ï¼Œå³ä½¿ç„¡è¡Œè¹¤ä¹Ÿæœƒé¡¯ç¤ºå¡ç‰‡æ¡†æ¶
        let html = buildHTML(c, "fav", true, flashDate);
        
        // 2. æ ¸å¿ƒä¿®å¾©ï¼šä½¿ç”¨ split/join é€²è¡Œå…¨åŸŸæ›¿æ›ï¼Œå°‡ ID èˆ‡äº‹ä»¶åƒæ•¸å¾ fav è½‰å‘ flashpage
        // ç¢ºä¿ body-flashpage å’Œ arrow-flashpage èˆ‡ toggleCollapse å…§çš„åƒæ•¸å®Œå…¨ä¸€è‡´
        html = html.split('id="body-fav').join('id="body-flashpage');
        html = html.split('id="arrow-fav').join('id="arrow-flashpage');
        
        // é—œéµï¼šå°‡ toggleCollapse çš„åƒæ•¸å¾ 'fav...' æ›¿æ›ç‚º 'flashpage...'
        // é€™æ¨£é»æ“Š header æ™‚ï¼ŒtoggleCollapse æ‰èƒ½æ­£ç¢ºæ‰¾åˆ° flashpage çš„ ID
        html = html.split("toggleCollapse('fav").join("toggleCollapse('flashpage");
        
        // æ ¹æ“šä½ çš„è¦æ±‚ï¼šé è¨­ä¿æŒæ‘ºç–Š (Folded)ï¼Œå› æ­¤ä¸é¡å¤–æ·»åŠ  expanded é¡åˆ¥
        return html;
    })
    .join('') || "<div class='empty-msg' style='text-align:center; padding:20px; color:grey;'>ç›®å‰æ²’æœ‰ç›¸é—œè¡Œè¹¤</div>";
    }

// åœ¨ window.renderAll å…§éƒ¨æ‰¾åˆ°è™•ç† favArea çš„éƒ¨åˆ†
if (favArea) {
    if (window.user) {
        // ä½¿ç”¨è‡ªè¨‚é †åº (window.customOrder) æˆ–é è¨­é †åº
        let favIds = window.customOrder && window.customOrder.length > 0 
                     ? window.customOrder 
                     : Array.from(window.favorites);

        if (favIds.length > 0) {
            const today = window.getOperationalDate();
            favArea.innerHTML = favIds.map(fid => {
                const existingComp = sortedComps.find(c => String(c.fid) === String(fid));
                const todayTraces = existingComp ? existingComp.traces.filter(t => 
                    window.getOperationalDate(t.timestamp) === today
                ) : [];

                const compToRender = { fid: fid, traces: todayTraces };
                const html = buildHTML(compToRender, "fav", false, null);

                // --- é—œéµä¿®æ”¹ï¼šåŠ å…¥ draggable å±¬æ€§èˆ‡äº‹ä»¶ ---
                return `<div class="draggable-item" 
                             draggable="true" 
                             data-fid="${fid}" 
                             ondragstart="handleDragStart(event)" 
                             ondragover="handleDragOver(event)" 
                             ondrop="handleDrop(event)">
                            ${html}
                        </div>`;
            }).join('');
        } else {
            favArea.innerHTML = "<p style='text-align:center;color:grey;padding:10px;'>ç›®å‰æ²’æœ‰ç›£å¯Ÿç·¨çµ„</p>";
        }
    } else {
        favArea.innerHTML = "<p style='text-align:center;color:grey;padding:10px;'>è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹ç›£å¯Ÿåˆ—è¡¨</p>";
    }
}
if (favArea) {
    if (window.user) {
        const favIds = Array.from(window.favorites);
        if (favIds.length > 0) {
            const today = window.getOperationalDate(); // ç²å–ç•¶å‰ç‡Ÿé‹æ—¥ (5:00AM ç‚ºç•Œ)

            favArea.innerHTML = favIds.map(fid => {
                const existingComp = sortedComps.find(c => String(c.fid) === String(fid));
                
                // éæ¿¾è©²ç·¨çµ„ä¸­åƒ…å±¬æ–¼ä»Šæ—¥ç‡Ÿé‹æ—¥çš„è¨˜éŒ„
                const todayTraces = existingComp ? existingComp.traces.filter(t => 
                    window.getOperationalDate(t.timestamp) === today
                ) : [];

                // æ§‹å»ºä¸€å€‹è‡¨æ™‚ç‰©ä»¶å‚³çµ¦ buildHTML
                // å¦‚æœæ²’æœ‰ä»Šæ—¥è¨˜éŒ„ï¼Œtraces æœƒæ˜¯ç©ºé™£åˆ—ï¼Œå¾è€Œè§¸ç™¼ã€Œä»Šæ—¥æš«ç„¡è¡Œè¹¤ã€é¡¯ç¤º
                const compToRender = { 
                    fid: fid, 
                    traces: todayTraces 
                };
                
                // ä½¿ç”¨ prefix "fav" æ¸²æŸ“ï¼ŒbuildHTML å…§éƒ¨æœƒè™•ç†ç©º traces çš„é¡¯ç¤º
                return buildHTML(compToRender, "fav", false, null);
            }).join('');
        } else {
            favArea.innerHTML = "<p style='text-align:center;color:grey;padding:10px;'>ç›®å‰æ²’æœ‰ç›£å¯Ÿç·¨çµ„</p>";
        }
    } else {
        favArea.innerHTML = "<p style='text-align:center;color:grey;padding:10px;'>è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹ç›£å¯Ÿåˆ—è¡¨</p>";
    }
}
        };
		
let touchStartX = 0;
let touchEndX = 0;

window.showCarHistory = (cid, isSilent = false) => {
    const prevMonthView = window.lastMonthView;
    window.currentDetailCarId = cid;
    
    const overlay = document.getElementById('detailOverlay');
    const detailListContainer = document.getElementById('detailList');
    const todayStr = window.getOperationalDate(new Date().getTime());

    if (!isSilent) {
        window.currentSelectedDate = todayStr;
        window.calendarDisplayMonth = todayStr.substring(0, 7);
        document.body.style.overflow = 'hidden'; 
        overlay.style.display = 'flex';
        requestAnimationFrame(() => { overlay.classList.add('show'); });
        detailListContainer.scrollTop = 0;
    }

    const mainIcon = specialIcons[cid] || "";
    const titleElem = document.getElementById('detailTitle');
    if (titleElem) {
        const desc = iconDesc[mainIcon] || "";
        titleElem.innerHTML = `
            ${mainIcon}${cid}
            ${desc ? `<span style="display: inline-block; width: auto; min-width: 70px; background:#fffdf0; color:#856404; font-size:12px; padding:2px 6px; border-radius:3px; margin-left:3px; font-weight:normal; text-align: center; vertical-align: middle; line-height: 1.4;">${desc}</span>` : ''}
        `;
    }
    
    detailListContainer.style.padding = "0px";
    detailListContainer.style.width = "100%";
    detailListContainer.style.display = "block"; 
    detailListContainer.style.overflowY = "auto"; 
    detailListContainer.style.webkitOverflowScrolling = "touch";

    if (!window.calendarDisplayMonth) {
        window.calendarDisplayMonth = (window.currentSelectedDate || todayStr).substring(0, 7);
    }

    const [viewYear, viewMonthIdx] = window.calendarDisplayMonth.split('-').map(n => parseInt(n));
    const viewMonth = viewMonthIdx - 1;

    const firstDayOfMonth = new Date(viewYear, viewMonth, 1);
    const lastDayOfMonth = new Date(viewYear, viewMonth + 1, 0);
    const startOffset = firstDayOfMonth.getDay(); 

    const traces = window.reportGroups[cid]?.traces || [];
    const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];

    const calendarDays = [];
    for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
        const d = new Date(viewYear, viewMonth, i, 12, 0, 0);
        calendarDays.push({
            dateStr: window.getOperationalDate(d.getTime()),
            dayNum: i
        });
    }

    window.lastMonthView = window.calendarDisplayMonth;
    const isMonthChanged = prevMonthView && prevMonthView !== window.calendarDisplayMonth;

    if (isMonthChanged && calendarDays.length > 0) {
        const currentSystemMonth = todayStr.substring(0, 7);
        if (window.calendarDisplayMonth === currentSystemMonth) {
            window.currentSelectedDate = todayStr;
        } else {
            window.currentSelectedDate = calendarDays[0].dateStr;
        }
    }

    let selectedDateStr = window.currentSelectedDate || todayStr;

    // æ»‘å‹•åµæ¸¬è®Šæ•¸
    let touchStartX = 0;
    let touchEndX = 0;

    let calendarHTML = `
        <style>
            @keyframes monthSlideIn {
                from { opacity: 0; transform: translateY(8px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes listFadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes listFadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(10px); }
            }
            .month-anim-active { animation: monthSlideIn 0.35s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
            .history-card-anim { animation: listFadeIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
            .list-fade-out { animation: listFadeOut 0.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

            .day-item { 
                transition: transform 0.1s active, background-color 0.3s ease, border-color 0.3s ease; 
                will-change: background, border-color; 
            }
            .day-item:active { transform: scale(0.95); }
            .day-selected {
                background-color: #e3f2fd !important;
                border-color: #2196f3 !important;
            }
            
            .fixed-calendar-wrapper {
                position: sticky;
                top: 0;
                left: 0;
                right: 0;
                z-index: 100;
                background: #f8f9fa;
                touch-action: pan-y;
            }
			
			
body {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

input, textarea {
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    user-select: text;
}
			
        </style>
        <div class="fixed-calendar-wrapper" id="calendarWrapper"
             ontouchstart="this.tX = event.touches[0].clientX; this.tY = event.touches[0].clientY;"
             ontouchend="(()=>{
                const diffX = event.changedTouches[0].clientX - this.tX;
                const diffY = event.changedTouches[0].clientY - this.tY;
                if(Math.abs(diffX) > 70 && Math.abs(diffX) > Math.abs(diffY)) {
                    const d = new Date(${viewYear}, ${viewMonth} + (diffX > 0 ? -1 : 1), 1);
                    const y = d.getFullYear();
                    const m = (d.getMonth() + 1).toString().padStart(2, '0');
                    window.calendarDisplayMonth = \`\${y}-\${m}\`;
                    window.showCarHistory('${cid}', true);
                }
             })()">
            <div class="calendar-card" style="background: #fdfdfd; margin: 0 10px 10px 10px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.04); overflow: hidden; box-sizing: border-box; transform: translateY(10px);">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 15px; border-bottom: 1px solid #f2f2f2; background: #fafafa;">
                    <div onclick="event.stopPropagation(); (()=>{ 
                        const d = new Date(${viewYear}, ${viewMonth} - 1, 1);
                        const y = d.getFullYear();
                        const m = (d.getMonth() + 1).toString().padStart(2, '0');
                        window.calendarDisplayMonth = \`\${y}-\${m}\`;
                        window.showCarHistory('${cid}', true);
                    })()" style="cursor: pointer; padding: 4px 10px; color: #ccc; font-size: 0.8em; line-height: 1;">â—€</div>
                    
                    <div id="calendarTitleBtn" style="flex: 1; text-align: center; cursor: pointer; position: relative; user-select: none;"
                         onclick="if(this.dataset.longPressed === '1') { this.dataset.longPressed = ''; return; } document.getElementById('monthPicker').showPicker();"
                         ontouchstart="this.lpTimer = setTimeout(() => { 
                            this.dataset.longPressed = '1'; 
                            const now = new Date(); 
                            const tStr = window.getOperationalDate(now.getTime()); 
                            window.calendarDisplayMonth = tStr.substring(0, 7); 
                            window.currentSelectedDate = tStr; 
                            window.showCarHistory('${cid}', true); 
                            document.getElementById('detailList').scrollTop = 0;
                            if (navigator.vibrate) navigator.vibrate(40); 
                         }, 600);"
                         ontouchend="clearTimeout(this.lpTimer)">
                        <span style="font-size: 0.95em; color: #333; font-weight: bold; line-height: 1;">${viewYear}å¹´ ${viewMonthIdx}æœˆ</span>
                        <input type="month" id="monthPicker" style="position: absolute; opacity: 0; width: 1px; height: 1px; left: 50%;"
                               value="${window.calendarDisplayMonth}"
                               onchange="window.calendarDisplayMonth = this.value; window.showCarHistory('${cid}', true)">
                    </div>

                    <div onclick="event.stopPropagation(); (()=>{ 
                        const d = new Date(${viewYear}, ${viewMonth} + 1, 1);
                        const y = d.getFullYear();
                        const m = (d.getMonth() + 1).toString().padStart(2, '0');
                        window.calendarDisplayMonth = \`\${y}-\${m}\`;
                        window.showCarHistory('${cid}', true);
                    })()" style="cursor: pointer; padding: 4px 10px; color: #ccc; font-size: 0.8em; line-height: 1;">â–¶</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); background: #fdfdfd; border-bottom: 1px solid #f0f0f0; text-align: center; padding: 4px 0;">
                    ${weekDays.map(w => `<span style="font-size: 0.6em; color: #bbb;">${w}</span>`).join('')}
                </div>
                <div class="${isMonthChanged ? 'month-anim-active' : ''}" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: 5px; background: #fff;">`;
    
    for (let p = 0; p < startOffset; p++) {
        calendarHTML += `<div style="min-height: 35px; background: transparent;"></div>`;
    }

    calendarDays.forEach(item => {
        const dateStr = item.dateStr;
        const dayTraces = traces.filter(t => {
            const isSameDate = window.getOperationalDate(t.timestamp) === dateStr;
            const isHiddenRoute = (t.rteKey === "å›å» " || t.rteKey === "ä¸è¼‰å®¢");
            return isSameDate && !isHiddenRoute;
        });

        // è™•ç†æ—¥æ›†å¾½ç« é¡¯ç¤ºé‚è¼¯ (å« 509/510 ç‰¹æ®Šå®šç¾©)
        const dailyBadges = [];
        const addedDisplaySet = new Set();

        dayTraces.forEach(t => {
            let rKey = t.rteKey || "";
            let dRte = t.dRte || "";
            let displayNum = "";
            let colorKey = "";

            // æ ¹æ“š HTML å®šç¾©çš„è·¯ç·šèˆ‡ç›®çš„åœ°åˆ¤æ–·
            if ((rKey === "614P" && dRte.includes("å…†åº·")) || (rKey === "615P" && dRte.includes("å±¯é–€ç¢¼é ­"))) {
                displayNum = "509";
                colorKey = "614P";
            } else if ((rKey === "615P" && dRte.includes("å…†åº·")) || (rKey === "614P" && dRte.includes("å±¯é–€ç¢¼é ­"))) {
                displayNum = "510";
                colorKey = "615P";
            }

            if (displayNum) {
                if (!addedDisplaySet.has(displayNum)) {
                    dailyBadges.push({ text: displayNum, color: colorKey });
                    addedDisplaySet.add(displayNum);
                }
            } else {
                const parts = rKey.includes('x') ? rKey.split('x') : [rKey];
                parts.forEach(p => {
                    if (p && !addedDisplaySet.has(p)) {
                        dailyBadges.push({ text: p, color: p });
                        addedDisplaySet.add(p);
                    }
                });
            }
        });

        const isSelected = selectedDateStr === dateStr;
        const isToday = todayStr === dateStr;
        let dayColor = (isSelected || isToday) ? "#2196f3" : "#666";
        const hasBadges = dailyBadges.length > 0;

        calendarHTML += `
            <div class="day-item ${isSelected ? 'day-selected' : ''}" 
                 onclick="(()=>{
                    if('${window.currentSelectedDate}' === '${dateStr}') return;
                    document.querySelectorAll('.day-item.day-selected').forEach(el => {
                        el.classList.remove('day-selected');
                    });
                    const list = document.getElementById('historyListWrapper');
                    if(list) list.classList.add('list-fade-out');
                    setTimeout(() => {
                        window.currentSelectedDate='${dateStr}'; 
                        window.showCarHistory('${cid}', true);
                    }, 180);
                 })()" 
                 style="background: #fff; border: 1px solid ${isToday ? '#2196f3' : '#f0f0f0'}; border-radius: 6px; padding: 3px 0; text-align: center; cursor: pointer; min-height: ${hasBadges ? '55px' : '35px'}; display: flex; flex-direction: column; align-items: center; box-sizing: border-box;">
                <div style="line-height: 1;"><span style="font-size: 0.72em; color: ${dayColor}; font-weight: ${isSelected || isToday ? 'bold' : 'normal'};">${item.dayNum}</span></div>
                ${hasBadges ? `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 2px; width: 100%; padding: 2px 2px 0 2px; box-sizing: border-box;">
                    ${dailyBadges.slice(0, 3).map(b => `<span style="background: ${colorMap[b.color] || '#333'}; color: white; font-size: 0.52em; padding: 1px 5px; border-radius: 3px; font-weight: bold; line-height: 1.2;">${b.text}</span>`).join('')}
                </div>` : ''}
            </div>`;
    });
    calendarHTML += `</div></div><div style="height:10px;"></div></div>`;

    const filteredTraces = traces.filter(t => window.getOperationalDate(t.timestamp) === selectedDateStr);
    
    let listHTML = `<div id="historyListWrapper" class="history-card-anim">`;
    listHTML += `
        <div class="history-group" style="width: 100%; box-sizing: border-box; background: #f8f9fa;">
            <div style="padding: 0px 12px 6px 12px; font-size: 0.82em; color: #888; font-weight: bold;">è¨˜éŒ„è©³æƒ…</div>
        </div>
        <div class="timeline-body expanded" style="display: block; background: white; border-radius: 12px; margin: 0 10px 15px 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.08); border: 1px solid #eee; box-sizing: border-box;">
            <div style="padding: 0;">`;

    if (filteredTraces.length === 0) {
        listHTML += `<div style='text-align:center; padding:40px; color:#bdc3c7; font-size: 0.85em;'>è©²æ—¥ç„¡å ±å‘Šè¨˜éŒ„</div>`;
    } else {
        let lastGroupKey = "";
        filteredTraces.sort((a, b) => b.timestamp - a.timestamp).forEach((t) => {
            const currentFid = t.fullId || cid;
            const displayFid = currentFid.split('-').map(id => (specialIcons[id] || "") + id).join('-');
            
            if (displayFid !== lastGroupKey) {
                listHTML += `<div style="padding: 0px 0 6px 6px; display: flex; align-items: center; gap: 6px; ${lastGroupKey !== "" ? "border-top: 1px solid #eee;" : ""}">
                               <span style="font-size: 0.72em; color: #1a252f; font-weight: bold; background: #ecf0f1; padding: 1px 8px; border-radius: 10px;">${displayFid}</span>
                          </div>`;
                lastGroupKey = displayFid;
            }

            const rawRoute = t.rteKey || "";
            let routeHTML = "";
            let pureDest = processRouteDisplay(t.dRte);
            if (rawRoute.includes('x')) {
                const parts = rawRoute.split('x');
                routeHTML = `<span class="route-badge" style="background:${colorMap[parts[0]] || '#333'}; padding: 1px 5px; border-radius: 3px;">${parts[0]}</span><span style="font-size: 0.7em; color: #999; margin: 0 1px;">â†’</span><span class="route-badge" style="background:${colorMap[parts[1]] || '#333'}; padding: 1px 5px; border-radius: 3px;">${parts[1]}</span>`;
                pureDest = pureDest.replace(rawRoute, '').trim();
            } else {
                routeHTML = `<span class="route-badge" style="background:${colorMap[rawRoute] || '#333'}; padding: 1px 5px; border-radius: 3px;">${rawRoute}</span>`;
                pureDest = pureDest.replace(rawRoute, '').trim();
            }

            const hideToLabel = pureDest.includes("å¤©æ°´åœå¾ªç’°ç¶«") || pureDest.includes("ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™") || rawRoute === "å›å» " || pureDest === "---";
            const fullTimeStr = new Date(t.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });

            listHTML += `
                <div class="trace-item" style="border-bottom: 1px solid #f2f2f2; padding: 6px 2px 6px 8px; display: flex; flex-direction: column; gap: 4px; box-sizing: border-box;">
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <div style="display: flex; align-items: center; gap: 4px; overflow: hidden; flex: 1;">
                            <span class="run-no-badge" onclick="deleteTrace('${cid}', ${t.timestamp})" style="flex-shrink:0; font-size: 0.78em; padding: 1px 3px; cursor: pointer; border: 1px dashed #bdc3c7;">${t.rno}</span>
                            <div style="display: flex; align-items: center; flex-shrink:0;">${routeHTML}</div>
                            ${hideToLabel ? "" : `<span style="font-size: 0.8em; color: #999;">å¾€</span>`}
                            <b style="font-size: 0.88em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${pureDest.replace(/^å¾€\s*/, '')}</b>
                            <span style="color: #999; font-size: 0.8em; white-space: nowrap;">@ ${t.loc}</span>
                        </div>
                        <small style="color: #2980b9; font-family: monospace; font-size: 0.75em; flex-shrink: 0;">${fullTimeStr}</small>
                    </div>
                    ${t.mem ? `<div style="margin-left: 5px; font-size: 0.8em; color: #e67e22; background: #fff5eb; padding: 0px 6px; border-radius: 4px; border-left: 2px solid #e67e22; align-self: flex-start;">ğŸ“ ${t.mem}</div>` : ''}
                </div>`;
        });
    }
    listHTML += `</div></div></div>`;

    detailListContainer.innerHTML = calendarHTML + listHTML;
};

window.closeDetail = () => {
    const overlay = document.getElementById('detailOverlay');
    overlay.classList.remove('show');
    
    // --- é—œéµä¿®æ­£ï¼šå‹™å¿…æ¢å¾© body çš„æ²å‹•å’Œé»æ“Šè¡Œç‚º ---
    document.body.style.overflow = ''; 
    
    setTimeout(() => {
        overlay.style.display = 'none';
    }, 300);
};
        
        window.toggleCollapse = (id) => {
    const body = document.getElementById(`body-${id}`);
    const arrow = document.getElementById(`arrow-${id}`);
    if (body) {
        // åˆ‡æ› classï¼Œè§¸ç™¼ CSS transition
        const isExpanded = body.classList.toggle('expanded');
        
        // ä¿®æ­£ï¼šå¦‚æœå…ƒç´ ä¸Šæœ‰å…§è¯æ¨£å¼ display:noneï¼Œå¿…é ˆç§»é™¤å®ƒ
        if (body.style.display === 'none') {
            body.style.display = ''; 
        }

        // æ—‹è½‰ç®­é ­ï¼šå±•é–‹æ™‚ 0åº¦ (â–¼)ï¼Œæ‘ºç–Šæ™‚ -90åº¦ (â–¶)
        if (arrow) {
            arrow.style.transform = isExpanded ? "rotate(0deg)" : "rotate(-90deg)";
        }
    }
};
		
		let dragSrcElement = null;

window.handleDragStart = function(e) {
    dragSrcElement = e.currentTarget;
    e.dataTransfer.effectAllowed = 'move';
    e.currentTarget.style.opacity = '0.4';
};

window.handleDragOver = function(e) {
    if (e.preventDefault) e.preventDefault();
    return false;
};

window.handleDrop = function(e) {
    e.stopPropagation();
    e.preventDefault();
    
    const target = e.currentTarget;
    if (dragSrcElement !== target) {
        // å–å¾—ç›®å‰ç•«é¢ä¸Šæ‰€æœ‰çš„ FID é †åº
        const container = document.getElementById('favListOnMain');
        const items = Array.from(container.querySelectorAll('.draggable-item'));
        const fids = items.map(item => item.getAttribute('data-fid'));
        
        // é‡æ–°è¨ˆç®—ä½ç½®ä¸¦å„²å­˜
        const fromIndex = fids.indexOf(dragSrcElement.getAttribute('data-fid'));
        const toIndex = fids.indexOf(target.getAttribute('data-fid'));
        
        fids.splice(toIndex, 0, fids.splice(fromIndex, 1)[0]);
        
        // å„²å­˜ä¸¦é‡æ–°æ¸²æŸ“
        window.customOrder = fids;
        window.saveFavOrder(fids);
        window.renderAll();
    }
    dragSrcElement.style.opacity = '1';
    return false;
};
		
    </script>

    <style>
        :root { --mtr-red: #c0392b; --mtr-blue: #2980b9; --mtr-green: #27ae60; --mtr-dark: #000000; --mtr-yellow: #f1c40f; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 20px; }
        
        .header { 
            position: sticky; top: 0; z-index: 101; 
            background: #ffffff; color: var(--mtr-dark); 
            padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        #adminStatus { font-size: 0.7em; margin-right: 5px; }
        #loginBtn { background: var(--mtr-dark); border: none; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.8em; cursor: pointer; }
        
        .tabs { display: flex; background: white; border-bottom: 2px solid #ddd; position: sticky; top: 60px; z-index: 100; overflow-x: auto; }
        .tab-btn { flex: 1; min-width: 60px; padding: 15px 5px; border: none; background: white; font-weight: bold; color: #7f8c8d; cursor: pointer; white-space: nowrap; font-size: 0.9em; }
        .tab-btn.active { color: var(--mtr-dark); border-bottom: 4px solid var(--mtr-dark); }
        
        .container { max-width: 600px; margin: auto; padding: 10px; }
        .search-bar { background: white; padding: 10px; border-radius: 10px; margin-bottom: 10px; display: flex; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .search-bar input, .search-bar select { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white; }
        
        .timeline-card { background: white; border-radius: 12px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.08); border-left: 6px solid var(--mtr-dark); }
        .timeline-header { padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .timeline-header:hover { background: #f0f2f5; }
        .collapse-arrow { font-size: 0.7em; color: #999; transition: transform 0.3s; display: inline-block; transform: rotate(-90deg); }
        .special-badge-area { padding: 8px 15px; background: #fffdf0; border-bottom: 1px solid #ffe58f; }
        .special-desc-item { font-size: 0.85em; color: #856404; font-weight: 500; }
        .car-group-title { font-weight: bold; font-size: 1.1em; font-family: "Helvetica Neue", Arial, sans-serif; }
        .timeline-body { border-top: 1px dashed #eee; }
        
.trace-item { 
    padding: 8px 0; 
    border-left: 2px solid #ddd; 
    margin-left: 6px; /* èª¿æ•´æ­¤è™•ä»¥å‚ç›´å°é½Šç®­é ­ä¸­å¿ƒ */
    padding-left: 15px; 
    position: relative; 
}
.trace-item::before { 
    content: ""; 
    width: 8px; 
    height: 8px; 
    background: #bbb; 
    border-radius: 50%; 
    position: absolute; 
    left: -5px; /* ä½¿åœ“é»ä¸­å¿ƒè½åœ¨ border-left ä¸Š */
    top: 15px; 
}
.trace-item.latest { 
    border-left-color: var(--mtr-green); 
}
.trace-item.latest::before { 
    background: var(--mtr-green); 
}
        
        .route-badge { padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.85em; font-weight: bold; white-space: nowrap; }
        .run-no-badge { background: none; color: #999; padding: 1px 5px; border: 1px solid #999; border-radius: 4px; font-family: monospace; font-size: 0.85em; margin-right: 5px; font-weight: bold; display: inline-block; line-height: 1.2;}
        .page { display: none; } .page.active { display: block; }
        
        #detailOverlay {
            position: fixed;
            top: 105px; left: 0; right: 0; bottom: 0;
            background: #f0f2f5; z-index: 95;
            display: none; flex-direction: column; overflow: hidden;
            border-top: 1px solid #ddd;
        }
        .detail-header-sticky {
            flex-shrink: 0; background: #f0f2f5; padding: 15px;
            border-bottom: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #detailList {
            flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 40px;
            -webkit-overflow-scrolling: touch;
        }

        .car-link { cursor: pointer; margin: 0 2px;}
        .del-btn { color: #e74c3c; font-size: 0.8em; cursor: pointer; margin-left: 10px; border: 1px solid #e74c3c; padding: 1px 4px; border-radius: 4px; }
        
        .report-form { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .form-group { flex: 1; display: flex; flex-direction: column; position: relative; }
        label { font-size: 0.75em; color: #666; margin-bottom: 4px; font-weight: bold; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; font-family: inherit; }
        textarea { resize: vertical; min-height: 60px; }
        
        .section-title { font-size: 0.9em; color: #333; margin: 20px 0 10px 5px; font-weight: bold; border-left: 4px solid var(--mtr-yellow); padding-left: 10px; }
        
        .eta-platform-group { background: white; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .eta-platform-label { background: #f8f9fa; padding: 4px 10px; font-size: 0.75em; font-weight: bold; color: #666; border-bottom: 1px solid #eee; }
        .eta-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; border-bottom: 1px solid #f9f9f9; }
        .eta-row:last-child { border-bottom: none; }
        .eta-info-left { display: flex; align-items: center; gap: 6px; flex: 1; overflow: hidden; }
        .eta-dest-container { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; overflow: hidden; margin-right: 10px; }
        .eta-dest-text { font-weight: 600; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .eta-train-length { font-size: 0.8em; color: #666; margin-left: 8px; flex-shrink: 0; font-weight: bold; }
        .eta-time-text { font-weight: bold; color: #333; font-size: 1em; white-space: nowrap; min-width: 45px; text-align: right; }
        .eta-time-text.approaching { color: var(--mtr-green); }
		
		/* ç›£å¯Ÿåˆ—è¡¨æ‹–æ”¾åŠŸèƒ½æ¨£å¼ */
.draggable-item {
    cursor: grab; /* æç¤ºç”¨å®¶å¯ä»¥æŠ“å– */
    transition: transform 0.2s, opacity 0.2s;
    touch-action: none; /* é‡è¦ï¼šé˜²æ­¢æ‰‹æ©Ÿæ‹–å‹•æ™‚èˆ‡é é¢æ»¾å‹•è¡çª */
    -webkit-user-select: none; /* é˜²æ­¢æ‹–å‹•æ™‚é¸å–åˆ°æ–‡å­— */
    user-select: none;
}

/* ç•¶æ­£åœ¨æ‹–å‹•æ™‚çš„è¦–è¦ºæ•ˆæœ */
.draggable-item:active {
    cursor: grabbing;
}

/* æ‹–å‹•ä¸­çš„æ¨£å¼è¤‡å¯«ï¼ˆé¸ç”¨ï¼‰ */
.draggable-item.dragging {
    opacity: 0.5;
    transform: scale(0.98);
}

/* è®“ç›£å¯Ÿåˆ—è¡¨å…§çš„å¡ç‰‡é–“è·æ›´æ¸…æ™°ï¼Œæ–¹ä¾¿æ“ä½œ */
#favListOnMain .comp-card {
    margin-bottom: 10px;
    border: 1px solid transparent;
}

/* æ‹–å‹•ç¶“éç›®æ¨™æ™‚çš„æç¤ºï¼ˆé¸ç”¨ï¼‰ */
.draggable-item.drag-over {
    border-top: 3px solid #007bff;
}


/* å±•é–‹å‹•ç•«ç›¸é—œ */
.timeline-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding 0.3s ease;
    display: block !important; 
    padding-top: 0;
    padding-bottom: 0;
    margin: 0; /* ç¢ºä¿æ²’æœ‰é‚Šè·æ’é–‹é–“éš™ */
}

.timeline-body.expanded {
    max-height: 800px; /* å¢åŠ æ•¸å€¼ä»¥å®¹ç´å…§å®¹ */
    padding-top: 10px;
    padding-bottom: 10px;
    border-top: 1px dashed #eee; /* ç§»å‹•é‚Šæ¡†åˆ°é€™è£¡ï¼Œæ‘ºç–Šæ™‚å°±ä¸æœƒçœ‹åˆ°ç·š */
}

/* æ­·å²é é¢/å´æ¬„é€²å…¥å‹•ç•« */
#detailOverlay {
    /* ç¢ºä¿åŸæœ¬çš„ display æ§åˆ¶é‚è¼¯ä¸è®Šï¼Œä½†åŠ å…¥å‹•ç•«é¡åˆ¥ */
    transform: translateY(20px);
    opacity: 0;
    transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    pointer-events: none;
}

#detailOverlay.show {
    display: flex !important;
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
}

.page {
    display: none;
    animation: fadeIn 0.25s ease;
}

.page.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(6px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* é é¢åˆ‡æ›å‹•ç•«æ¨£å¼ */
.tab-content {
    display: none;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.tab-content.active {
    display: block;
    /* é€™è£¡ä½¿ç”¨å»¶é²ç¢ºä¿ display: block ç”Ÿæ•ˆå¾Œå†è§¸ç™¼å‹•ç•« */
}

/* ç”¨æ–¼è§¸ç™¼æ·¡å…¥æ•ˆæœçš„é¡å */
.tab-content.fade-in {
    opacity: 1;
    transform: translateY(0);
}

/* åˆ°ç«™åˆ†é å®¹å™¨å„ªåŒ– */
#etaListArea {
    padding: 5px;
}

.eta-platform-group {
    margin-bottom: 10px; /* ç¸®æ¸›å¹³å°çµ„ä¹‹é–“çš„é–“è· */
    border-radius: 10px;
    overflow: hidden;
}

.eta-platform-label {
    padding: 3px 12px; /* ç¸®æ¸›å¹³å°æ¨™é¡Œé«˜åº¦ */
    background: #f1f3f5;
    color: #495057;
    font-size: 0.75em;
    letter-spacing: 0.5px;
}

.eta-dest-container {
    display: flex;
    align-items: baseline; /* è®“ 1å¡/2å¡ æ¨™ç±¤å°é½Šç›®çš„åœ°åº•éƒ¨ */
    gap: 2px;
}

.eta-time-text {
    font-weight: 800;
}

.eta-time-text.approaching {
    animation: pulse-green 1.5s infinite;
}

@keyframes pulse-green {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* åˆ—è¡¨æ•´é«”çš„æ·¡å…¥å‹•ç•« */
@keyframes fadeInScale {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

.eta-platform-group {
    animation: fadeInScale 0.4s ease-out forwards;
}

/* å…§å®¹æ›´æ–°æ™‚çš„éæ¸¡é¡åˆ¥ */
#etaList {
    transition: opacity 0.3s ease;
}

#etaList.updating {
    opacity: 0.5; /* æ›´æ–°æ™‚ç¨å¾®è®Šé€æ˜ï¼Œçµ¦äºˆä½¿ç”¨è€…åé¥‹ */
}

/* é–ƒçˆå‹•ç•« (ç¢ºä¿åŒ…å«åœ¨å…§) */
.approaching {
    animation: blinker 1s linear infinite;
}

@keyframes blinker {
    50% { opacity: 0; }
}

/* 1. æŠ˜ç–ŠåŠŸèƒ½æ‰€éœ€çš„éš±è—é¡åˆ¥ */
.eta-row.extra-row.hidden {
    display: none !important;
}

/* 2. æ›´æ–°æ™‚çš„æ·¡å…¥æ·¡å‡ºå‹•ç•« */
#etaList {
    transition: opacity 0.3s ease;
}
#etaList.updating {
    opacity: 0.6;
}

/* 3. é€²å…¥æ™‚çš„æ»‘å‹•å‹•ç•« */
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.eta-platform-group {
    animation: fadeInUp 0.4s ease-out forwards;
}

/* 4. ã€ŒæŸ¥çœ‹æ›´å¤šã€æŒ‰éˆ•æ¨£å¼ */
.eta-more-btn {
    width: 100%;
    padding: 10px;
    background: #f8f9fa;
    border: none;
    border-top: 1px solid #eee;
    color: #2980b9;
    font-size: 0.85em;
    font-weight: bold;
    cursor: pointer;
}

/* 5. é–ƒçˆå‹•ç•« (ç”¨æ–¼å³å°‡æŠµé”/æ­£åœ¨é›¢é–‹) */
.approaching {
    animation: etaBlink 1.2s infinite;
}
@keyframes etaBlink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}


/* é¸å–®å‡èµ·å‹•ç•« */
@keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

/* é¸å–®èƒŒæ™¯æ·¡å…¥ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.action-sheet-overlay {
    animation: fadeIn 0.2s ease-out;
}

.action-sheet-content {
    animation: slideUp 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
}


/* ç§»é™¤æˆ–è¦†è“‹åŸæœ¬çš„ .timeline-body { display: none; } */
.timeline-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out, opacity 0.3s ease, padding 0.3s ease;
    opacity: 0;
    padding: 0 15px; /* æ‘ºç–Šæ™‚ä¸ä½”ç©ºé–“ */
}

/* ç•¶æœ‰ .expanded é¡åæ™‚å±•é–‹ */
.timeline-body.expanded {
    max-height: 2000px; /* çµ¦äºˆä¸€å€‹å¤§æ–¼å…§å®¹çš„æ•¸å€¼ */
    opacity: 1;
    padding: 10px 15px; /* å±•é–‹å¾Œçš„é–“è· */
}

/* ä¿®æ­£ç®­é ­çš„åˆå§‹ç‹€æ…‹èˆ‡æ—‹è½‰å‹•ç•« */
.collapse-arrow {
    display: inline-block;
    transition: transform 0.3s ease;
    transform: rotate(-90deg); /* é è¨­æŒ‡å‘å·¦æ–¹ (æ‘ºç–Š) */
}
}

/* ETA extra rows animation */
.eta-row.extra-row {
    overflow: hidden;
    max-height: 0;
    opacity: 0;
    transform: translateY(-4px);
    transition:
        max-height 0.35s ease,
        opacity 0.25s ease,
        transform 0.25s ease;
}

/* Expanded state */
.eta-row.extra-row.show {
    max-height: 60px; /* enough for one row */
    opacity: 1;
    transform: translateY(0);
}

/* ETA æ‘ºç–Šå®¹å™¨åˆå§‹ç‹€æ…‹ */
.eta-extra-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    background: #fafafa;
}

/* å±•é–‹ç‹€æ…‹ */
.eta-extra-container.expanded {
    max-height: 500px; /* è¶³ä»¥å®¹ç´å…§å®¹çš„é«˜åº¦ */
    border-top: 1px solid #eee;
}

/* æŒ‰éˆ•æ–‡å­—æ—‹è½‰æ•ˆæœ (å¯é¸) */
.eta-more-btn {
    transition: background 0.2s;
}
.eta-more-btn[data-expanded="true"] {
    background: #f0f7ff !important;
}


/* çµ±ä¸€æ‰€æœ‰è¼¸å…¥æ¡†çš„é«˜åº¦ã€é‚Šè·èˆ‡ç›’å­æ¨¡å‹ */
.form-group input[type="text"], 
.form-group input[type="number"],
.form-group select {
    width: 100%;
    height: 42px; /* å›ºå®šé«˜åº¦ç¢ºä¿å°é½Š */
    padding: 8px 12px; /* çµ±ä¸€å…§é‚Šè· */
    font-size: 16px; /* çµ±ä¸€å­—é«”å¤§å°ï¼Œé¿å…æ‰‹æ©Ÿè‡ªå‹•ç¸®æ”¾ */
    border: 1px solid #ddd;
    border-radius: 8px;
    box-sizing: border-box; /* é—œéµï¼šç¢ºä¿ padding ä¸æœƒæ’é–‹å¯¬åº¦ */
    appearance: none; /* ç§»é™¤ç€è¦½å™¨é è¨­æ¨£å¼ */
    -webkit-appearance: none;
}

/* ä¿®æ­£æ•¸å­—è¼¸å…¥æ¡†åœ¨ Chrome/Safari çš„é¡å¤–é«˜åº¦ */
input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button { 
    margin: 0; 
}





/* è®“ç›£å¯Ÿåˆ—è¡¨çš„å¡ç‰‡é¡¯ç¤ºç‚ºå¯æŠ“å–ç‹€æ…‹ */
.draggable-item {
    cursor: grab;
    user-select: none;
    touch-action: none; /* æ”¹å–„ç§»å‹•ç«¯é«”é©— */
}

.draggable-item:active {
    cursor: grabbing;
}

/* ç¢ºä¿æ‹–æ‹½æ™‚ä¸æœƒæ„å¤–è§¸ç™¼å…§éƒ¨çš„é»æ“Šäº‹ä»¶ */
.draggable-item .timeline-header {
    pointer-events: auto;
}


.toast-msg {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: #333;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    transition: transform 0.3s ease;
    font-size: 0.95em;
}
.toast-msg.show {
    transform: translateX(-50%) translateY(0);
}


/* ä¿®æ”¹å¾Œçš„å‹•ç•«å®šç¾© */
@keyframes cardEntrance {
    from {
        opacity: 0;
        /* ä½¿ç”¨ translate3d å¼·åˆ¶å•Ÿå‹• GPU åŠ é€Ÿ */
        transform: translate3d(0, 10px, 0);
    }
    to {
        opacity: 1;
        transform: translate3d(0, 0, 0);
    }
}

.timeline-card {
    /* ä½¿ç”¨ ease-out æˆ– cubic-bezier æœƒæ¯” linear æ›´è‡ªç„¶ */
    animation: cardEntrance 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    will-change: transform, opacity;
    /* ç¢ºä¿åˆå§‹ç‹€æ…‹æ˜¯é€æ˜çš„ï¼Œé¿å…å‹•ç•«å‰é–ƒçˆ */
    backface-visibility: hidden;
}

/* æ”¹é€²äº¤éŒ¯å‹•ç•« (Staggered Animation) çš„é–“éš”ï¼Œç¸®çŸ­å»¶é²è®“æ„Ÿè¦ºæ›´æµæš¢ */
.timeline-card:nth-child(1) { animation-delay: 0.03s; }
.timeline-card:nth-child(2) { animation-delay: 0.06s; }
.timeline-card:nth-child(3) { animation-delay: 0.09s; }
.timeline-card:nth-child(4) { animation-delay: 0.12s; }
.timeline-card:nth-child(n+5) { animation-delay: 0.15s; }


/* ETA é€²å…¥å‹•ç•«å®šç¾© */
@keyframes etaEntrance {
    from {
        opacity: 0;
        transform: translate3d(0, 10px, 0); /* ä½¿ç”¨ 3D åŠ é€Ÿæå‡æµæš¢åº¦ */
    }
    to {
        opacity: 1;
        transform: translate3d(0, 0, 0);
    }
}

/* å¥—ç”¨åˆ° ETA å¹³å°çµ„å®¹å™¨ */
.eta-platform-group {
    animation: etaEntrance 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
    will-change: transform, opacity;
    backface-visibility: hidden;
}

/* å¢åŠ äº¤éŒ¯å‹•ç•«æ•ˆæœ (Staggered Animation)ï¼Œè®“åˆ—è¡¨åƒæ‰‡å­ä¸€æ¨£å±•é–‹ */
.eta-platform-group:nth-child(1) { animation-delay: 0.03s; }
.eta-platform-group:nth-child(2) { animation-delay: 0.06s; }
.eta-platform-group:nth-child(3) { animation-delay: 0.09s; }
.eta-platform-group:nth-child(4) { animation-delay: 0.12s; }
.eta-platform-group:nth-child(n+5) { animation-delay: 0.15s; }

/* å„ªåŒ–æ›´æ–°æ™‚çš„é€æ˜åº¦éæ¸¡ï¼Œé¿å…ç”Ÿç¡¬çš„é–ƒçˆ */
#etaList {
    transition: opacity 0.2s ease;
}
#etaList.updating {
    opacity: 0.4;
}


/* --- ETA å‹•ç•«é‚è¼¯ --- */

/* 1. æ»‘å…¥å‹•ç•« (ç”¨æ–¼åˆæ¬¡é€²å…¥æˆ–åˆ‡æ›è»Šç«™) */
@keyframes etaSlideIn {
    from { 
        opacity: 0; 
        transform: translate3d(0, 15px, 0); 
    }
    to { 
        opacity: 1; 
        transform: translate3d(0, 0, 0); 
    }
}

/* 2. ç°¡å–®æ·¡å…¥å‹•ç•« (ç”¨æ–¼å®šæ™‚æ•¸æ“šæ›´æ–°) */
@keyframes etaFadeSimple {
    from { opacity: 0.5; }
    to { opacity: 1; }
}

/* æ»‘å…¥å‹•ç•«ï¼šç”¨æ–¼åˆ‡æ›è»Šç«™æˆ–åˆ†é  */
@keyframes etaSlideIn {
    from { 
        opacity: 0; 
        transform: translate3d(0, 15px, 0); 
    }
    to { 
        opacity: 1; 
        transform: translate3d(0, 0, 0); 
    }
}

/* é è¨­ï¼šæ‰€æœ‰å¹³å°çµ„ä½¿ç”¨ç°¡å–®æ·¡å…¥ */
.eta-platform-group {
    animation: etaFadeSimple 0.4s ease-out both;
}

/* æ‰‹å‹•åˆ‡æ›æ¨¡å¼ï¼šå•Ÿç”¨æ»‘å…¥èˆ‡éšæ¢¯å¼å»¶é² */
.entrance-anim .eta-platform-group {
    animation: etaSlideIn 0.45s cubic-bezier(0.23, 1, 0.32, 1) both;
}

/* éšæ¢¯å¼å»¶é² (åƒ…åœ¨ entrance-anim ä¸‹ç”Ÿæ•ˆ) */
.entrance-anim .eta-platform-group:nth-child(1) { animation-delay: 0.02s; }
.entrance-anim .eta-platform-group:nth-child(2) { animation-delay: 0.05s; }
.entrance-anim .eta-platform-group:nth-child(3) { animation-delay: 0.08s; }
.entrance-anim .eta-platform-group:nth-child(n+4) { animation-delay: 0.11s; }

/* æ•¸æ“šæ›´æ–°ä¸­çš„ç‹€æ…‹ */
#etaList.updating {
    opacity: 0.6;
}


/* æ›æœˆå‹•ç•« */
@keyframes monthSlideIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}

.month-anim-active {
    animation: monthSlideIn 0.3s ease-out forwards;
}

/* é¸ä¸­æ¡†å‹•ç•«ï¼šç¢ºä¿åˆ‡æ›æ—¥æœŸæ™‚ï¼ŒèƒŒæ™¯å’Œé‚Šæ¡†æ˜¯ã€Œæ»‘ã€éå»çš„æ„Ÿè¦º */
.day-item {
    transition: background 0.25s ease-out, 
                border-color 0.25s ease-out, 
                box-shadow 0.25s ease-out, 
                color 0.2s ease;
    will-change: background, border-color; /* æ•ˆèƒ½å„ªåŒ– */
}


    </style>
</head>

<body>

<header style="position: sticky; top: 0; z-index: 100; background: #fff; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center;">
    <div style="display: flex; align-items: center; gap: 8px;">
        <h1 style="margin: 0; font-size: 1.5em; color: #333;">ğŸšˆ LRSpotter</h1>
        </div>
    <div id="authArea">
        <button id="loginBtn" style="padding: 8px 16px; background: #00000; color: white; border: none; border-radius: 20px; font-weight: 500; cursor: pointer;">ç™»å…¥</button>
    </div>
</header>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('mainPage', this)">æäº¤å ±å‘Š</button>
    <button class="tab-btn" onclick="switchTab('livePage', this)">è¡Œè¹¤æœå°‹</button>
    <button class="tab-btn" onclick="switchTab('flashPage', this)">ä»ŠæœŸé–ƒå¡</button>
    <button class="tab-btn" onclick="switchTab('etaPage', this); updateETAList();">åˆ°ç«™æ™‚é–“</button>
</div>

<div class="container">
    <div id="mainPage" class="page active">
	<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85em; border: 1px solid #ffeeba;">
            âš ï¸ ç³»çµ±æ¸¬è©¦ä¸­ï¼Œå¦‚æœ‰å•é¡Œè«‹è¯çµ¡é–‹ç™¼äººå“¡ï¼Œæ•¬è«‹åŸè«’ã€‚
        </div>
    <div class="report-form">
        <div class="form-row">
            <div class="form-group" style="flex:6.5;">
                <label>è»Šç·¨</label>
				<input type="text" id="carId" placeholder="1001-1006" oninput="renderAll()" style="flex: 1;">
            </div>
            <div class="form-group" style="flex:3.5; position: relative;">
                <label>è»Šåº</label>
				<input type="text" id="runNo" placeholder="193" oninput="checkRunNo()" style="flex: 1;">
                <div id="runSuggestion" style="position: absolute; top: 100%; left: 0; right: 0; background: #fffbe6; border: 1px solid #ffe58f; border-radius: 8px; padding: 10px; z-index: 50; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div id="suggestionText" style="font-size:12px; color:#856404;"></div>
                    <button id="applyBtn" style="background:var(--mtr-blue); color:white; border:none; padding:6px; border-radius:4px; font-size:12px; width:100%; cursor:pointer; margin-top:5px;">å¥—ç”¨</button>
                </div>
            </div>
        </div>

        <div class="form-row">
        <div class="form-group" style="flex:3;">
            <label>è·¯ç¶«</label>
            <select id="routeSelect" onchange="onRouteUpdate()">
            </select>
        </div>
        <div class="form-group" style="flex:4;">
            <label>å¾€</label>
            <select id="directionSelect" onchange="checkSpecialDestination()">
            </select>
        </div>
        <div class="form-group" style="flex:4;">
            <label>ä½ç½®</label>
            <select id="stationSelect">
            </select>
        </div>
		</div>
		
        <div class="form-row">
            <div class="form-group" style="flex:1;">
                <label>å‚™è¨»</label>
				<input type="text" id="memo" placeholder="è»Šå‹™èª¿å‹•ã€ç‰¹åˆ¥ç­æ¬¡ã€æ”¹é“è¡Œé§›ç­‰" oninput="renderAll()" style="flex: 1;">
            </div>
        </div>

        <button onclick="addReport()" style="background:var(--mtr-green); color:white; border:none; padding:15px; border-radius:10px; width:100%; font-weight:bold; font-size:12px; margin-top:10px; cursor:pointer;">æäº¤</button>
    </div>

    <div class="section-title">ç›£å¯Ÿåˆ—è¡¨</div>
    <div id="favListOnMain">
        <div class="timeline-indicator" style="background: #541B15;"></div>
        
    </div>
    </div>

    <div id="livePage" class="page">
<div class="search-bar" style="display: flex; flex-wrap: wrap; gap: 8px;">
    <input type="date" id="searchDate" onchange="renderAll()" style="flex: 1; min-width: 120px;" value="2026-01-29">
    
    <div style="flex: 2; position: relative; display: flex; align-items: center; min-width: 150px;">
        <input type="text" id="searchComp" placeholder="æœå°‹ç·¨çµ„" 
               style="width: 100%; padding: 12px 35px 12px 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"> <span id="clearSearchComp" 
              style="position: absolute; right: 10px; cursor: pointer; color: #ccc; display: none; font-size: 20px; line-height: 1;">
            &times;
        </span>
    </div>

    <select id="searchRoute" onchange="renderAll()" style="flex: 1.2; min-width: 100px; margin-top: 4px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        <option value="" selected="selected">æ‰€æœ‰è·¯ç¶«</option>
    </select>

    <select id="sortOrder" onchange="renderAll()" style="flex: 1.2; min-width: 100px; margin-top: 4px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        <option value="reportTime" selected="selected">æŒ‰å ±å‘Šæ™‚é–“</option>
        <option value="routeRun">æŒ‰è·¯ç¶«è»Šåº</option>
    </select>

    <button id="btnResetFilters" style="flex: 0.8; padding: 8px; background: #ffffff; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; color: #555; font-size: 0.9em; white-space: nowrap; margin-top: 4px;">
        é‡ç½®
    </button>
</div>

        <div id="masterList">
                <div class="timeline-card" style="border-left-color:#F2858E; ">
                </div>
        </div>
</div>

    <div id="flashPage" class="page">
        <div class="search-bar">
            <input type="date" id="flashDate" onchange="renderAll()" style="width: 100%;" value="2026-01-29">
        </div>
        <div id="flashList"></div>
    </div>

    <div id="etaPage" class="page">
	<div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85em; border: 1px solid #ffeeba;">
            âš ï¸ ã€Œåˆ°ç«™æ™‚é–“é¡¯ç¤ºè»Šç·¨åŠŸèƒ½ã€ç¾æ­£æ¸¬è©¦ä¸­ï¼Œè¡Œè¹¤åªä¾›åƒè€ƒã€‚
        </div>
        <div class="search-bar" style="display: flex; gap: 8px;">
    <input type="text" id="etaStationInput" placeholder="ç·¨è™Ÿ" 
           style="flex: 1; min-width: 0;" 
           oninput="syncETAList('input')" value="100">
           
    <select id="etaStationSelect" onchange="syncETAList('select')" 
            style="flex: 1; min-width: 0;">
    </select>
    
    <button onclick="updateETAList()" 
            style="padding: 0 15px; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer; white-space: nowrap;">
        æ›´æ–°
    </button>
</div>
        <div id="etaList">è«‹è¼¸å…¥æˆ–é¸æ“‡è»Šç«™ä»¥æŸ¥çœ‹å³æ™‚ç­æ¬¡</div>
    </div>
</div>
<div id="detailOverlay">
    <div class="detail-header-sticky">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="detailTitle" style="margin:0; font-size: 1.2em;">è¨˜éŒ„è©³æƒ…</h2>
            <button onclick="closeDetail()" style="padding:8px 16px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer;">è¿”å›</button>
        </div>
        </div>
    <div id="detailList"></div>
</div>


<script>
// --- æ•ˆèƒ½å„ªåŒ–ï¼šæ—¥æœŸå¿«å– ---
const dateCache = new Map();
window.getOperationalDate = (timestamp) => {
    if (!timestamp) return "";
    const cacheKey = Math.floor(timestamp / 60000); // ä»¥åˆ†é˜ç‚ºå–®ä½åšå¿«å–
    if (dateCache.has(cacheKey)) return dateCache.get(cacheKey);

    const date = new Date(timestamp);
    if (date.getHours() < 4) date.setDate(date.getDate() - 1);
    const result = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    
    dateCache.set(cacheKey, result);
    if (dateCache.size > 1000) dateCache.delete(dateCache.keys().next().value);
    return result;
};

// --- æ•ˆèƒ½å„ªåŒ–ï¼šDebounce å‡½å¼ ---
function debounce(func, delay) {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => func(...args), delay);
    };
}

// åŒ…è£åŸæœ¬çš„ renderAll
window.debouncedRenderAll = debounce(() => {
    if (typeof window.renderAll === 'function') window.renderAll();
}, 300);


const routeCfg = { "505": ["ä¸‰è–", "å…†åº·"], "506P": ["å…†åº·"], "507": ["ç”°æ™¯", "å±¯é–€ç¢¼é ­"], "507P": ["å±¯é–€ç¢¼é ­"], "610": ["å…ƒæœ—", "å±¯é–€ç¢¼é ­"], "614": ["å…ƒæœ—", "å±¯é–€ç¢¼é ­"], "614P": ["å…†åº·", "å±¯é–€ç¢¼é ­"], "615": ["å…ƒæœ—", "å±¯é–€ç¢¼é ­"], "615P": ["å…†åº·", "å±¯é–€ç¢¼é ­"], "705": ["å¤©æ°´åœå¾ªç’°ç¶«", "ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™"], "706": ["å¤©æ°´åœå¾ªç’°ç¶«", "ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™"], "720": ["å¤©æ¦®"], "751": ["å‹æ„›", "å¤©é€¸"], "751P": ["å¤©æ°´åœ", "å¤©é€¸"], "751L": ["å±¯é–€ç¢¼é ­"], "761P": ["å…ƒæœ—", "å¤©é€¸"], "ä¸è¼‰å®¢": ["ä¸‰è–", "å±¯é–€ç¢¼é ­", "ç”°æ™¯", "å…†åº·", "å…ƒæœ—", "å‹æ„›", "å¤©é€¸", "å¤©æ¦®", "å¤©æ°´åœ", "---"], "å¸æ©Ÿè¨“ç·´": ["ä¸‰è–", "å±¯é–€ç¢¼é ­", "ç”°æ™¯", "å…†åº·", "å…ƒæœ—", "å‹æ„›", "å¤©é€¸", "å¤©æ¦®", "å¤©æ°´åœ", "---"], "å›å» ": ["---"], "å°ˆç”¨": ["ä¸‰è–", "å±¯é–€ç¢¼é ­", "ç”°æ™¯", "å…†åº·", "å…ƒæœ—", "å‹æ„›", "å¤©é€¸", "å¤©æ¦®", "å¤©æ°´åœ", "---"], "å±¯é–€å°ˆç¶«": ["å±¯é–€"], "å…ƒæœ—å°ˆç¶«": ["å¤©é€¸"] };
const colorMap = { "505":"#D92329", "506P":"#000000", "507":"#00A551", "507P":"#00A551", "610":"#541B15", "614":"#00C0F3", "614P":"#F2858E", "615":"#FFDD00", "615P":"#006585", "705":"#6EBF45", "706":"#B17AB5", "720":"#000000", "751":"#F48221", "751L":"#F48221", "751P":"#000000", "751L":"#F48221", "761P":"#6E2C91", "ä¸è¼‰å®¢":"#000000", "å¸æ©Ÿè¨“ç·´":"#000000", "å›å» ":"#000000", "å°ˆç”¨":"#000000", "å±¯é–€å°ˆç¶«": "#E67237", "å…ƒæœ—å°ˆç¶«": "#56B847"};
const stationDB = [
    {id:1, zh:"å±¯é–€ç¢¼é ­", r:["506P","507","507P","610","614","614P","615","615P","å±¯é–€å°ˆç¶«"]},
    {id:10, zh:"ç¾æ¨‚", r:["506P","610","615","615P"]},
    {id:15, zh:"è´è¶", r:["506P","610","615","615P","å±¯é–€å°ˆç¶«"]},
    {id:20, zh:"è¼•éµè»Šå» ", r:["506P","610","615","615P"]},
    {id:30, zh:"é¾é–€", r:["506P","610","615","615P","å±¯é–€å°ˆç¶«"]},
    {id:40, zh:"é’å±±æ‘", r:["506P","610","615","615P"]},
    {id:50, zh:"é’é›²", r:["506P","610","615","615P"]},
    {id:60, zh:"å»ºå®‰", r:["505","506P"]},
    {id:70, zh:"æ²³ç”°", r:["507","751"]},
    {id:75, zh:"è”¡æ„æ©‹", r:["507","751","å±¯é–€å°ˆç¶«"]},
    {id:80, zh:"æ¾¤è±", r:["610","751","751L"]},
    {id:90, zh:"å±¯é–€é†«é™¢", r:["610","751","751L"]},
    {id:100, zh:"å…†åº·", r:["505","506P","507P","610","614","614P","615","615P","720","751","751L","å±¯é–€å°ˆç¶«"]},
    {id:110, zh:"éº’éºŸ", r:["505","615P","å±¯é–€å°ˆç¶«"]},
    {id:120, zh:"é’æ¾", r:["505","507P","615","615P"]},
    {id:130, zh:"å»ºç”Ÿ", r:["505","507P","615","615P"]},
    {id:140, zh:"ç”°æ™¯", r:["505","507","507P","615","615P"]},
    {id:150, zh:"è‰¯æ™¯", r:["505","507","615","615P"]},
    {id:160, zh:"æ–°åœ", r:["505","507","615","615P"]},
    {id:170, zh:"çŸ³æ’", r:["505","610","615","615P"]},
    {id:180, zh:"å±±æ™¯ (åŒ—)", r:["505"]},
    {id:190, zh:"å±±æ™¯ (å—)", r:["505","å±¯é–€å°ˆç¶«"]},
    {id:200, zh:"é³´ç´", r:["505","610","615","615P"]},
    {id:212, zh:"å¤§èˆˆ (åŒ—)", r:["507","610"]},
    {id:220, zh:"å¤§èˆˆ (å—)", r:["507","610"]},
    {id:230, zh:"éŠ€åœ", r:["507","610"]},
    {id:240, zh:"å…†ç¦§", r:["507","614","614P"]},
    {id:250, zh:"å±¯é–€æ³³æ± ", r:["507","614","614P","å±¯é–€å°ˆç¶«"]},
    {id:260, zh:"è±æ™¯åœ’", r:["507","614","614P"]},
    {id:265, zh:"å…†éºŸ", r:["505","507","614","614P"]},
    {id:270, zh:"å®‰å®š", r:["505","507","614","614P","751"]},
    {id:275, zh:"å‹æ„›", r:["751"]},
    {id:280, zh:"å¸‚ä¸­å¿ƒ", r:["505","507","614","614P","751","å±¯é–€å°ˆç¶«"]},
    {id:295, zh:"å±¯é–€", r:["505","506P","507","751","å±¯é–€å°ˆç¶«"]},
    {id:300, zh:"æ¯æ¸¡", r:["506P","614","614P"]},
    {id:310, zh:"ä½•ç¦å ‚", r:["506P","614","614P"]},
    {id:320, zh:"æ–°å¢Ÿ", r:["506P","614","614P"]},
    {id:330, zh:"æ™¯å³°", r:["506P","614","614P"]},
    {id:340, zh:"é³³åœ°", r:["506P","614","614P"]},
    {id:350, zh:"è—åœ°", r:["507P","610","614","615","720","751","751L"]},
    {id:360, zh:"æ³¥åœ", r:["507P","610","614","615","720","751","751L"]},
    {id:370, zh:"é¾å±‹æ‘", r:["507P","610","614","615","720","751","751L"]},
    {id:380, zh:"æ´ªæ°´æ©‹", r:["507P","610","614","615","720","751","751L"]},
    {id:390, zh:"å¡˜åŠæ‘", r:["610","614","615","761P"]},
    {id:400, zh:"å±å±±", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:425, zh:"å‘å°¾æ‘", r:["751","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:430, zh:"å¤©æ°´åœ", r:["705","706","751","751P","å…ƒæœ—å°ˆç¶«"]},
    {id:435, zh:"å¤©æ…ˆ", r:["705","706","751","751P"]},
    {id:445, zh:"å¤©è€€", r:["705","706","720","761P"]},
    {id:448, zh:"æ¨‚æ¹–", r:["705","706","720","761P"]},
    {id:450, zh:"å¤©æ¹–", r:["705","706","751","751P"]},
    {id:455, zh:"éŠ€åº§", r:["705","706","751","751P"]},
    {id:460, zh:"å¤©ç‘", r:["705","706","720","761P"]},
    {id:468, zh:"é Œå¯Œ", r:["705","706","751","751P","761P"]},
    {id:480, zh:"å¤©å¯Œ", r:["705","706","751","751P","761P"]},
    {id:490, zh:"ç¿ æ¹–", r:["720","751","751P"]},
    {id:500, zh:"å¤©æ¦®", r:["705","706","751","751P","761P"]},
    {id:510, zh:"å¤©æ‚…", r:["705","706"]},
    {id:520, zh:"å¤©ç§€", r:["705","706"]},
    {id:530, zh:"æ¿•åœ°å…¬åœ’", r:["705","706","å…ƒæœ—å°ˆç¶«"]},
    {id:540, zh:"å¤©æ’", r:["705","706"]},
    {id:550, zh:"å¤©é€¸", r:["705","706","751","751P","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:560, zh:"æ°´é‚Šåœ", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:570, zh:"è±å¹´è·¯", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:580, zh:"åº·æ¨‚è·¯", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:590, zh:"å¤§æ£ è·¯", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:600, zh:"å…ƒæœ—", r:["610","614","615","761P","å…ƒæœ—å°ˆç¶«"]},
    {id:920, zh:"ä¸‰è–", r:["505","å±¯é–€å°ˆç¶«"]}
];
/**
 * è¼•éµè»Šåºè‡ªå‹•åŒ–èˆ‡æç¤ºç³»çµ± - å®Œæ•´æ•´åˆç‰ˆ
 * ä¿®æ”¹å…§å®¹ï¼šåƒ…åœ¨æäº¤ (addReport) æ™‚å¼·åˆ¶å°‡è»Šåºè£œè¶³ä¸‰ä½æ•¸
 */

window.customRteKey = null;
window.processedActions = new Set(); 

const specialTips = { 
    "901": "åˆ°é”å…†åº·ç«™å¾Œæ”¹ç‚º615å‰å¾€å±¯é–€ç¢¼é ­", 
    "902": "åˆ°é”å…†åº·ç«™å¾Œæ”¹ç‚º507På‰å¾€å±¯é–€ç¢¼é ­", 
    "903": "åˆ°é”æ¾¤è±ç«™å¾Œæ”¹ç‚º507å‰å¾€å±¯é–€ç¢¼é ­"
};

/**
 * ä¸»è¦è­˜åˆ¥å‡½å¼ (ä¿æŒç”¨æˆ¶åŸå§‹è¼¸å…¥æ„Ÿï¼Œä¸å¼·åˆ¶æ›´æ­£ç•Œé¢)
 */
function checkRunNo() {
    const runStr = document.getElementById('runNo').value.trim();
    
    if (!runStr) {
        window.processedActions.clear();
        return;
    }

    // 1. è‡ªå‹•é¸æ“‡è·¯ç·š (éœé»˜åŸ·è¡Œ)
    processAutoRoute(runStr);

    // 2. æª¢æŸ¥ç‰¹æ®Šç›®çš„åœ°ç¢ºèª (705/706)
    if (checkSpecialDestination(runStr)) return;

    // 3. è™•ç† 904 (ä¸€ç´šé¸å–®é›™é¸é …)
    if (runStr === "904" && !window.processedActions.has('special_904')) {
        show904Menu();
        return;
    }

    // 4. æª¢æŸ¥å…¶ä»–ç›´é€šç­æ¬¡ (901-903)
    const specialKey = 'special_' + runStr;
    if (specialTips[runStr] && !window.processedActions.has(specialKey)) {
        showRunSuggestionMenu(`${specialTips[runStr]}`, () => {
            applySuggestion(); 
        }, 'special', specialKey);
    }
}

/**
 * 904 å°ˆç”¨ä¸€ç´šé¸å–®
 */
function show904Menu() {
    const existing = document.getElementById('run-action-sheet');
    if (existing) existing.remove();

    const html = `
    <div id="run-action-sheet" class="action-sheet-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10001; display: flex; align-items: flex-end;">
        <div class="action-sheet-content" onclick="event.stopPropagation()" style="width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; width: 100%;">
            <div style="text-align: center; margin-bottom: 20px; color: #333; font-size: 1.05em; line-height: 1.5;"><b style="color: #ff9500;">âš ï¸ åµæ¸¬åˆ°ç›´é€šï¼ç‰¹åˆ¥ç­æ¬¡</b><br>è«‹é¸æ“‡ç¾æ™‚é©ç”¨ç­æ¬¡<b></br><span style="font-size: 0.85em; color: #888;">ï¼ˆè‹¥å±¬å¯¦è«‹æŒ‰ç¢ºèªï¼Œå°‡è‡ªå‹•å¡«å¯«å‚™è¨»ï¼‰</span>
            </div>
            
            <button id="opt-904-a" style="width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #007aff; background: #f0f7ff; color: #007aff; font-size: 1.05em; font-weight: 600; cursor: pointer; text-align: center;">
                åˆ°é”å…†åº·ç«™å¾Œæ”¹ç‚º 720 å¾€å¤©æ¦®
            </button>

            <button id="opt-904-b" style="width: 100%; padding: 16px; margin-bottom: 20px; border-radius: 12px; border: 1px solid #007aff; background: #f0f7ff; color: #007aff; font-size: 1.05em; font-weight: 600; cursor: pointer; text-align: center;">
                åˆ°é”å¤©æ¦®ç«™å¾Œæ”¹ç‚º 751 å¾€å‹æ„›
            </button>

            <button id="run-cancel-btn" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: #f5f5f5; color: #333; font-size: 1.05em; cursor: pointer;">
                å–æ¶ˆ
            </button>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    const close = () => {
        window.processedActions.add('special_904');
        document.getElementById('run-action-sheet').remove();
    };

    document.getElementById('run-action-sheet').onclick = close;
    
    document.getElementById('opt-904-a').onclick = () => {
        const rs = document.getElementById('routeSelect');
        const ds = document.getElementById('directionSelect');
        const memo = document.getElementById('memo');
        
        setSpecialRoute(rs, "506Px720", "506P");
        ds.innerHTML = `<option>å¤©æ¦®</option>`;
        memo.value = "åˆ°é”å…†åº·ç«™å¾Œæ”¹ç‚º720å‰å¾€å¤©æ¦®";
        updateStationList("506P", [100]);
        close();
    };

    document.getElementById('opt-904-b').onclick = () => {
        const rs = document.getElementById('routeSelect');
        const ds = document.getElementById('directionSelect');
        const memo = document.getElementById('memo');

        setSpecialRoute(rs, "720x751", "720");
        ds.innerHTML = `<option>å‹æ„›</option>`;
        memo.value = "åˆ°é”å¤©æ¦®ç«™å¾Œæ”¹ç‚º751å‰å¾€å‹æ„›";
        updateStationList("720", [], "751");
        close();
    };

    document.getElementById('run-cancel-btn').onclick = close;
}


function showActionSheet(config) {
    const existing = document.getElementById('run-action-sheet');
    if (existing) existing.remove();

    const html = `
    <div id="run-action-sheet" class="action-sheet-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10001; display: flex; align-items: flex-end;">
        <div class="action-sheet-content" onclick="event.stopPropagation()" style="width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; width: 100%;">
            <div style="text-align: center; margin-bottom: 20px; color: #333; font-size: 1.05em; line-height: 1.5;">
                ${config.title}
            </div>
            
            ${config.buttons.map((btn, index) => `
                <button id="sheet-btn-${index}" style="width: 100%; padding: 16px; margin-bottom: ${index === config.buttons.length - 1 ? '20px' : '10px'}; border-radius: 12px; border: ${btn.primary ? '1px solid #007aff' : 'none'}; background: ${btn.primary ? '#f0f7ff' : '#f5f5f5'}; color: ${btn.danger ? '#ff3b30' : (btn.primary ? '#007aff' : '#333')}; font-size: 1.05em; font-weight: 600; cursor: pointer; text-align: center;">
                    ${btn.text}
                </button>
            `).join('')}

            <button id="run-cancel-btn" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: #eee; color: #333; font-size: 1.05em; cursor: pointer;">
                å–æ¶ˆ
            </button>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', html);

    const close = () => {
        const sheet = document.getElementById('run-action-sheet');
        if (sheet) sheet.remove();
    };

    document.getElementById('run-action-sheet').onclick = close;
    document.getElementById('run-cancel-btn').onclick = close;

    config.buttons.forEach((btn, index) => {
        document.getElementById(`sheet-btn-${index}`).onclick = () => {
            btn.onClick();
            close();
        };
    });
}


/**
 * è¼”åŠ©ï¼šè¨­å®šç‰¹æ®Šè·¯ç·šé¸é …
 */
function setSpecialRoute(rs, value, display) {
    let opt = [...rs.options].find(o => o.value === value);
    if (!opt) {
        opt = document.createElement('option');
        opt.value = value;
        rs.appendChild(opt);
    }
    opt.innerText = display;
    rs.value = value;
    window.customRteKey = value;
    if (typeof onRouteUpdate === "function") onRouteUpdate();
}

/**
 * è¼”åŠ©ï¼šæ›´æ–°è»Šç«™æ¸…å–®
 */
function updateStationList(mainRoute, extraIds = [], secondRoute = null) {
    const ss = document.getElementById('stationSelect');
    const list = stationDB.filter(s => 
        s.r.includes(mainRoute) || 
        extraIds.includes(s.id) || 
        (secondRoute && s.r.includes(secondRoute))
    ).sort((a, b) => a.id - b.id);
    ss.innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
}

/**
 * è™•ç†è‡ªå‹•åŒ–å¡«å¯«
 */
function processAutoRoute(runStr) {
    let run = parseInt(runStr);
    if (isNaN(run)) return;
    let autoRoute = null, autoDest = null;

    if (run >= 1 && run <= 20) autoRoute = "505";
    else if (run >= 21 && run <= 40) autoRoute = "507";
    else if (run >= 51 && run <= 70) autoRoute = "610";
    else if (run >= 71 && run <= 90) autoRoute = "614";
    else if (run >= 201 && run <= 220) { autoRoute = "614P"; autoDest = "å…†åº·"; }
    else if (run >= 221 && run <= 230) { autoRoute = "614P"; autoDest = "å±¯é–€ç¢¼é ­"; }
    else if ((run >= 91 && run <= 100) || (run >= 191 && run <= 200)) autoRoute = "761P";
    else if (run >= 111 && run <= 130) autoRoute = "615";
    else if (run >= 131 && run <= 140 || run === 436) autoRoute = "705";
    else if (run >= 141 && run <= 150 || run === 446) autoRoute = "706";
    else if (run >= 171 && run <= 187) autoRoute = "751";
    else if (run >= 904 && run <= 905) autoRoute = "506P";
    else if (run === 189) autoRoute = "751P";

    if (autoRoute) {
        document.getElementById('routeSelect').value = autoRoute;
        if (typeof onRouteUpdate === "function") onRouteUpdate();
        if (autoDest) {
            document.getElementById('directionSelect').value = autoDest;
            if (typeof onRouteUpdate === "function") onRouteUpdate();
        }
    }
}

/**
 * æª¢æŸ¥ç›®çš„åœ°ç‹€æ…‹ (705/706)
 */
function checkSpecialDestination() {
    const route = document.getElementById('routeSelect').value;
    const dest = document.getElementById('directionSelect').value;
    const actionKey = `display_${route}_${dest}`;

    if (document.getElementById('run-action-sheet')) return false;
    if (window.processedActions.has(actionKey)) return false;

    if ((route === "705" || route === "706") && dest === "ä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™") {
        const msg = `è©²åˆ—è»Šæ˜¯å¦æœ‰æ›´æ”¹é›»ç‰Œé¡¯ç¤ºç‚ºã€Œä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™ã€ï¼Ÿ`;
        const action = () => { 
            document.getElementById('memo').value = "é›»ç‰Œé¡¯ç¤ºã€Œä»¥å¤©æ°´åœç‚ºçµ‚é»ç«™ã€ï¼ˆæœ‰Lç‰Œï¼‰"; 
        };
        showRunSuggestionMenu(msg, action, 'display', actionKey);
        return true;
    }
    return false;
}

/**
 * é€šç”¨ Action Sheet UI
 */
window.showRunSuggestionMenu = function(message, onApply, type = 'special', actionKey = null) {
    const existing = document.getElementById('run-action-sheet');
    if (existing) existing.remove();

    let infoHtml = type === 'display' ? `
        <div style="text-align: center; margin-bottom: 20px; color: #333; font-size: 1.05em; line-height: 1.5;">
            <b style="color: #ff9500;">âš ï¸ é›»ç‰Œé¡¯ç¤ºç¢ºèª</b><br>${message}</br>
			<span style="font-size: 0.85em; color: #888;">ï¼ˆè‹¥å±¬å¯¦è«‹æŒ‰ç¢ºèªï¼Œå°‡è‡ªå‹•å¡«å¯«å‚™è¨»ï¼‰</span>
        </div>` : `
        <div style="text-align: center; margin-bottom: 20px; color: #333; font-size: 1.05em; line-height: 1.5;">
            <b style="color: #ff9500;">âš ï¸ åµæ¸¬åˆ°ç›´é€šï¼ç‰¹åˆ¥ç­æ¬¡</b><br>æœ¬ç­è»Š${message}<b></br>
			<span style="font-size: 0.85em; color: #888;">ï¼ˆè‹¥å±¬å¯¦è«‹æŒ‰ç¢ºèªï¼Œå°‡è‡ªå‹•å¡«å¯«å‚™è¨»ï¼‰</span>
        </div>`;

    const html = `
    <div id="run-action-sheet" class="action-sheet-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10001; display: flex; align-items: flex-end;">
        <div class="action-sheet-content" onclick="event.stopPropagation()" style="width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box;">
            ${infoHtml}
            <button id="run-apply-btn" style="width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: none; background: #007aff; color: #fff; font-size: 1.05em; font-weight: 600; cursor: pointer;">ç¢ºèª</button>
            <button id="run-cancel-btn" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: #f5f5f5; color: #333; font-size: 1.05em; cursor: pointer;">å–æ¶ˆ</button>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', html);

    const closeMenu = () => {
        if (actionKey) window.processedActions.add(actionKey); 
        document.getElementById('run-action-sheet').remove();
    };

    document.getElementById('run-action-sheet').onclick = closeMenu;
    document.getElementById('run-apply-btn').onclick = (e) => { e.stopPropagation(); onApply(); closeMenu(); };
    document.getElementById('run-cancel-btn').onclick = (e) => { e.stopPropagation(); closeMenu(); };
};

/**
 * åŸ·è¡Œç‰¹åˆ¥è½‰æ›é‚è¼¯
 */
function applySuggestion() {
    const rno = document.getElementById('runNo').value;
    const rs = document.getElementById('routeSelect');
    const ds = document.getElementById('directionSelect');
    const ss = document.getElementById('stationSelect');
    const memo = document.getElementById('memo');

    const setSpecialRoute = (value, display) => {
        let opt = [...rs.options].find(o => o.value === value);
        if (!opt) {
            opt = document.createElement('option'); opt.value = value; rs.appendChild(opt);
        }
        opt.innerText = display; rs.value = value; window.customRteKey = value; 
    };

    if (rno === "903" || parseInt(rno) === 903) {
        setSpecialRoute("751L", "751L");
        ds.innerHTML = `<option>å±¯é–€ç¢¼é ­</option>`;
        memo.value = "åˆ°é”æ¾¤è±ç«™å¾Œæ”¹ç‚º507å‰å¾€å±¯é–€ç¢¼é ­";
        const extraIds = [425, 380, 370, 350, 360, 100, 90, 80];
        const list = stationDB.filter(s => s.r.includes("751P") || extraIds.includes(s.id)).sort((a,b)=>a.id-b.id);
        ss.innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
    } 
    else if (parseInt(rno) === 901 || parseInt(rno) === 902) {
        const type = parseInt(rno) === 901 ? "615" : "507P";
        setSpecialRoute(`751x${type}`, "751P");
        ds.innerHTML = `<option>å±¯é–€ç¢¼é ­</option>`;
        memo.value = specialTips[rno.padStart(3, '0')];
        const extraIds = [425, 380, 370, 350, 360, 100];
        const list = stationDB.filter(s => s.r.includes("751P") || extraIds.includes(s.id)).sort((a,b)=>a.id-b.id);
        ss.innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
    }
    else if (parseInt(rno) === 904) {
        const subOptions = [
            { 
                label: "720 å¾€å¤©æ¦® (ç¶“å…†åº·)", 
                action: () => {
                    setSpecialRoute("506Px720", "506P");
                    ds.innerHTML = `<option>å…†åº·</option><option>å¤©æ¦®</option>`;
                    memo.value = "åˆ°é”å…†åº·ç«™å¾Œæ”¹ç‚º720å‰å¾€å¤©æ¦®";
                    const list = stationDB.filter(s => s.r.includes("506P") || s.id === 100).sort((a,b)=>a.id-b.id);
                    ss.innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
                }
            },
            {
                label: "751 å¾€å‹æ„› (ç¶“å¤©æ¦®)", 
                action: () => {
                    setSpecialRoute("720x751", "720");
                    ds.innerHTML = `<option>å¤©æ¦®</option><option>å‹æ„›</option>`;
                    memo.value = "åˆ°é”å¤©æ¦®ç«™å¾Œæ”¹ç‚º751å‰å¾€å‹æ„›";
					const extraIds = [425, 380, 370, 350, 360, 100];
                    const list = stationDB.filter(s => s.r.includes("720") || s.r.includes("751P")).sort((a,b)=>a.id-b.id);
                    ss.innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
                }
            }
        ];
        showSubMenu("è«‹é¸æ“‡ 904 é‹è¡Œæ¨¡å¼ï¼š", subOptions);
    }
}

/**
 * 904 å°ˆç”¨å­é¸å–®
 */
window.showSubMenu = function(message, options) {
    const html = `
    <div id="run-sub-sheet" class="action-sheet-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10002; display: flex; align-items: flex-end;">
        <div class="action-sheet-content" style="width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px;">
            <div style="text-align: center; margin-bottom: 15px; color: #888;">${message}</div>
            ${options.map(opt => `<button class="sub-opt-btn" style="width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: none; background: #f0f7ff; color: #007aff; font-weight: 600;">${opt.label}</button>`).join('')}
            <button onclick="this.closest('.action-sheet-overlay').remove()" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: #f5f5f5;">å–æ¶ˆ</button>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    document.querySelectorAll('.sub-opt-btn').forEach((btn, idx) => {
        btn.onclick = () => { options[idx].action(); document.getElementById('run-sub-sheet').remove(); };
    });
};

function onRouteUpdate() {
    const r = document.getElementById('routeSelect').value;
    window.customRteKey = null; 
    document.getElementById('directionSelect').innerHTML = (routeCfg[r] || []).map(d => `<option>${d}</option>`).join('');
    
    const specials = ["ä¸è¼‰å®¢", "å¸æ©Ÿè¨“ç·´", "å›å» ", "å°ˆç”¨"];
    let list;
    if (specials.includes(r)) {
        list = [...stationDB].sort((a,b) => a.id - b.id);
    } else {
        list = stationDB.filter(s => s.r.includes(r)).sort((a,b)=>a.id-b.id);
    }
    
    document.getElementById('stationSelect').innerHTML = list.map(s => `<option value="${s.zh}">${s.id} ${s.zh}</option>`).join('');
    checkSpecialDestination();
}

/**
 * æœ€çµ‚æäº¤å ±å‘Šé‚è¼¯ (æ­¤è™•è™•ç†å¼·åˆ¶è£œé›¶)
 */
window.addReport = function() {
    const carIdVal = document.getElementById('carId').value.trim();
    let runNoVal = document.getElementById('runNo').value.trim();
    const routeVal = document.getElementById('routeSelect').value;
    const directionVal = document.getElementById('directionSelect').value;
    const stationVal = document.getElementById('stationSelect').value;
    const memoVal = document.getElementById('memo').value.trim();

    if (!carIdVal || !runNoVal) {
        window.showToast("è«‹å¡«å¯«è»Šç·¨åŠè»Šåº");
        return;
    }

    // --- ä¿®æ”¹é»ï¼šåƒ…åœ¨æäº¤æ•¸æ“šæ™‚å¼·åˆ¶æ ¼å¼åŒ–è»Šåºç‚ºä¸‰ä½æ•¸ ---
    if (!isNaN(runNoVal)) {
        runNoVal = runNoVal.padStart(3, '0');
    }

    const newTrace = {
        rno: runNoVal, // ç™¼é€åˆ°å¾Œå°çš„å°‡æ˜¯ "001" æˆ– "011"
        rteKey: window.customRteKey || routeVal,
        dRte: (window.customRteKey || routeVal) + " å¾€ " + directionVal,
        loc: stationVal,
        mem: memoVal,
        tStr: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })
    };

    // å‘¼å«åŸæœ¬çš„ç™¼å¸ƒå‡½æ•¸
    window.publishToFirebase(carIdVal, newTrace);

    // æäº¤å¾Œè‡ªå‹•æ¸…ç©ºå‚™è¨»
    document.getElementById('memo').value = ""; 
};

// --- 3. è™•ç†é¸å–®å‹•ä½œ ---
// å¿…é ˆæ›è¼‰åˆ° windowï¼ŒHTML onclick æ‰èƒ½åŸ·è¡Œ
window.handleETAAciton = function(type, ...args) {
    const sheet = document.getElementById('eta-action-sheet');
    if (sheet) sheet.remove();

    if (type === 'trace') {
        const [carId] = args;
        if (!carId) return alert("æš«ç„¡è©²è»Šæ¬¡å°æ‡‰çš„ç·¨çµ„è³‡æ–™");
        
        // åˆ‡æ›åˆ°ã€Œè¡Œè¹¤ã€åˆ†é 
        const historyBtn = Array.from(document.querySelectorAll('.tab-btn'))
            .find(b => b.innerText.includes('è¡Œè¹¤'));
        if (typeof window.switchTab === 'function' && historyBtn) {
            window.switchTab('livePage', historyBtn);
        }

        setTimeout(() => {
            const searchInput = document.getElementById('searchComp');
            if (searchInput) {
                searchInput.value = carId;
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }, 300);

    } else if (type === 'report') {
        // --- é—œéµä¿®æ­£ï¼šç¢ºä¿é€™è£¡çš„ args é †åºèˆ‡ showETAMenu å‚³å…¥çš„ä¸€è‡´ ---
        // å»ºè­°é †åºï¼š[location, route, dest, runNo, carId]
        const [location, route, dest, runNo, carId] = args;
        
        if (typeof window.reportETA === 'function') {
            // å‘¼å«æ™‚å°‡åƒæ•¸å‚³çµ¦ reportETA
            window.reportETA(route, dest, runNo, location, carId);
        } else {
            console.error("å°šæœªå®šç¾© window.reportETA å‡½å¼");
        }
    }
};

function initETAStations() {
    const select = document.getElementById('etaStationSelect');
    if(!select) return;
    select.innerHTML = "";
    stationDB.sort((a, b) => a.id - b.id).forEach(s => {
        const opt = document.createElement('option'); opt.value = s.id; opt.innerText = `${s.id} ${s.zh}`; select.appendChild(opt);
    });
}

window.syncETAList = function(source) {
    const input = document.getElementById('etaStationInput');
    const select = document.getElementById('etaStationSelect');
    
    // åˆ¤æ–·æ˜¯å¦éœ€è¦æ»‘å…¥å‹•ç•«ï¼šæ‰‹å‹•é¸æ“‡è»Šç«™ (select)ã€è¼¸å…¥ ID (input) æˆ–åˆ‡æ›åˆ†é  (tab)
    const shouldAnimate = (source === 'select' || source === 'input' || source === 'tab');
    
    if (source === 'input') {
        const val = parseInt(input.value);
        if (!isNaN(val)) select.value = val;
    } else {
        input.value = select.value;
    }
    
    // å‚³éå‹•ç•«æ¨™ç±¤çµ¦ updateETAList
    if (typeof updateETAList === 'function') {
        updateETAList(shouldAnimate);
    }
};

window.etaTimer = null;

/**
 * æ›´æ–° ETA åˆ—è¡¨
 * @param {boolean} isEntrance - æ˜¯å¦é¡¯ç¤ºæ»‘å…¥å‹•ç•«ï¼ˆæ‰‹å‹•æ“ä½œæ™‚ç‚º trueï¼‰
 */
async function updateETAList(isEntrance = false) {
    // 1. è¨˜éŒ„ç•¶å‰æ‰€æœ‰å±•é–‹ç‹€æ…‹çš„å®¹å™¨ IDï¼Œä»¥ä¾¿åˆ·æ–°å¾Œæ¢å¾©
    const expandedPlatforms = new Set();
    document.querySelectorAll('.eta-extra-container.expanded').forEach(el => {
        expandedPlatforms.add(el.id);
    });

    if (window.etaTimer) {
        clearTimeout(window.etaTimer);
        window.etaTimer = null;
    }

    const select = document.getElementById('etaStationSelect');
    const stationId = select.value;
    const listArea = document.getElementById('etaList');
    if (!stationId || !listArea) return;

    // --- å‹•ç•«ç‹€æ…‹é è¨­ ---
    if (isEntrance) {
        listArea.classList.add('entrance-anim');
    } else {
        // å¦‚æœä¸æ˜¯æ‰‹å‹•é€²å…¥ï¼Œç¢ºä¿ç§»é™¤è©²æ¨™ç±¤ï¼Œé¿å…è§¸ç™¼ Slide æ•ˆæœ
        listArea.classList.remove('entrance-anim');
    }
    listArea.classList.add('updating');
    
    try {
        const response = await fetch(`https://lrtapi.lightcatcube.com/api/schedule?station_id=${stationId}`);
        const data = await response.json();
        
        if (data && data.platform_list) {
            let html = "";
            const runToCompMap = {};
            const groups = window.reportGroups || {};
            const todayOpDate = window.getOperationalDate(); 

            // --- è»Šè¼›åŒ¹é…é‚è¼¯ ---
            let allTraces = [];
            Object.values(groups).forEach(group => {
                if (group.traces && group.traces.length > 0) {
                    group.traces.forEach(t => {
                        if (window.getOperationalDate(t.timestamp) === todayOpDate) {
                            allTraces.push({
                                rno: parseInt(t.rno).toString(),
                                carId: t.fullId || group.carId,
                                timestamp: t.timestamp
                            });
                        }
                    });
                }
            });

            allTraces.sort((a, b) => a.timestamp - b.timestamp);
            const carToLastRnoMap = {}; 
            allTraces.forEach(trace => {
                if (trace.rno && trace.rno !== "NaN" && trace.carId) {
                    if (carToLastRnoMap[trace.carId]) {
                        delete runToCompMap[carToLastRnoMap[trace.carId]];
                    }
                    runToCompMap[trace.rno] = trace.carId;
                    carToLastRnoMap[trace.carId] = trace.rno;
                }
            });

            // --- æ™‚é–“èˆ‡æ—¥æœŸåˆ¤å®š ---
            const now = new Date();
            const day = now.getDay(); 
            const hourMin = now.getHours() * 100 + now.getMinutes(); 
            const isWeekday = (day >= 1 && day <= 5);

            data.platform_list.forEach(platform => {
                html += `
                <div class="eta-platform-group" style="margin-bottom: 12px; border-radius: 12px; overflow: hidden; background: #fff; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <div class="eta-platform-label" style="background: #f8f9fa; padding: 8px 12px; font-size: 0.8em; color: #555; border-bottom: 1px solid #eee; font-weight: bold;">
                        ${platform.platform_id} è™Ÿæœˆå°
                    </div>`;

                if (platform.route_list && platform.route_list.length > 0) {
                    const containerId = `extra-container-${platform.platform_id}`;
                    const isInitiallyExpanded = expandedPlatforms.has(containerId);

                    platform.route_list.forEach((train, index) => {
                        let raw = train.trip_no ? String(train.trip_no) : (train.train_id !== "0" ? String(train.train_id) : "");
                        let runNoRaw = (raw && raw.length > 2) ? raw.substring(0, raw.length - 2) : (raw || "");
                        const isInvalid = !runNoRaw || runNoRaw === "undefined" || runNoRaw === "undefin" || runNoRaw === "null";
                        let displayRunNo = isInvalid ? "---" : runNoRaw.padStart(3, '0');
                        const cleanRunNo = parseInt(runNoRaw).toString();

                        let rawDest = (typeof train.dest_ch === 'string' && train.dest_ch.trim() !== '') ? train.dest_ch : 'ä¸è¼‰å®¢åˆ—è»Š';
                        let displayRoute = train.route_no;
                        let fontStyle = "";
                                
                        if (isWeekday) {
                            if (hourMin >= 630 && hourMin <= 830) {
                                if (rawDest === 'ä¸è¼‰å®¢åˆ—è»Š' || (displayRoute === '615' && rawDest === 'å±¯é–€ç¢¼é ­' && (cleanRunNo === '0' || cleanRunNo === '902'))) {
                                    displayRoute = '507P'; rawDest = 'å±¯é–€ç¢¼é ­';
                                } else if (displayRoute === '751' && rawDest === 'å‹æ„›' && (cleanRunNo === '0' || cleanRunNo === '903')) {
                                    displayRoute = '751L'; rawDest = 'å±¯é–€ç¢¼é ­';
                                }
                            } else if (hourMin >= 1530 && hourMin <= 2030) {
                                if (displayRoute === '751P' && rawDest === 'ä¸è¼‰å®¢åˆ—è»Š') {
                                    rawDest = 'æœªæœ‰ç›¸é—œç­æ¬¡è³‡è¨Š';
                                    fontStyle = 'color: #999; font-style: italic; font-weight: 400; font-size: 0.8em; ';
                                }
                            }
                        }

                        let timeDiff = train.time_ch || "---";
                        if (rawDest === 'æœªæœ‰ç›¸é—œç­æ¬¡è³‡è¨Š') timeDiff = timeDiff.replace(/[åˆ†é˜\-]/g, '').trim();

                        const hasLength = train.train_length !== null && train.train_length !== undefined && !isNaN(parseInt(train.train_length));
                        const lengthText = hasLength ? `${train.train_length}å¡` : "";
                        const safeDest = rawDest.replace(/'/g, "\\'");
                        const matchedCarId = runToCompMap[cleanRunNo] || "";
                        
                        let compContent = "";
                        if (matchedCarId) {
                            const reportedLength = matchedCarId.includes('-') ? 2 : 1;
                            const apiLength = parseInt(train.train_length);
                            const displayColor = (hasLength && reportedLength !== apiLength) ? "#e67e22" : "#2980b9";
                            compContent = `<span style="color:${displayColor}; margin-left:4px; font-weight: 500;">(${matchedCarId})</span>`;
                        }

                        const isSpecialStatus = train.time_en === 'Arriving' || train.time_en === 'Departing';
                        const routeColor = (typeof colorMap !== 'undefined' && colorMap[displayRoute]) ? colorMap[displayRoute] : '#333';
                        const stationName = select.options[select.selectedIndex].text;

                        if (index === 4) {
                            html += `<div id="${containerId}" class="eta-extra-container ${isInitiallyExpanded ? 'expanded' : ''}">`;
                        }

                        html += `
                        <div class="eta-row" 
                             onclick="showETAMenu('${stationName}', '${displayRoute}', '${safeDest}', '${displayRunNo}', '${matchedCarId}')"
                             style="position: relative; display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f9f9f9; cursor: pointer;">
                            <div style="position: absolute; left: 0; top: 8px; bottom: 8px; width: 4px; border-radius: 0 2px 2px 0; background: ${routeColor};"></div>
                            <div class="eta-info-left" style="display: flex; align-items: center; gap: 8px; padding-left: 6px;">
                                <span class="run-no-badge">${displayRunNo}</span>
                                <span class="route-badge" style="background: transparent; border: 1.5px solid ${routeColor}; color: #000; min-width: 32px; text-align: center; padding: 1px 4px; font-size: 0.85em; font-weight: bold; border-radius: 4px;">${displayRoute}</span>
                                <div style="display: flex; flex-direction: column; line-height: 1.2;">
                                    <div style="font-weight: bold; font-size: 1em; color: #2c3e50; ${fontStyle}">${safeDest}</div>
                                    <div style="font-size: 0.75em; color: #7f8c8d;">${lengthText}${compContent}</div>
                                </div>
                            </div>
                            <div class="${isSpecialStatus ? 'approaching' : ''}" style="font-weight: bold; font-size: 1.1em;">${timeDiff}</div>
                        </div>`;

                        if (index === platform.route_list.length - 1 && platform.route_list.length > 4) html += `</div>`;
                    });

                    if (platform.route_list.length > 4) {
                        const containerId = `extra-container-${platform.platform_id}`;
                        const isInitiallyExpanded = expandedPlatforms.has(containerId);
                        const btnText = isInitiallyExpanded ? 'æ”¶èµ·éƒ¨åˆ†ç­æ¬¡' : `æŸ¥çœ‹æ›´å¤š (é‚„æœ‰ ${platform.route_list.length - 4} ç­)`;
                        html += `<button class="eta-more-btn" onclick="event.stopPropagation(); window.toggleETAMore(this, '${containerId}')" data-expanded="${isInitiallyExpanded}">${btnText}</button>`;
                    }
                } else {
                    html += `<div style="text-align:center; padding:20px; color:#999; font-size:0.9em;">æ˜¯æ—¥åˆ—è»Šæœå‹™å·²ç¶“ä¸­æ­¢</div>`;
                }
                html += `</div>`; 
            });

            // --- æ¸²æŸ“åŸ·è¡Œ (ä¿®æ­£é›™é‡å‹•ç•«) ---
            // ç§»é™¤ listArea.innerHTML = ""; é¿å…ç¯€é»é–ƒçˆèˆ‡äºŒæ¬¡è§¸ç™¼å‹•ç•«
            requestAnimationFrame(() => {
                // ç›´æ¥æ›¿æ›å…§å®¹
                listArea.innerHTML = html || "<div style='text-align:center; padding:30px; color:grey;'>æ˜¯æ—¥åˆ—è»Šæœå‹™å·²ç¶“ä¸­æ­¢</div>";
                listArea.classList.remove('updating');
                
                // å‹•ç•«æ’­æ”¾å¾Œç§»é™¤æ¨™ç±¤ï¼Œä½¿ 15s å¾Œçš„è‡ªå‹•åˆ·æ–°ä¸æœƒå¸¶æœ‰æ»‘å…¥æ•ˆæœ
                if (isEntrance) {
                    setTimeout(() => {
                        listArea.classList.remove('entrance-anim');
                    }, 800);
                }
            });
        }
    } catch (error) {
        console.error("Fetch Error:", error);
        if (listArea) listArea.classList.remove('updating');
    }

    const etaPage = document.getElementById('etaPage');
    if (etaPage && etaPage.style.display !== 'none') {
        // è‡ªå‹•åˆ·æ–°æ™‚ isEntrance å¿…é ˆç‚º false
        window.etaTimer = setTimeout(() => updateETAList(false), 15000);
    }
}

// --- å…¨å±€é‡ç½®æŒ‰éˆ•é‚è¼¯ ---
const resetBtn = document.getElementById('btnResetFilters');
if (resetBtn) {
    resetBtn.addEventListener('click', () => {
        // 1. é‡ç½®æ—¥æœŸ
        const searchDate = document.getElementById('searchDate');
        if (searchDate && typeof window.getOperationalDate === 'function') {
            searchDate.value = window.getOperationalDate();
        }
        
        // 2. é‡ç½®è·¯ç¶«é¸å–®
        const searchRoute = document.getElementById('searchRoute');
        if (searchRoute) searchRoute.value = '';
        
        // 3. é‡ç½®ç·¨çµ„è¼¸å…¥èˆ‡æ¸…é™¤æŒ‰éˆ•
        const compInput = document.getElementById('searchComp');
        const clearBtn = document.getElementById('clearSearch');
        if (compInput) {
            compInput.value = '';
            compInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
        if (clearBtn) clearBtn.style.display = 'none';
        
        // 4. é‡ç½®æ’åº
        const sortOrder = document.getElementById('sortOrder');
        if (sortOrder) sortOrder.value = 'reportTime';
        
        // 5. åŸ·è¡Œé‡æ–°æ¸²æŸ“
        if (typeof window.renderAll === 'function') {
            window.renderAll();
        }
    });
}


// --- åŒæ­¥é‚è¼¯ ---
window.syncETAList = function(source) {
    const input = document.getElementById('etaStationInput');
    const select = document.getElementById('etaStationSelect');
    
    // åªè¦æ˜¯ä¾†è‡ª select (æ‰‹å‹•æ›ç«™) æˆ– tab (åˆ‡æ›åˆ†é )ï¼Œå°±æ‡‰è©²æœ‰æ»‘å…¥å‹•ç•«
    const shouldAnimate = (source === 'select' || source === 'input' || source === 'tab');
    
    if (source === 'input') {
        const val = parseInt(input.value);
        if (!isNaN(val)) select.value = val;
    } else {
        input.value = select.value;
    }
    
    updateETAList(shouldAnimate);
};

// --- å…¶é¤˜è¼”åŠ©é‚è¼¯ ---
window.toggleETAMore = function(btn, containerId) {
    const container = document.getElementById(containerId);
    const isExpanded = btn.getAttribute('data-expanded') === 'true';
    const remainingCount = container.querySelectorAll('.eta-row').length;

    if (!isExpanded) {
        container.classList.add('expanded');
        btn.innerText = "æ”¶èµ·éƒ¨åˆ†ç­æ¬¡";
        btn.setAttribute('data-expanded', 'true');
    } else {
        container.classList.remove('expanded');
        btn.innerText = `æŸ¥çœ‹æ›´å¤š (é‚„æœ‰ ${remainingCount} ç­)`;
        btn.setAttribute('data-expanded', 'false');
    }
};

window.showETAMenu = function(location, route, dest, runNo, carId) {
    const existing = document.getElementById('eta-action-sheet');
    if (existing) existing.remove();

    const html = `
    <div id="eta-action-sheet" class="action-sheet-overlay" onclick="this.remove()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10000; display: flex; align-items: flex-end;">
        <div class="action-sheet-content" onclick="event.stopPropagation()" style="width: 100%; background: #fff; border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box;">
            <div style="text-align: center; margin-bottom: 15px; color: #888; font-size: 0.9em;">
                ${carId} ${route} (${runNo}) å¾€ ${dest} ï¼ è«‹é¸æ“‡
            </div>
            <button onclick="handleETAAciton('trace', '${carId}')" style="width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #007aff; background: #f0f7ff; color: #007aff; font-size: 1.05em; font-weight: 600; cursor: pointer; text-align: center; display: ${carId ? 'block' : 'none'};">
                ğŸ” æŸ¥è©¢è»Šç·¨è¡Œè¹¤
            </button>
            <button onclick="handleETAAciton('report', '${location}', '${route}', '${dest}', '${runNo}', '${carId}')" style="width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #007aff; background: #f0f7ff; color: #007aff; font-size: 1.05em; font-weight: 600; cursor: pointer; text-align: center;">
                ğŸ“ æ›´æ–°è»Šåºè¡Œè¹¤
            </button>
            <button onclick="document.getElementById('eta-action-sheet').remove()" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: #f5f5f5; color: #333; font-size: 1.05em; cursor: pointer;">
                å–æ¶ˆ
            </button>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
};

window.handleETAAciton = function(type, ...args) {
    const sheet = document.getElementById('eta-action-sheet');
    if (sheet) sheet.remove();

    if (type === 'trace') {
        const carId = args[0];
        const liveBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.includes('è¡Œè¹¤'));
        window.switchTab('livePage', liveBtn);
        setTimeout(() => {
            const searchInput = document.getElementById('searchComp');
            if (searchInput) {
                searchInput.value = carId;
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }, 300);
    } else if (type === 'report') {
        const [location, route, dest, runNo, carId] = args;
        if (typeof window.reportETA === 'function') {
            window.reportETA(route, dest, runNo, location, carId);
        }
    }
};


window.searchCarWhereabouts = function(carId) {
    if (!carId) return;

    // A. é—œé–‰å´é‚Šèœå–® (è§£æ±ºé¸å–®ä¸æ¶ˆå¤±å•é¡Œ)
    const sideMenu = document.getElementById('sideMenu');
    const overlay = document.querySelector('.overlay');
    if (sideMenu) sideMenu.classList.remove('active');
    if (overlay) overlay.style.display = 'none';

    // B. å¼·åˆ¶åˆ‡æ›å›ã€Œä¸»é ã€(ID: mainPage)
    const mainTabBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.includes('ä¸»é '));
    if (window.switchTab) window.switchTab('mainPage', mainTabBtn);

    // C. å¡«å…¥æœå°‹è³‡æ–™ (å¢åŠ å»¶é²ï¼Œç¢ºä¿åˆ†é å·²é¡¯ç¤º)
    setTimeout(() => {
        const searchInput = document.getElementById('searchComp');
        const routeSelect = document.getElementById('searchRoute');
        const dateInput = document.getElementById('searchDate');

        if (searchInput) {
            // 1. é‡ç½®æ—¥æœŸ (âš ï¸ æœ€é‡è¦ï¼å¦‚æœæ—¥æœŸä¸å°ï¼ŒrenderAll æœƒéæ¿¾æ‰æ‰€æœ‰å…§å®¹)
            if (dateInput) {
                // å¦‚æœæ‚¨æœ‰ getOperationalDate() å‡½æ•¸å°±ç”¨å®ƒï¼Œæ²’æœ‰å°±ç”¨ä»Šæ—¥æ—¥æœŸ
                const today = typeof window.getOperationalDate === 'function' 
                              ? window.getOperationalDate() 
                              : new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }

            // 2. æ¸…é™¤è·¯ç·šéæ¿¾
            if (routeSelect) routeSelect.value = "";
            
            // 3. å¡«å…¥è»Šç·¨
            searchInput.value = carId;
            
            // 4. è§¸ç™¼è¼¸å…¥äº‹ä»¶ä»¥åŸ·è¡Œéæ¿¾
            searchInput.dispatchEvent(new Event('input', { bubbles: true }));
            
            // 5. å¼·åˆ¶åŸ·è¡Œæ¸²æŸ“èˆ‡æ²å‹•
            if (typeof window.renderAll === 'function') window.renderAll();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            console.log("æŸ¥è©¢æˆåŠŸï¼Œå·²é‡ç½®æ—¥æœŸä¸¦å¡«å…¥è»Šç·¨:", carId);
        }
    }, 200);
};

window.switchTab = function (pageId, btn) {
    // 1. åˆ‡æ›é¡¯ç¤ºç‹€æ…‹
    document.querySelectorAll('.page').forEach(p => {
        p.style.display = 'none';
        p.classList.remove('active');
    });

    const targetPage = document.getElementById(pageId);
    if (targetPage) {
        targetPage.style.display = 'block';
        setTimeout(() => targetPage.classList.add('active'), 10);
    }

    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');

    // --- æ–°å¢ï¼šåˆ‡æ›åˆ†é æ™‚è‡ªå‹•é—œé–‰æ­·å²è¨˜éŒ„ä»‹é¢ ---
    const overlay = document.getElementById('detailOverlay');
    if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => {
            if (!overlay.classList.contains('show')) {
                overlay.style.display = 'none';
            }
        }, 300);
    }

    // --- é‡é»ï¼šé‡å°æœ‰å¡ç‰‡çš„é é¢å¼·åˆ¶é‡æ–°æ¸²æŸ“ä»¥è§¸ç™¼å‹•ç•« ---
    if (pageId === 'mainPage' || pageId === 'flashPage') {
        if (typeof window.renderAll === 'function') {
            window.renderAll();
        }
    }

    // 2. é‡å°ã€Œå ±å‘Šã€åˆ†é  (mainPage) çš„è‡ªå‹•é‡ç½®é‚è¼¯
    if (pageId === 'mainPage' || pageId === 'flashPage') {
    if (typeof window.renderAll === 'function') {
        // ä½¿ç”¨ requestAnimationFrame æˆ–å°é‡å»¶é²ï¼Œç¢ºä¿åˆ†é åˆ‡æ›å®Œæˆå¾Œæ‰æ¸²æŸ“å¡ç‰‡
        requestAnimationFrame(() => {
            setTimeout(() => {
                window.renderAll();
            }, 50); // çµ¦äºˆ 50ms çš„å–˜æ¯æ™‚é–“ï¼Œæ¶ˆé™¤è¦–è¦ºä¸Šçš„å¡é “æ„Ÿ
        });
    }
}

    // åœ¨ä½ çš„ window.switchTab å‡½å¼å…§å°‹æ‰¾ä»¥ä¸‹å€å¡Šä¸¦ä¿®æ”¹
if (pageId === 'etaPage' && typeof window.updateETAList === 'function') {
    // é€™è£¡å‚³å…¥ true è§¸ç™¼ Slide-in å‹•ç•«
    setTimeout(() => {
        window.updateETAList(true); 
    }, 50);
}
    
    // åŸæœ‰çš„ mainPage æ¸²æŸ“é‚è¼¯ä¹Ÿå»ºè­°åŠ ä¸Š requestAnimationFrame
    if (pageId === 'mainPage' || pageId === 'flashPage') {
        if (typeof window.renderAll === 'function') {
            requestAnimationFrame(() => {
                setTimeout(() => window.renderAll(), 50);
            });
        }
    }
};




/**
 * ç”± ETA ä»‹é¢è§¸ç™¼çš„å¼·åˆ¶å ±å‘ŠåŠŸèƒ½
 */
window.reportETA = function(route, dest, runNo, location, carId) {
    // 1. é–‹å•Ÿä¿è­·é–ï¼Œé˜²æ­¢è¢« switchTab é‡ç½®
    window.isReportingETA = true;

    // 2. åˆ‡æ›åˆ°ã€Œå ±å‘Šã€åˆ†é 
    const reportBtn = Array.from(document.querySelectorAll('.tab-btn'))
        .find(b => b.innerText.includes('å ±å‘Š'));
    if (window.switchTab) window.switchTab('mainPage', reportBtn);

    // 3. å»¶é²å¡«å…¥è³‡æ–™ï¼Œç¢ºä¿åˆ†é å·²é¡¯ç¤º
    setTimeout(() => {
        const routeSelect = document.getElementById('routeSelect');
        const destSelect = document.getElementById('directionSelect');
        const carInput = document.getElementById('carId');
        const locSelect = document.getElementById('stationSelect');
        const runInput = document.getElementById('runNo');

        // A. è¨­å®šè·¯ç·šä¸¦è§¸ç™¼ change äº‹ä»¶
        // é€™æœƒå¼·åˆ¶åŸ·è¡Œ onRouteUpdate() ä»¥ç”Ÿæˆè©²è·¯ç·šå°æ‡‰çš„ç›®çš„åœ°å’Œè»Šç«™æ¸…å–®
        if (routeSelect) {
            routeSelect.value = route;
            routeSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }

        // B. å†æ¬¡å»¶é²ï¼Œç­‰å¾…ä¸‹æ‹‰é¸å–® (Option) ç”Ÿæˆå®Œç•¢
        setTimeout(() => {
            // è¨­å®šè»Šåº (è»Šæ¬¡)
            if (runInput) {
				const isInvalid = !runNo || runNo === "---" || runNo === "undefined" || runNo === "undefin";
				runInput.value = isInvalid ? "" : runNo;
			}

            // è¨­å®šç›®çš„åœ°
            if (destSelect) {
                destSelect.value = dest;
            }
            
            // è¨­å®šè»Šç·¨
            if (carInput) carInput.value = carId || "";

            // è¨­å®šä½ç½® (è»Šç«™)
            if (locSelect) {
                // å˜—è©¦ç›´æ¥åŒ¹é… (ä¾‹å¦‚ "å±¯é–€ç¢¼é ­")
                locSelect.value = location;
                
                // å¦‚æœå¤±æ•—ï¼ˆä¾‹å¦‚é¸å–®å…§æ˜¯ "001 å±¯é–€ç¢¼é ­"ï¼‰ï¼Œå‰‡é€²è¡Œæ¨¡ç³ŠåŒ¹é…
                if (!locSelect.value) {
                    for (let opt of locSelect.options) {
                        if (opt.text.includes(location)) {
                            locSelect.value = opt.value;
                            break;
                        }
                    }
                }
            }
        }, 150); 
    }, 200);
};



// å°‡æ­¤æ®µä»£ç¢¼è²¼åˆ° <script type="module"> çš„æœ€å¾Œé¢
window.fillReportFromETA = function(route, dest, location, runNo, carId) {
    // 1. åˆ‡æ›åˆ°å ±å‘Šåˆ†é 
    showPage('report');

    // 2. å–å¾—è¡¨å–®å…ƒç´ 
    const routeSelect = document.getElementById('routeSelect');
    const destSelect = document.getElementById('directionSelect');
    const carInput = document.getElementById('carId');
    const locSelect = document.getElementById('stationSelect');
    const runInput = document.getElementById('runNo');

    // 3. è¨­å®šè·¯ç·šä¸¦è§¸ç™¼æ›´æ–°ï¼ˆä»¥ç”Ÿæˆæ­£ç¢ºçš„è»Šç«™æ¸…å–®ï¼‰
    if (routeSelect) {
        routeSelect.value = route;
        routeSelect.dispatchEvent(new Event('change', { bubbles: true }));
    }

    // 4. å»¶é² 100 æ¯«ç§’ç­‰å¾…ä¸‹æ‹‰é¸å–®æ›´æ–°å¾Œå¡«å…¥å…¶é¤˜è³‡æ–™
    setTimeout(() => {
        if (runInput) {
			const isInvalid = !runNo || runNo === "---" || runNo === "undefined" || runNo === "undefin";
			runInput.value = isInvalid ? "" : runNo;
		}

        if (destSelect) destSelect.value = dest;
        if (carInput) carInput.value = carId || "";
        
        if (locSelect) {
            locSelect.value = location;
            // è‹¥ç„¡æ³•ç›´æ¥åŒ¹é…ï¼ˆä¾‹å¦‚åç¨±åŒ…å«ç·¨è™Ÿï¼‰ï¼Œå‰‡é€²è¡Œæ¨¡ç³ŠåŒ¹é…
            if (!locSelect.value) {
                for (let opt of locSelect.options) {
                    if (opt.text.includes(location)) {
                        locSelect.value = opt.value;
                        break;
                    }
                }
            }
        }
    }, 100);
};




let dragSrcElement = null;

window.handleDragStart = function(e) {
    dragSrcElement = e.currentTarget;
    e.dataTransfer.effectAllowed = 'move';
    // è¨­å®šæ‹–æ‹½æ™‚çš„è¦–è¦ºæ•ˆæœ
    e.currentTarget.style.opacity = '0.4';
};

window.handleDragOver = function(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
};

window.handleDrop = function(e) {
    e.stopPropagation();
    e.preventDefault();
    
    const target = e.currentTarget;
    if (dragSrcElement !== target) {
        // å–å¾—ç›®å‰å®¹å™¨å…§æ‰€æœ‰çš„ FID é †åº
        const container = document.getElementById('favListOnMain');
        const items = Array.from(container.querySelectorAll('.draggable-item'));
        const fids = items.map(item => item.getAttribute('data-fid'));

        const fromId = dragSrcElement.getAttribute('data-fid');
        const toId = target.getAttribute('data-fid');
        
        const fromIndex = fids.indexOf(fromId);
        const toIndex = fids.indexOf(toId);

        // é‡æ–°æ’åˆ—é™£åˆ—
        fids.splice(fromIndex, 1);
        fids.splice(toIndex, 0, fromId);

        // å„²å­˜æ–°é †åºä¸¦é‡æ–°æ¸²æŸ“
        window.customOrder = fids;
        if (typeof window.saveFavOrder === 'function') {
            window.saveFavOrder(fids);
        }
        window.renderAll();
    }
    dragSrcElement.style.opacity = '1';
    return false;
};

window.showToast = (msg) => {
    let toast = document.getElementById('customToast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'customToast';
        toast.className = 'toast-msg';
        document.body.appendChild(toast);
    }
    toast.innerText = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
};


</script>



</body></html>
